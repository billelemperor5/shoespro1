<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shoes Manager - Pro (مع Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap');
        
        :root {
            --primary-color: #6A1B9A; 
            --primary-color-dark: #4A148C; 
            --primary-color-light: #E1BEE7; 
            --accent-color: #FFAB00; 
            --accent-color-dark: #FF8F00;
            --text-color-primary: #212121; 
            --text-color-secondary: #757575; 
            --background-color: #F5F5F5; 
            --card-background-color: #FFFFFF; 
            --border-color: #E0E0E0; 
            --success-color: #4CAF50;
            --error-color: #F44336;
            
            --warning-color-rgb: 255, 193, 7; 
            --info-color-rgb: 33, 150, 243;   
            --accent-color-dark-rgb: 255, 143, 0; 
            --primary-color-dark-rgb: 74, 20, 140; 
            --primary-color-rgb: 123, 31, 162; 

            --pending-sale-bg-light: rgba(var(--warning-color-rgb), 0.2); 
            --pending-sale-border-light: rgba(var(--accent-color-dark-rgb), 0.3);
            --pending-sale-text-light: var(--text-color-primary); 

            --shipped-sale-bg-light: rgba(var(--info-color-rgb), 0.2); 
            --shipped-sale-border-light: rgba(var(--primary-color-dark-rgb), 0.3);
            --shipped-sale-text-light: var(--text-color-primary); 

            --delivery-icon-bg-color: #00ACC1; 
            --other-services-icon-bg-color: #455A64; 
            --suppliers-icon-bg-color: #795548; 
            --stock-alert-bg-light: rgba(255, 248, 225, 0.4);
            --stock-alert-border-light: rgba(255, 236, 179, 0.6);
            --stock-alert-accent-light: #FFCA28;
            --details-notes-bg-light: transparent; 
            --details-notes-text-light: var(--text-color-secondary); 
            --filter-button-active-bg: var(--primary-color);
            --filter-button-active-text: white;
            --filter-button-inactive-bg: var(--card-background-color);
            --filter-button-inactive-text: var(--primary-color);
            --filter-button-inactive-border: var(--primary-color-light);
        }

        body.dark-mode {
            --primary-color: #7B1FA2; 
            --primary-color-dark: #9C27B0; 
            --primary-color-light: #4A148C; 
            --accent-color: #FFC107; 
            --accent-color-dark: #FFAB00;
            --text-color-primary: #F5F5F5; 
            --text-color-secondary: #BDBDBD; 
            --background-color: #121212; 
            --card-background-color: #1E1E1E; 
            --border-color: #333333; 
            
            --warning-color-rgb: 66, 49, 3; 
            --info-color-rgb: 21, 101, 192; 

            --pending-sale-bg-light: rgba(var(--warning-color-rgb), 0.4); 
            --pending-sale-border-light: rgba(var(--accent-color-rgb, 255, 193, 7), 0.5);
            --pending-sale-text-light: var(--text-color-primary); 

            --shipped-sale-bg-light: rgba(var(--info-color-rgb), 0.4); 
            --shipped-sale-border-light: rgba(var(--primary-color-rgb, 123, 31, 162), 0.5);
            --shipped-sale-text-light: var(--text-color-primary); 

            --delivery-icon-bg-color: #00BCD4; 
            --other-services-icon-bg-color: #546E7A; 
            --suppliers-icon-bg-color: #8D6E63; 
            --stock-alert-bg-light: rgba(66, 49, 3, 0.3);
            --stock-alert-border-light: rgba(255, 209, 26, 0.4);
            --stock-alert-accent-light: var(--accent-color);
            --details-notes-bg-light: transparent; 
            --details-notes-text-light: var(--text-color-secondary);
            --filter-button-active-bg: var(--primary-color-dark);
            --filter-button-inactive-bg: var(--card-background-color);
            --filter-button-inactive-text: var(--primary-color-light);
            --filter-button-inactive-border: var(--primary-color);
        }

        body {
            font-family: 'Cairo', sans-serif;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
            background-color: var(--background-color);
            color: var(--text-color-primary);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex; 
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease; 
        }

        .splash-screen {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100vh; background: linear-gradient(145deg, var(--primary-color) 0%, var(--primary-color-dark) 100%);
            color: white; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            z-index: 10000; /* Increased z-index */
            transition: opacity 0.7s ease-out, visibility 0.7s ease-out;
            opacity: 1; visibility: visible;
        }
        .splash-screen.hidden { opacity: 0; visibility: hidden; }
        .splash-screen .logo-icon { font-size: 48px; margin-bottom: 16px; color: var(--accent-color); }
        .splash-screen h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
        .splash-screen p { font-size: 16px; opacity: 0.9; }
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            border-top: 3px solid var(--accent-color); width: 36px; height: 36px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .app-container { 
            display: none; /* Initially hidden until secret code is entered or splash finishes */
            height: 100vh; 
            width: 100vw;  
            flex-direction: column; 
            background-color: var(--background-color);
            transition: background-color 0.3s ease;
        }
        
        /* Secret Code Modal */
        #secret-code-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.75); 
            display: flex; 
            justify-content: center; align-items: center; 
            z-index: 9998; /* Below splash, above app */
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #secret-code-modal-overlay.visible { opacity: 1; visibility: visible; }
        #secret-code-modal-content {
            background-color: var(--card-background-color); padding: 28px; border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.25); width: 90%; max-width: 400px;
            text-align: center; 
            transform: translateY(20px) scale(0.98); 
            transition: transform 0.3s ease-out, opacity 0.3s ease-out, background-color 0.3s ease; 
            opacity: 0;
        }
        #secret-code-modal-overlay.visible #secret-code-modal-content { transform: translateY(0) scale(1); opacity: 1; }
        #secret-code-modal-title { 
            font-size: 22px; font-weight: 700; color: var(--primary-color-dark); 
            margin-bottom: 24px;
        }
        body.dark-mode #secret-code-modal-title { color: var(--text-color-primary); }
        #secret-code-input {
            text-align: center; letter-spacing: 3px; font-size: 1.2em;
        }
        #secret-code-error {
            color: var(--error-color); font-size: 0.875rem; margin-top: 10px; min-height: 1.2em;
        }


        /* Header */
        .app-header {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background-color 0.3s ease;
        }
        .app-header .header-content {
            display: flex;
            justify-content: space-between; 
            align-items: center;
        }
        .app-header .header-title-group {
            display: flex; 
            align-items: center; /* Changed from baseline for better alignment */
            gap: 8px; 
        }
        .app-header h1#main-app-title { font-size: 18px; font-weight: 600; margin: 0; }
        .app-header #user-status { font-size: 12px; display: flex; align-items: center; }


        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            padding: 16px; 
            overflow-y: auto;
            padding-bottom: 72px; 
            background-color: var(--background-color); 
            transition: background-color 0.3s ease;
        }
        .main-view-section h3.view-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-color-dark);
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-color-light);
            transition: color 0.3s ease, border-bottom-color 0.3s ease;
        }
        body.dark-mode .main-view-section h3.view-title {
            color: var(--text-color-primary); 
        }
        
        /* Home Screen Welcome Banner */
        .welcome-banner {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: background 0.3s ease;
        }
        .welcome-banner h2 { font-size: 20px; font-weight: 600; } 
        .welcome-banner p { font-size: 13px; opacity: 0.9; }
        .welcome-banner-actions button { 
            background-color: rgba(255,255,255,0.15);
            color: white;
            transition: background-color 0.2s;
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .welcome-banner-actions button:hover { background-color: rgba(255,255,255,0.25); }

        /* Action Cards - Redesigned */
        .action-card {
            background-color: var(--card-background-color);
            border-radius: 16px; 
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); 
            transition: transform 0.25s ease, box-shadow 0.25s ease, background-color 0.3s ease; 
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; 
            min-height: 130px; 
        }
        .action-card:hover { 
            transform: translateY(-6px) scale(1.02); 
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        .action-card i { 
            font-size: 26px; 
            margin-bottom: 12px; 
            padding: 10px; 
            border-radius: 50%; 
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white; 
        }
        .action-card .icon-bg-sell { background-color: #F44336; } 
        .action-card .icon-bg-add { background-color: #4CAF50; } 
        .action-card .icon-bg-stats { background-color: #2196F3; } 
        .action-card .icon-bg-inventory { background-color: #FF9800; } 
        .action-card .icon-bg-confirm { background-color: #009688; } 
        .action-card .icon-bg-other-services { background-color: var(--other-services-icon-bg-color); } 
        .action-card .icon-bg-delivery { background-color: var(--delivery-icon-bg-color); } 
        .action-card .icon-bg-suppliers { background-color: var(--suppliers-icon-bg-color); }
        .action-card .icon-bg-ai { background-color: #3F51B5; } 
        .action-card .icon-bg-returns { background-color: #795548; } 
        .action-card .icon-bg-auth { background-color: #9C27B0; }

        .action-card p { 
            font-size: 13px; 
            font-weight: 600; 
            color: var(--text-color-primary);
            margin-top: 4px;
            transition: color 0.3s ease;
        }
        
        /* Modal Styles - Redesigned */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); 
            display: flex; 
            justify-content: center; align-items: center; z-index: 9999; /* Ensure modals are above secret code modal if it's somehow still visible */
            opacity: 0; visibility: hidden; transition: opacity 0.25s ease, visibility 0.25s ease; 
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--card-background-color); padding: 24px; border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2); width: 92%; 
            text-align: right; 
            transform: translateY(20px) scale(0.98); transition: transform 0.25s ease-out, opacity 0.25s ease-out, background-color 0.3s ease; 
            max-height: 90vh; 
            overflow-y: auto; 
            opacity: 0;
        }
        #add-shoe-modal .modal-content, #sell-shoe-modal .modal-content, 
        #global-search-modal .modal-content, #edit-delivery-price-modal .modal-content, 
        #export-data-modal .modal-content, #add-supplier-modal .modal-content, 
        #supplier-details-modal .modal-content, #auth-modal .modal-content { max-width: 500px; }
        #message-modal .modal-content { max-width: 380px; text-align:center; }
        #shoe-details-modal .modal-content { max-width: 560px; } 

        .modal-overlay.visible .modal-content { transform: translateY(0) scale(1); opacity: 1; }
        .modal-title { 
            font-size: 20px; font-weight: 700; color: var(--primary-color-dark); 
            margin-bottom: 20px; text-align: center;
            transition: color 0.3s ease;
        }
        body.dark-mode .modal-title {
            color: var(--text-color-primary);
        }
        
        /* Form Input Styling - Redesigned */
        .form-label { 
            display: block; font-size: 13px; font-weight: 600; 
            color: var(--text-color-secondary); margin-bottom: 6px; 
            transition: color 0.3s ease;
        }
        .form-input, .form-textarea, .form-file-input, .form-select {
            width: 100%; padding: 12px 14px; margin-bottom: 16px;
            border: 1px solid var(--border-color); border-radius: 10px; 
            font-size: 14px; color: var(--text-color-primary);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            background-color: var(--background-color); 
        }
        body.dark-mode .form-input, body.dark-mode .form-textarea, body.dark-mode .form-file-input, body.dark-mode .form-select {
            background-color: #2C2C2C; 
        }
        .form-input:focus, .form-textarea:focus, .form-file-input:focus, .form-select:focus { 
            border-color: var(--primary-color); 
            outline: none; 
            box-shadow: 0 0 0 3px var(--primary-color-light);
        }
        .form-textarea { min-height: 90px; resize: vertical; }
        .image-preview {
            width: 120px; height: 120px; border: 2px dashed var(--border-color);
            border-radius: 10px; object-fit: cover; margin-top: 8px;
            display: none; 
            transition: border-color 0.3s ease;
        }
        .details-image, .supplier-details-image { 
            max-width: 100%; height: auto; max-height: 280px; 
            object-fit: contain; border-radius: 12px; margin: 0 auto 20px auto; display: block;
            border: 1px solid var(--border-color);
            transition: border-color 0.3s ease;
        }
         .supplier-details-no-image {
            width: 150px; height: 150px; border-radius: 50%;
            background-color: var(--primary-color-light); color: var(--primary-color-dark);
            display: flex; align-items: center; justify-content: center;
            font-size: 50px; font-weight: bold; margin: 0 auto 20px auto;
            border: 2px solid var(--border-color);
        }
        body.dark-mode .supplier-details-no-image {
            background-color: var(--primary-color-dark);
            color: var(--primary-color-light);
        }
        #details-supplier-modal-notes { 
            background-color: var(--details-notes-bg-light);
            color: var(--details-notes-text-light);
            border: none; 
            padding: 0; 
            min-height: auto; 
            white-space: pre-wrap; 
            word-wrap: break-word;
        }
        body.dark-mode #details-supplier-modal-notes {
            color: var(--details-notes-text-light); 
        }

        /* Size-Quantity Pair Styling */
        .size-quantity-pair {
            display: flex; gap: 10px; align-items: center; margin-bottom: 10px;
        }
        .remove-size-btn {
            background-color: var(--error-color); color: white; border: none;
            border-radius: 50%; width: 28px; height: 28px;
            font-size: 15px; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            transition: background-color 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .remove-size-btn:hover { background-color: #D32F2F; }

        /* Button Styling - Redesigned */
        .app-button {
            padding: 10px 20px; border-radius: 10px;
            border: none; cursor: pointer; font-size: 15px; font-weight: 600;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s, color 0.2s, border-color 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: inline-flex; align-items: center; justify-content: center;
        }
        .app-button:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.15); transform: translateY(-1px); }
        .app-button:active { transform: translateY(0px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .app-button i { margin-left: 8px; } 

        .app-button-primary {
            background-color: var(--primary-color); color: white;
        }
        .app-button-primary:hover { background-color: var(--primary-color-dark); }
        
        .app-button-secondary {
            background-color: var(--card-background-color); color: var(--primary-color);
            border: 1px solid var(--primary-color-light);
        }
        .app-button-secondary:hover { background-color: var(--primary-color-light); border-color: var(--primary-color); color: var(--primary-color-dark); }
        body.dark-mode .app-button-secondary:hover { background-color: #333; border-color: var(--primary-color); }

        .app-button-danger {
            background-color: var(--error-color); color: white;
        }
        .app-button-danger:hover { background-color: #D32F2F; }

        .app-button-accent { 
            background-color: var(--accent-color); color: var(--text-color-primary);
        }
        body.dark-mode .app-button-accent {
             color: #121212; 
        }
        .app-button-accent:hover { background-color: var(--accent-color-dark); }
        .app-button-accent.loading { background-color: #BDBDBD; cursor: not-allowed; color: #757575; }
        .gemini-loader {
            width: 18px; height: 18px; border: 2px solid currentColor; 
            border-top-color: transparent; border-radius: 50%;
            animation: spin 0.6s linear infinite; margin-left: 8px;
        }
        
        /* Bottom Navigation Bar - Redesigned */
        .bottom-nav {
            background-color: var(--card-background-color); 
            border-top: 1px solid var(--border-color); 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.08); height: 60px; 
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
            display: grid; grid-template-columns: repeat(4, 1fr); align-items: center;
            transition: background-color 0.3s ease, border-top-color 0.3s ease;
        }
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-color-secondary);
            transition: color 0.2s ease-in-out, transform 0.15s ease-in-out; 
            height: 100%; 
            cursor: pointer;
        }
        .nav-item.active { color: var(--primary-color); }
        .nav-item.active i { transform: scale(1.1); font-size: 20px; } 
        .nav-item.active span { font-weight: 700; font-size: 11px; } 
        .nav-item i { font-size: 19px; margin-bottom: 3px; transition: transform 0.2s ease-in-out, font-size 0.2s; }
        .nav-item span { font-size: 10px; font-weight: 500; } 
        .nav-item:hover:not(.active) { color: var(--primary-color-dark); }
        
        /* Shoe Card (Inventory) - Redesigned */
        .shoe-card { 
            background-color: var(--card-background-color);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.07);
            padding: 16px;
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.2s ease, transform 0.2s ease, background-color 0.3s ease;
        }
        .shoe-card:hover {
            box-shadow: 0 7px 20px rgba(0,0,0,0.1);
            transform: translateY(-3px);
        }
        .shoe-card-image-container {
            width: 100%;
            height: 160px; 
            background-color: var(--background-color); 
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; 
            transition: background-color 0.3s ease;
        }
        .shoe-card-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
        }
        .shoe-card-image-container .no-image-text {
            font-size: 13px;
            color: var(--text-color-secondary);
            transition: color 0.3s ease;
        }
        .shoe-card h4 {
            font-size: 16px; font-weight: 600; color: var(--text-color-primary);
            margin-bottom: 4px; line-height: 1.3;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; 
            transition: color 0.3s ease;
        }
        .shoe-card .date-added { font-size: 11px; color: var(--text-color-secondary); margin-bottom: 8px; transition: color 0.3s ease;}
        .shoe-card .sizes-info { font-size: 12px; color: var(--text-color-secondary); margin-bottom: 12px; transition: color 0.3s ease;}
        .shoe-card-actions {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            margin-top: auto; 
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            transition: border-top-color 0.3s ease;
        }
         .shoe-card-actions button {
            padding: 6px 10px; 
            font-size: 13px;
            border-radius: 8px;
            font-weight: 500;
        }
        .shoe-card-actions .edit-btn { color: var(--primary-color); }
        .shoe-card-actions .delete-btn { color: var(--error-color); }

        /* Section Titles (used in various views) - Redesigned */
        .section-title {
            font-size: 17px; font-weight: 700; color: var(--primary-color-dark); 
            margin-top: 16px; margin-bottom: 12px; padding-bottom: 6px;
            border-bottom: 1px solid var(--border-color);
            transition: color 0.3s ease, border-bottom-color 0.3s ease;
        }
        body.dark-mode .section-title {
            color: var(--text-color-primary);
        }
        
        /* Toast Notification - Redesigned */
        .toast-notification {
            position: fixed;
            bottom: 75px; 
            left: 50%;
            transform: translateX(-50%) translateY(100px); 
            padding: 14px 22px;
            border-radius: 25px; 
            color: white;
            font-size: 14px; font-weight: 500;
            z-index: 10001; 
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease, background-color 0.3s ease;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .toast-notification.success { background-color: var(--success-color); }
        .toast-notification.error { background-color: var(--error-color); }
        .toast-notification.visible { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
        .toast-notification i { margin-left: 10px; font-size: 16px; } 

        /* Stat Item (Stats View) - Redesigned */
        .stat-item {
            background-color: var(--card-background-color);
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.07);
            text-align: center;
            transition: background-color 0.3s ease;
        }
        .stat-item-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--primary-color); 
            display: block;
            margin-bottom: 6px;
            transition: color 0.3s ease;
        }
        .stat-item-value i { font-size: 20px; opacity: 0.7; margin-right: 6px;}
        .stat-item-label {
            font-size: 13px;
            color: var(--text-color-secondary);
            transition: color 0.3s ease;
        }

        /* Monthly Sales Card, Pending Sale Card - Redesigned */
        .data-card { 
            background-color: var(--card-background-color);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 16px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.07);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .pending-sale-card {
            background-color: var(--pending-sale-bg-light) !important; 
            border: 1px solid var(--pending-sale-border-light) !important;
        }
        body.dark-mode .pending-sale-card {
            background-color: var(--pending-sale-bg-light) !important; 
            border-color: var(--pending-sale-border-light) !important;
        }
        .pending-sale-card.shipped {
            background-color: var(--shipped-sale-bg-light) !important; 
            border-color: var(--shipped-sale-border-light) !important;
        }
        body.dark-mode .pending-sale-card.shipped {
            background-color: var(--shipped-sale-bg-light) !important; 
            border-color: var(--shipped-sale-border-light) !important;
        }
        
        .pending-sale-card h5, 
        .pending-sale-card p:not(.notes-sub-card p), 
        .pending-sale-card strong {
            color: var(--pending-sale-text-light) !important;
        }
        body.dark-mode .pending-sale-card h5, 
        body.dark-mode .pending-sale-card p:not(.notes-sub-card p), 
        body.dark-mode .pending-sale-card strong {
             color: var(--pending-sale-text-light) !important; 
        }

        .pending-sale-card.shipped h5, 
        .pending-sale-card.shipped p:not(.notes-sub-card p), 
        .pending-sale-card.shipped strong {
            color: var(--shipped-sale-text-light) !important; 
        }
        body.dark-mode .pending-sale-card.shipped h5, 
        body.dark-mode .pending-sale-card.shipped p:not(.notes-sub-card p), 
        body.dark-mode .pending-sale-card.shipped strong {
            color: var(--shipped-sale-text-light) !important; 
        }

        .pending-sale-card .notes-sub-card { 
            background-color: rgba(255,255,255,0.2); 
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 0.75rem; 
            margin-top: 4px;
            color: var(--text-color-secondary); 
        }
        body.dark-mode .pending-sale-card .notes-sub-card {
            background-color: rgba(0,0,0,0.15); 
            color: var(--text-color-secondary);
        }
        .pending-sale-card.shipped .notes-sub-card p,
        .pending-sale-card.shipped .notes-sub-card strong {
            color: var(--shipped-sale-text-light) !important; 
        }
        body.dark-mode .pending-sale-card.shipped .notes-sub-card p,
        body.dark-mode .pending-sale-card.shipped .notes-sub-card strong {
             color: var(--shipped-sale-text-light) !important; 
        }

        .data-card h5 {
            font-size: 17px;
            font-weight: 700; 
            color: var(--primary-color-dark); 
            margin-bottom: 10px;
            transition: color 0.3s ease;
        }
        body.dark-mode .data-card h5 { color: var(--text-color-primary); }
        .data-card p {
            font-size: 14px;
            color: var(--text-color-primary);
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }
        .data-card ul {
            list-style: none; 
            padding-right: 0; 
            font-size: 13px;
            color: var(--text-color-secondary);
            transition: color 0.3s ease;
        }
         .data-card ul li { padding: 3px 0; border-bottom: 1px dashed var(--border-color); transition: border-bottom-color 0.3s ease;}
         .data-card ul li:last-child { border-bottom: none; }

        /* AI Sales Advisor Response Area - Redesigned */
        #ai-sales-advisor-response-area {
            background-color: var(--primary-color-light); 
            border: 1px solid var(--border-color); 
            border-radius: 12px;
            padding: 18px;
            margin-top: 16px;
            min-height: 150px; 
            white-space: pre-wrap; 
            font-size: 14px;
            color: var(--text-color-primary);
            line-height: 1.75; 
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        body.dark-mode #ai-sales-advisor-response-area {
            background-color: #2a2a2a; 
            color: var(--text-color-primary); 
        }

        /* Return Entry Item - Redesigned */
        .return-entry-item {
            background-color: var(--card-background-color); 
            border: 1px solid var(--border-color);
            padding: 14px; 
            border-radius: 10px; 
            margin-bottom: 12px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .return-entry-item .customer-name { font-weight: 600; color: var(--text-color-primary); transition: color 0.3s ease;}
        .return-entry-item .customer-name.highlight-returned { color: var(--error-color) !important; }
        .return-entry-item .customer-name.not-found { color: var(--success-color) !important; }
        .return-entry-item p { font-size: 13px; color: var(--text-color-secondary); margin-bottom: 4px; transition: color 0.3s ease;}
        .return-entry-actions button {
            font-size: 13px; padding: 5px 9px; border-radius: 6px;
        }

        /* Search Result Item - Redesigned */
        .search-result-item {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.15s, border-bottom-color 0.3s ease;
        }
        .search-result-item:hover { background-color: var(--primary-color-light); }
        body.dark-mode .search-result-item:hover { background-color: #30243a; } 
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item strong { color: var(--primary-color); transition: color 0.3s ease;}
        .search-result-item .highlight-returned { color: var(--error-color) !important; font-weight: bold; }
        .search-result-item .not-found { color: var(--success-color) !important; font-weight: bold; }

        /* Stock Alert Item Card - Redesigned */
        .alert-item-card { 
            background-color: var(--stock-alert-bg-light); 
            border: 1px solid var(--stock-alert-border-light); 
            border-left: 5px solid var(--stock-alert-accent-light);  
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 12px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .alert-item-card img {
            width: 50px; height: 50px;
            object-fit: cover; border-radius: 8px; margin-left: 14px; 
        }
        .alert-item-card-content h5 { font-size: 15px; font-weight: 600; color: var(--text-color-primary); margin-bottom: 4px; transition: color 0.3s ease;}
        body.dark-mode .alert-item-card-content h5 { color: var(--text-color-primary); } 
        .alert-item-card-content p { font-size: 13px; color: var(--text-color-secondary); margin-bottom: 2px; transition: color 0.3s ease;}
        body.dark-mode .alert-item-card-content p { color: var(--text-color-secondary); } 
        .alert-item-card-content .quantity-low { color: var(--error-color); font-weight: bold; }
        body.dark-mode .alert-item-card-content .quantity-low { color: #FF8A80; } 

        /* Back Button - Redesigned */
        .back-button-container { 
            display: flex; justify-content: center; 
            margin-top: 28px; margin-bottom: 12px; 
        }

        /* Pending Sale Actions (Confirm/Cancel) */
        .pending-sale-actions button {
            padding: 7px 12px; font-size: 13px; border-radius: 8px;
        }
        .pending-sale-actions .app-button-shipping { 
            background-color: var(--accent-color);
            color: #1E1E1E; 
        }
        body.dark-mode .pending-sale-actions .app-button-shipping {
            background-color: var(--accent-color-dark);
            color: var(--text-color-primary);
        }
        .pending-sale-actions .app-button-shipping.shipped-confirmed {
            background-color: var(--primary-color-dark) !important; 
            color: white !important;
            cursor: not-allowed;
        }
        body.dark-mode .pending-sale-actions .app-button-shipping.shipped-confirmed {
            background-color: var(--primary-color) !important; 
        }

        /* Social Links (About Page) */
        .social-link {
            display: inline-flex; align-items: center;
            color: var(--primary-color); text-decoration: none;
            font-weight: 500; margin: 0 12px;
            transition: color 0.2s;
        }
        .social-link:hover { color: var(--primary-color-dark); }
        .social-link i { font-size: 22px; margin-right: 8px; }

        /* Settings Buttons - Redesigned */
        .settings-button {
            display: flex; 
            align-items: center;
            justify-content: space-between; 
            width: 100%;
            text-align: right; 
            padding: 14px 18px;
            margin-bottom: 10px;
            background-color: var(--card-background-color);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500; 
            color: var(--text-color-primary);
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s, color 0.3s ease, border-color 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.06);
        }
        .settings-button:hover {
            background-color: var(--primary-color-light);
            box-shadow: 0 3px 8px rgba(0,0,0,0.09);
        }
        body.dark-mode .settings-button:hover { background-color: #333; }

        .settings-button i {
            margin-right: 0; 
            margin-left: 12px; 
            color: var(--primary-color);
            font-size: 18px;
            transition: color 0.3s ease;
        }
         .settings-button.danger {
            color: var(--error-color);
            border-color: var(--error-color); 
        }
         body.dark-mode .settings-button.danger { border-color: #FF8A80; }
        .settings-button.danger i { color: var(--error-color); }
         .settings-button.danger:hover { background-color: var(--error-color); color:white; border-color: var(--error-color);}
         .settings-button.danger:hover i { color:white;}
         body.dark-mode .settings-button.danger:hover { background-color: #D32F2F; }
        
        /* AI Chat Interface - Redesigned */
        #ai-chat-area { 
            height: calc(100vh - 380px); 
            overflow-y: auto;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--background-color); 
            margin-bottom: 12px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        body.dark-mode #ai-chat-area { background-color: #2C2C2C; }

        .chat-message {
            padding: 10px 16px;
            border-radius: 20px; 
            margin-bottom: 10px;
            max-width: 80%; 
            word-wrap: break-word;
            line-height: 1.6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .chat-message.user {
            background-color: var(--primary-color); 
            color: white;
            margin-right: auto; 
            border-bottom-right-radius: 6px; 
        }
        .chat-message.bot {
            background-color: var(--card-background-color); 
            color: var(--text-color-primary);
            margin-left: auto; 
            border-bottom-left-radius: 6px; 
            border: 1px solid var(--border-color);
        }
        .chat-message .sender {
            font-weight: 600; 
            font-size: 0.85em;
            margin-bottom: 3px;
            display: block;
            color: var(--primary-color-dark);
            transition: color 0.3s ease;
        }
        body.dark-mode .chat-message.bot .sender { color: var(--text-color-primary); }
        .chat-message.user .sender { color: rgba(255,255,255,0.8); }

        #ai-chat-input { margin-bottom: 0; } 
        #send-ai-chat-message-button i { margin-left: 0; margin-right: 8px; } 
        
        /* AI Option Buttons - Redesigned */
        .ai-option-button {
            background-color: var(--primary-color-light);
            color: var(--primary-color-dark);
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
            border: 1px solid var(--primary-color);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        body.dark-mode .ai-option-button {
             background-color: var(--card-background-color);
             color: var(--text-color-primary);
             border-color: var(--primary-color);
        }
        .ai-option-button:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color-dark);
        }
        body.dark-mode .ai-option-button:hover {
            background-color: var(--primary-color-dark);
            color: white;
        }
        .ai-option-button i { margin-left: 10px; }

        /* Export Data Modal Textarea */
        #export-data-text {
            width: 100%;
            min-height: 200px; 
            font-family: monospace; 
            font-size: 12px;
            line-height: 1.5;
            background-color: var(--background-color);
            color: var(--text-color-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 16px;
            resize: vertical;
        }
        body.dark-mode #export-data-text {
             background-color: #2c2c2c;
        }

        /* Supplier List Item */
        .supplier-item {
            background-color: var(--card-background-color);
            border: 1px solid var(--border-color);
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
        }
         .supplier-item-info {
            display: flex;
            align-items: center;
            gap: 12px; 
            flex-grow: 1; 
        }
        .supplier-item-image {
            width: 50px;
            height: 50px;
            border-radius: 50%; 
            object-fit: cover;
            border: 2px solid var(--border-color);
        }
         .supplier-item-no-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color-light);
            color: var(--primary-color-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        body.dark-mode .supplier-item-no-image {
            background-color: var(--primary-color-dark);
            color: var(--primary-color-light);
        }

        .supplier-item h5 {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 2px; 
        }
        body.dark-mode .supplier-item h5 {
            color: var(--primary-color-light);
        }
        .supplier-item p.supplier-notes-preview { 
            font-size: 13px;
            color: var(--text-color-secondary);
            margin-bottom: 0; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px; 
        }
        .supplier-item-actions button {
             padding: 6px 8px; 
             font-size: 12px;
        }
        #supplier-details-modal .supplier-details-image {
            width: 150px; 
            height: 150px;
            border-radius: 50%;
        }
        #supplier-details-modal .supplier-details-no-image {
            width: 150px;
            height: 150px;
        }
         #details-supplier-modal-notes {
            background-color: var(--details-notes-bg-light);
            color: var(--details-notes-text-light);
            border: none; 
            padding: 0; 
            min-height: auto; 
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        body.dark-mode #details-supplier-modal-notes {
            background-color: var(--details-notes-bg-light);
            color: var(--details-notes-text-light);
        }

        /* Shoe Filter Buttons */
        .filter-button {
            background-color: var(--filter-button-inactive-bg);
            color: var(--filter-button-inactive-text);
            border: 1px solid var(--filter-button-inactive-border);
            padding: 8px 16px;
            font-size: 14px;
        }
        .filter-button.active {
            background-color: var(--filter-button-active-bg);
            color: var(--filter-button-active-text);
            border-color: var(--filter-button-active-bg);
        }
        body.dark-mode .filter-button.active {
            border-color: var(--filter-button-active-bg);
        }
        body.dark-mode .filter-button:not(.active):hover {
            background-color: #333;
        }
         .filter-button:not(.active):hover {
            background-color: var(--primary-color-light);
        }

        /* Auth Form Specific Styles */
        .auth-form-toggle {
            font-size: 0.875rem; /* text-sm */
            color: var(--primary-color);
            cursor: pointer;
            margin-top: 1rem; /* mt-4 */
            text-align: center;
            transition: color 0.2s;
        }
        .auth-form-toggle:hover {
            color: var(--primary-color-dark);
        }
        #auth-modal .modal-content {
            max-width: 400px; 
        }
        #auth-error-message {
            color: var(--error-color);
            font-size: 0.875rem;
            text-align: center;
            margin-bottom: 1rem;
            display: none; 
        }
        #user-info-display {
            text-align: center;
            padding: 1rem;
            background-color: var(--primary-color-light);
            border-radius: 0.5rem; 
            margin-bottom: 1rem;
            color: var(--primary-color-dark);
        }
        body.dark-mode #user-info-display {
            background-color: var(--primary-color-dark);
            color: var(--primary-color-light);
        }

        /* (إضافة جديدة) أنماط خاصة بالطباعة */
@media print {
    body * {
        visibility: hidden; /* إخفاء كل شيء في الصفحة */
    }
    #detailed-monthly-report-section, #detailed-monthly-report-section * {
        visibility: visible; /* إظهار قسم التقرير وكل ما بداخله فقط */
    }
    #detailed-monthly-report-section {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 20px;
    }
    .app-button {
        display: none; /* إخفاء زر الطباعة نفسه عند الطباعة */
    }
    body.dark-mode { /* فرض الوضع الفاتح عند الطباعة */
        --text-color-primary: #000000;
        --card-background-color: #FFFFFF;
        --border-color: #dddddd;
        background-color: #FFFFFF;
    }
    table, th, td {
        color: #000000 !important;
    }
}
/* (إضافة جديدة) أنماط خاصة بالطباعة */
@media print {
    body * {
        visibility: hidden; /* إخفاء كل شيء في الصفحة */
    }
    #detailed-monthly-report-section, #detailed-monthly-report-section * {
        visibility: visible; /* إظهار قسم التقرير وكل ما بداخله فقط */
    }
    #detailed-monthly-report-section {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 20px;
    }
    .app-button {
        display: none; /* إخفاء زر الطباعة نفسه عند الطباعة */
    }
    body.dark-mode { /* فرض الوضع الفاتح عند الطباعة */
        --text-color-primary: #000000;
        --card-background-color: #FFFFFF;
        --border-color: #dddddd;
        background-color: #FFFFFF;
    }
    table, th, td {
        color: #000000 !important;
    }

    /* ▼▼▼ أضف هذا الكود الجديد هنا ▼▼▼ */
    #detailed-monthly-sales-container {
        display: block !important;
    }
    /* ▲▲▲ انتهت الإضافة ▲▲▲ */
}
    </style>
</head>
<body> 
    <div id="splash-screen" class="splash-screen">
        <i class="fas fa-shoe-prints logo-icon"></i> 
        <h1>Shoes Manager Pro</h1>
        <p>تنظيم احترافي لمخزونك</p>
        <div class="loader mt-10"></div> 
    </div>

    <div id="secret-code-modal-overlay">
        <div id="secret-code-modal-content">
            <h3 id="secret-code-modal-title">إدخال الرمز السري</h3>
            <form id="secret-code-form">
                <input type="password" id="secret-code-input" class="form-input mb-4" placeholder="ادخل الرمز هنا" required>
                <button type="submit" class="app-button app-button-primary w-full">دخول</button>
                <p id="secret-code-error" class="mt-3"></p>
            </form>
        </div>
    </div>

    <div id="main-app" class="app-container">
        <header class="app-header">
            <div class="container mx-auto header-content">
                <div class="header-title-group">
                    <h1 id="main-app-title">Shoes Manager Pro</h1>
                </div>
                <div id="user-status">
                    <button id="auth-action-button" class="app-button app-button-secondary text-xs px-3 py-1.5">تسجيل الدخول</button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="container mx-auto">
                <div id="home-view-content" class="main-view-section">
                    <div class="welcome-banner">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-xl font-semibold">مرحباً بك مجدداً!</h2>
                                <p id="current-date" class="text-xs opacity-85 mt-1">تاريخ اليوم: </p>
                            </div>
                            <div class="welcome-banner-actions flex items-center gap-3">
                                <button id="theme-toggle-button" aria-label="Toggle theme">
                                    <i class="fas fa-moon"></i> 
                                </button>
                                <button id="open-global-search-button" aria-label="Global search">
                                    <i class="fas fa-search fa-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-5"> 
                        <div class="action-card" onclick="openSellShoeModal()">
                            <i class="fas fa-cash-register icon-bg-sell"></i><p>تسجيل بيع جديد</p>
                        </div>
                        <div class="action-card" onclick="openAddShoeModal()">
                            <i class="fas fa-plus-circle icon-bg-add"></i><p>إضافة حذاء</p>
                        </div>
                        <div class="action-card" onclick="navigateToView('stats-view-content', document.querySelector('.nav-item[data-target=\'stats\']'))">
                            <i class="fas fa-chart-line icon-bg-stats"></i><p>عرض الإحصائيات</p>
                        </div>
                        <div class="action-card" onclick="navigateToView('inventory-view-content', document.querySelector('.nav-item[data-target=\'inventory\']'))"> 
                            <i class="fas fa-boxes-stacked icon-bg-inventory"></i><p>إدارة المخزون</p>
                        </div>
                        <div class="action-card" onclick="navigateToView('daily-sales-confirmation-view-content', null)"> 
                            <i class="fas fa-tasks icon-bg-confirm"></i><p>تأكيد المبيعات</p>
                        </div>
                        <div class="action-card" onclick="navigateToView('other-services-view-content', null)"> 
                            <i class="fas fa-cogs icon-bg-other-services"></i><p>خدمات أخرى</p>
                        </div>
                        <div class="action-card" onclick="navigateToView('ai-sales-advisor-view-content', null)"> 
                            <i class="fas fa-brain icon-bg-ai"></i><p>المستشار الذكي</p>
                        </div>
                         <div class="action-card" onclick="navigateToView('returns-view-content', null)">
                            <i class="fas fa-exchange-alt icon-bg-returns"></i><p>إدارة المرتجعات</p>
                        </div>
                    </div>
                </div>
                
                <div id="inventory-view-content" class="main-view-section hidden">
                    <div class="flex justify-center gap-2 mb-6" id="shoe-filter-buttons">
                        <button class="app-button filter-button active" data-category="all">الكل</button>
                        <button class="app-button filter-button" data-category="رجالية">رجالية</button>
                        <button class="app-button filter-button" data-category="نسائية">نسائية</button>
                        <button class="app-button filter-button" data-category="أطفال">أطفال</button>
                    </div>
                    <div id="shoe-display-area"></div>
                    <div class="back-button-container">
                        <button class="back-button app-button app-button-secondary" onclick="navigateToView('home-view-content', document.querySelector('.nav-item[data-target=\'home\']'))"><i class="fas fa-arrow-right"></i> رجوع للرئيسية</button>
                    </div>
                </div>
                
<div id="stats-view-content" class="main-view-section hidden">
    <h3 class="view-title">نظرة عامة على الإحصائيات</h3>
    <div id="stats-summary-cards" class="grid grid-cols-2 sm:grid-cols-2 gap-4 mb-6"></div>
    
    <div id="monthly-sales-section-in-stats" class="mt-6">
       <h4 class="section-title">تقرير المبيعات الشهرية</h4>
       <div id="monthly-sales-display-area-stats">
       </div>
    </div>

    <div id="detailed-monthly-report-section" class="mt-8">
    <div class="flex justify-between items-center mb-4">
        </button>
    </div>
<div id="detailed-monthly-sales-container" class="hidden bg-card-background-color p-4 rounded-lg shadow-md overflow-x-auto">
</div>
</div>
           <h4 class="section-title text-right">طباعة </h4> <!-- العنوان سيأخذ عرضه الكامل ومحاذاة لليمين. الكلاس section-title يوفر margin-bottom -->
        <div class="text-center mb-4"> <!-- حاوية جديدة لتوسيط الزر. mb-4 للحفاظ على التباعد السفلي الذي كان على الحاوية الأصلية -->
    <h4 class="section-title text-right"> </h4>
    <div class="text-right mb-4"> <!-- تم تغيير text-center إلى text-right لمحاذاة الزر إلى أقصى اليمين -->
            <button onclick="window.print()" class="app-button app-button-secondary px-4 py-2 text-sm">
                <i class="fas fa-print mr-2"> </i> طباعة التقرير
            </button>
        </div>
        <div id="detailed-monthly-sales-container" class="hidden bg-card-background-color p-4 rounded-lg shadow-md overflow-x-auto">
        </div>
    </div>
    <!-- تم إزالة div المكرر الذي يحمل id="detailed-monthly-sales-container" من هنا -->


    <div class="back-button-container">
       <button class="back-button app-button app-button-secondary" onclick="navigateToView('home-view-content', document.querySelector('.nav-item[data-target=\'home\']'))"><i class="fas fa-arrow-right"></i> رجوع للرئيسية</button>
   </div>
</div>

<div id="other-services-view-content" class="main-view-section hidden">
    <h3 class="view-title">خدمات أخرى</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
        <div class="action-card" onclick="navigateToView('delivery-services-view-content', null)">
            <i class="fas fa-shipping-fast icon-bg-delivery"></i><p>خدمات توصيل</p>
        </div>
        <div class="action-card" onclick="navigateToView('suppliers-view-content', null)">
            <i class="fas fa-users icon-bg-suppliers"></i><p>قائمة الموردين</p>
        </div>
    </div>

    <div id="stock-alerts-section-in-stats" class="mt-6"> 
       <h4 class="section-title">تنبيهات نقص المخزون</h4>
       <div class="mb-4 bg-card-background-color p-4 rounded-lg shadow-sm"> 
           <label for="stock-alert-threshold-stats" class="form-label">تنبيه إذا كانت الكمية أقل من أو تساوي:</label>
           <div class="flex items-center gap-3">
               <input type="number" id="stock-alert-threshold-stats" class="form-input w-24 text-sm py-2" value="1" min="0">
               <button id="refresh-stock-alerts-button-stats" class="app-button app-button-secondary px-4 py-2 text-xs">
                   <i class="fas fa-sync-alt mr-1"></i> تحديث
               </button>
           </div>
       </div>
       <div id="stock-alerts-list-area-stats" class="grid grid-cols-1 md:grid-cols-2 gap-4">
       </div>
    </div>

    <div id="best-selling-shoes-section" class="mt-6">
       <h4 class="section-title">الأحذية الأكثر مبيعًا</h4>
       <div id="best-selling-shoes-list" class="text-sm bg-card-background-color p-4 rounded-lg shadow-sm"></div> 
    </div>
    <div class="back-button-container">
        <button class="back-button app-button app-button-secondary" onclick="navigateToView('home-view-content', document.querySelector('.nav-item[data-target=\'home\']'))"><i class="fas fa-arrow-right"></i> رجوع للرئيسية</button>
    </div>
</div>

                <div id="delivery-services-view-content" class="main-view-section hidden">
                    <h3 class="view-title">أسعار خدمات التوصيل</h3>
                    <div class="mb-4">
                        <input type="text" id="search-delivery-wilaya-input" class="form-input" placeholder="ابحث عن ولاية...">
                    </div>
                    <div id="delivery-prices-display-area" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
                    <div class="back-button-container">
                        <button class="back-button app-button app-button-secondary" onclick="navigateToView('other-services-view-content', null)"><i class="fas fa-arrow-right"></i> رجوع لخدمات أخرى</button>
                    </div>
                </div>

                <div id="suppliers-view-content" class="main-view-section hidden">
                    <div class="flex justify-center items-center mb-6"> 
                        <button onclick="openAddSupplierModal()" class="app-button app-button-primary">
                            <i class="fas fa-plus mr-2"></i> إضافة مورد جديد
                        </button>
                    </div>
                    <div id="suppliers-list-area" class="mt-2">
                        </div>
                    <div class="back-button-container">
                        <button class="back-button app-button app-button-secondary" onclick="navigateToView('other-services-view-content', null)"><i class="fas fa-arrow-right"></i> رجوع لخدمات أخرى</button>
                    </div>
                </div>
                
                <div id="ai-sales-advisor-view-content" class="main-view-section hidden">
                    <h3 class="view-title">المساعد الذكي AI</h3>
                    <div id="ai-options-container" class="mb-4">
                         <button id="ai-chat-option-button" class="app-button ai-option-button w-full mb-3">
                            <i class="fas fa-comments"></i> محادثة مع المساعد الذكي
                        </button>
                        <button id="ai-analysis-option-button" class="app-button ai-option-button w-full">
                            <i class="fas fa-chart-pie"></i> تحليل ذكي للمبيعات والمخزون
                        </button>
                    </div>

                    <div id="ai-chat-interface" class="hidden">
                        <div id="ai-chat-area" class="mb-3">
                        </div>
                        <div class="flex gap-2 items-center">
                            <input type="text" id="ai-chat-input" class="form-input flex-grow" placeholder="اكتب رسالتك هنا...">
                            <button id="send-ai-chat-message-button" class="app-button app-button-primary px-4 py-2.5 text-sm">
                                <i class="fas fa-paper-plane"></i> 
                            </button>
                        </div>
                        <div id="ai-chat-loading-indicator" class="mt-2 text-sm text-gray-500 hidden items-center">
                            <div class="gemini-loader inline-block mr-2" style="width:16px; height:16px; border-width:2px;"></div>
                            المساعد الذكي يفكر...
                        </div>
                    </div>

                    <div id="ai-analysis-interface" class="hidden">
                        <h4 class="section-title">نصيحة المساعد الذكي:</h4>
                        <div id="ai-sales-advisor-response-area">
                            <p class="text-gray-500">اضغط على زر "تحليل ذكي" أعلاه للحصول على نصائح...</p>
                        </div>
                    </div>

                    <div class="back-button-container">
                        <button class="back-button app-button app-button-secondary" onclick="navigateToView('home-view-content', document.querySelector('.nav-item[data-target=\'home\']'))"><i class="fas fa-arrow-right"></i> رجوع للرئيسية</button>
                    </div>
                </div>
                
                <div id="returns-view-content" class="main-view-section hidden">
                    <h3 class="view-title">إدارة قائمة الإرجاع</h3>
                    <div class="bg-card-background-color p-5 rounded-xl shadow-lg mb-6"> 
                        <h4 class="section-title mb-4" id="add-return-form-title">إضافة عميل إلى قائمة الإرجاع</h4>
                        <form id="add-return-form">
                            <input type="hidden" id="editing-return-id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-5">
                                <div>
                                    <label for="return-customer-name" class="form-label">اسم العميل:</label>
                                    <input type="text" id="return-customer-name" class="form-input">
                                </div>
                                <div>
                                    <label for="return-customer-lastname" class="form-label">لقب العميل:</label>
                                    <input type="text" id="return-customer-lastname" class="form-input">
                                </div>
                            </div>
                            <div>
                                <label for="return-customer-phone" class="form-label">رقم هاتف العميل (إلزامي):</label>
                                <input type="tel" id="return-customer-phone" class="form-input" required>
                            </div>
                            <div>
                                <label for="return-notes" class="form-label">ملاحظات (سبب الإرجاع، الحذاء المرجع، إلخ):</label>
                                <textarea id="return-notes" class="form-textarea" rows="3"></textarea>
                            </div>
                            <button type="submit" id="add-return-submit-button" class="app-button app-button-primary w-full mt-3">إضافة إلى القائمة</button>
                        </form>
                        <button id="review-returns-list-button" class="app-button app-button-secondary w-full mt-4">مراجعة القائمة الكاملة</button>
                    </div>

                    <div class="bg-card-background-color p-5 rounded-xl shadow-lg"> 
                        <h4 class="section-title mb-4">البحث في قائمة الإرجاع</h4>
                        <div class="flex gap-3 mb-4">
                            <input type="tel" id="search-return-phone" class="form-input flex-grow" placeholder="أدخل رقم هاتف العميل للبحث">
                            <button id="search-return-button" class="app-button app-button-secondary px-5 text-sm">بحث</button>
                        </div>
                        <div id="return-search-result-area"></div>
                    </div>
                    <div id="all-returns-list-area" class="mt-6 hidden bg-card-background-color p-5 rounded-xl shadow-lg"> 
                         <h4 class="section-title mb-4">القائمة الكاملة لعمليات الإرجاع</h4>
                         </div>
                    <div class="back-button-container">
                        <button class="back-button app-button app-button-secondary" onclick="navigateToView('home-view-content', document.querySelector('.nav-item[data-target=\'home\']'))"><i class="fas fa-arrow-right"></i> رجوع للرئيسية</button>
                    </div>
                </div>

<div id="daily-sales-confirmation-view-content" class="main-view-section hidden">
    <h3 class="view-title">تأكيد المبيعات المعلقة</h3>

    <div class="flex flex-wrap justify-center gap-2 mb-6" id="pending-sale-filter-buttons">
    <button class="app-button filter-button active" data-filter="all">الكل</button>
    <button class="app-button filter-button" data-filter="pending">معلقة</button>
    <button class="app-button filter-button" data-filter="shipped">تم الشحن</button>
    <button id="date-filter-btn" class="app-button filter-button">
        <i class="fas fa-calendar-alt mr-2"></i>الفرز حسب تاريخ
    </button>
</div>

    <div id="pending-sales-area">
        </div>

    <div class="back-button-container">
         <button class="back-button app-button app-button-secondary" onclick="navigateToView('home-view-content', document.querySelector('.nav-item[data-target=\'home\']'))"><i class="fas fa-arrow-right"></i> رجوع للرئيسية</button>
    </div>
</div>

                <div id="about-app-view-content" class="main-view-section hidden bg-card-background-color p-6 rounded-xl shadow-lg"> 
                    <h3 class="text-2xl font-bold text-text-color-primary mb-5 text-center">حول تطبيق Shoes Manager Pro</h3> 
                    <p class="text-text-color-secondary leading-relaxed mb-5 text-center"> 
                        هذا التطبيق يساعدك على إدارة مخزون الأحذية وتتبع المبيعات بكفاءة وسهولة مع تصميم عصري واحترافي.
                    </p>
                    <div class="border-t border-border-color pt-5 mt-5"> 
                        <h4 class="text-xl font-semibold text-text-color-primary mb-3 text-center">عن المطور: بلال بورابعة</h4> 
                        <p class="text-sm text-text-color-secondary leading-relaxed mb-4 text-center"> 
                            مطور تطبيقات وأنظمة جزائري، شغوف بالتكنولوجيا والبرمجة. أعمل على مشاريع تهدف لنشر المعرفة وتبسيط التقنيات الحديثة.
                        </p>
                        <div class="flex justify-center gap-6 mt-4">
                            <a href="https://www.facebook.com/billel.bouraba" id="facebook-link" class="social-link" target="_blank"><i class="fab fa-facebook-square"></i> فيسبوك</a>
                            <a href="https://www.instagram.com/billel_bouraba" id="instagram-link" class="social-link" target="_blank"><i class="fab fa-instagram"></i> انستغرام</a>
                        </div>
                    </div>
                     <div class="back-button-container">
                        <button class="back-button app-button app-button-secondary" onclick="navigateToView('home-view-content', document.querySelector('.nav-item[data-target=\'home\']'))"><i class="fas fa-arrow-right"></i> رجوع للرئيسية</button>
                    </div>
                </div>

                <div id="settings-view-content" class="main-view-section hidden">
                     <h3 class="view-title">إعدادات التطبيق</h3>
                     <div class="bg-card-background-color p-5 rounded-xl shadow-lg mb-6"> 
                        <h4 class="section-title mb-4">إدارة البيانات المحلية</h4>
                        <button id="export-data-button" class="settings-button mb-3"><i class="fas fa-file-export"></i> تصدير كافة البيانات المحلية (JSON)</button>
                        <div>
                            <label for="import-data-file" class="form-label">استيراد بيانات محلية (JSON):</label>
                            <input type="file" id="import-data-file" class="form-file-input mb-2" accept=".json">
                            <button id="import-data-button" class="app-button app-button-secondary w-full text-sm">استيراد واستبدال البيانات المحلية</button>
                        </div>
                     </div>

<div id="firebase-sync-section" class="bg-card-background-color p-5 rounded-xl shadow-lg mb-6">
    <h4 class="section-title mb-4">مزامنة البيانات مع Firebase</h4>

    <button id="save-data-to-firebase-button" class="settings-button mb-3">
        <i class="fas fa-cloud-upload-alt"></i> حفظ البيانات إلى Firebase
    </button>

    <div class="relative"> <button id="import-data-from-firebase-button" class="settings-button mb-3 w-full">
            <i class="fas fa-cloud-download-alt"></i> استيراد البيانات من Firebase
        </button>
        <span id="firebase-sync-alert" class="hidden absolute top-0 -right-2 bg-amber-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse">
            جديد
        </span>
    </div> <p class="text-xs text-text-color-secondary mt-2">آخر مزامنة: <span id="last-firebase-sync-date">لم تتم المزامنة بعد</span></p>
    <p class="text-xs text-text-color-secondary mt-1">معرف المستخدم/البيانات: <span id="current-user-id-display">N/A</span></p>
</div>


                     <div class="bg-card-background-color p-5 rounded-xl shadow-lg"> 
                        <h4 class="section-title mb-4 text-red-600">إجراءات خطيرة</h4>
                        <button id="reset-app-button" class="settings-button danger w-full"><i class="fas fa-exclamation-triangle"></i> إعادة ضبط التطبيق (حذف كل البيانات المحلية)</button>
                     </div>
                     <div class="back-button-container">
                        <button class="back-button app-button app-button-secondary" onclick="navigateToView('home-view-content', document.querySelector('.nav-item[data-target=\'home\']'))"><i class="fas fa-arrow-right"></i> رجوع للرئيسية</button>
                    </div>
                </div>
            </div>
        </main>

        <nav class="bottom-nav"> 
            <button class="nav-item active" data-target="home">
                <i class="fas fa-home"></i><span class="mt-px">الرئيسية</span>
            </button>
            <button class="nav-item" data-target="about">
                <i class="fas fa-info-circle"></i><span class="mt-px">حول</span>
            </button>
            <button class="nav-item" data-target="stats"> 
                <i class="fas fa-chart-pie"></i><span class="mt-px">الإحصائيات</span>
            </button>
             <button class="nav-item relative" data-target="settings"> <i class="fas fa-cog"></i><span class="mt-px">الإعدادات</span>
                <span id="settings-notification-dot" class="hidden absolute top-1 right-3 w-3 h-3 bg-red-500 border-2 border-white rounded-full animate-pulse"></span>
            </button>
        </nav>
    </div>

    <div id="message-modal" class="modal-overlay">
        <div class="modal-content">
            <p id="message-modal-text" class="text-text-color-primary text-base mb-5"></p> 
            <div id="message-modal-buttons" class="flex justify-center gap-3">
                 <button id="message-modal-close-button" onclick="closeModal('message-modal')" class="app-button app-button-primary">حسنًا</button>
            </div>
        </div>
    </div>
    
    <div id="toast-notification" class="toast-notification">
        <span id="toast-icon"></span>
        <span id="toast-message"></span>
    </div>

    <div id="add-shoe-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title" id="add-edit-shoe-modal-title">إضافة حذاء جديد</h3> 
            <form id="add-shoe-form">
                <input type="hidden" id="editing-shoe-id"> 
                <div>
                    <label for="shoe-name" class="form-label">اسم الحذاء/الموديل:</label>
                    <input type="text" id="shoe-name" class="form-input" required>
                </div>
                <div>
                    <label for="shoe-category" class="form-label">تصنيف الحذاء:</label>
                    <select id="shoe-category" class="form-select">
                        <option value="">اختر التصنيف (اختياري)</option>
                        <option value="رجالية">رجالية</option>
                        <option value="نسائية">نسائية</option>
                        <option value="أطفال">أطفال</option>
                        <option value="الكل">الكل</option> 
                    </select>
                </div>
                <div>
                    <label for="shoe-image" class="form-label">صورة الحذاء (اختياري):</label>
                    <input type="file" id="shoe-image" class="form-file-input" accept="image/*">
                    <img id="image-preview-element" src="#" alt="معاينة الصورة" class="image-preview"/>
                </div>
                <div id="sizes-container" class="mt-4">
                    <label class="form-label">المقاسات والكميات:</label>
                </div>
                <button type="button" id="add-size-button" class="mt-1 mb-3 text-sm text-indigo-700 hover:text-indigo-900 font-semibold flex items-center">
                    <i class="fas fa-plus-circle mr-1.5"></i> إضافة مقاس وكمية
                </button>
                <div class="mt-3">
                    <label for="shoe-purchase-price" class="form-label">سعر الشراء (دج) (للقطعة):</label>
                    <input type="number" id="shoe-purchase-price" class="form-input" placeholder="اختياري">
                </div>
                <div>
                    <label for="shoe-description" class="form-label">الوصف:</label>
                    <textarea id="shoe-description" class="form-textarea" rows="3"></textarea>
                    <button type="button" id="generate-description-button" class="app-button app-button-accent mt-2 w-full">
                        <span id="button-text-node">✨ إنشاء وصف بالذكاء الاصطناعي</span>
                        <div class="gemini-loader" style="display: none;"></div>
                    </button>
                </div>
                <div class="mt-6 flex justify-center gap-x-4">
                    <button type="submit" id="save-shoe-button" class="app-button app-button-primary">حفظ الحذاء</button>
                    <button type="button" onclick="closeModal('add-shoe-modal')" class="app-button app-button-secondary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <div id="shoe-details-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="details-shoe-name" class="modal-title"></h3>
            <img id="details-shoe-image" src="#" alt="صورة الحذاء" class="details-image"/>
            <h4 class="section-title">التصنيف:</h4>
            <p id="details-shoe-category" class="mb-4 text-sm"></p>
            <h4 class="section-title">المقاسات والكميات المتوفرة:</h4>
            <div id="details-shoe-sizes" class="mb-4 text-sm"></div>
            <h4 class="section-title">سعر الشراء:</h4>
            <p id="details-shoe-purchase-price" class="mb-4 text-sm"></p>
            <h4 class="section-title">الوصف:</h4>
            <p id="details-shoe-description" class="mb-5 text-sm whitespace-pre-wrap"></p>
            <div class="mt-6 flex justify-center">
                <button type="button" onclick="closeModal('shoe-details-modal')" class="app-button app-button-secondary">إغلاق</button>
            </div>
        </div>
    </div>

    <div id="sell-shoe-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">تسجيل عملية بيع</h3>
            <form id="sell-shoe-form">
                <div>
                    <label for="sell-customer-name" class="form-label">اسم المشتري:</label>
                    <input type="text" id="sell-customer-name" class="form-input">
                </div>
                <div>
                    <label for="sell-customer-address" class="form-label">عنوان و ولاية :</label>
                    <input type="text" id="sell-customer-address" class="form-input">
                </div>
                <div>
                    <label for="sell-customer-phone" class="form-label">رقم هاتف :</label>
                    <input type="tel" id="sell-customer-phone" class="form-input">
                </div>
                <hr class="my-5 border-border-color"> 
                <div>
                    <label for="sell-shoe-select" class="form-label">اختر الحذاء:</label>
                    <select id="sell-shoe-select" class="form-select" required></select>
                </div>
                <div>
                    <label for="sell-shoe-size-select" class="form-label">اختر المقاس:</label>
                    <select id="sell-shoe-size-select" class="form-select" required></select>
                </div>
                 <div class="grid grid-cols-2 gap-x-5">
                    <div>
                        <label for="sell-quantity" class="form-label">الكمية المباعة:</label>
                        <input type="number" id="sell-quantity" class="form-input" min="1" required>
                        <p id="sell-available-quantity" class="text-xs text-text-color-secondary mt-1">الكمية المتوفرة: -</p> 
                    </div>
                    <div>
                        <label for="sell-price" class="form-label">سعر البيع (للقطعة):</label>
                        <input type="number" id="sell-price" class="form-input" min="0" step="any" required>
                    </div>
                </div>
                <div>
                <label for="sell-shipping-price" class="form-label">سعر الشحن (اختياري):</label>
                <input type="number" id="sell-shipping-price" class="form-input" placeholder="مثال: 600" min="0">
                </div>
                <div>
                    <label for="sell-date" class="form-label">تاريخ البيع:</label>
                    <input type="date" id="sell-date" class="form-input" required>
                </div>
                <div>
                    <label for="sell-notes" class="form-label">ملاحظات (اختياري):</label>
                    <textarea id="sell-notes" class="form-textarea" rows="2"></textarea>
                </div>
                <div class="mt-6 flex justify-center gap-x-4">
                    <button type="submit" class="app-button app-button-primary">متابعة للتأكيد</button>
                    <button type="button" onclick="closeModal('sell-shoe-modal')" class="app-button app-button-secondary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="global-search-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">بحث شامل</h3>
            <div class="flex gap-3 mb-5">
                <input type="text" id="global-search-input" class="form-input flex-grow" placeholder="ابحث عن حذاء أو رقم هاتف...">
                <button id="execute-global-search-button" class="app-button app-button-primary px-5 text-sm">بحث</button>
            </div>
            <div id="global-search-results-area">
            </div>
             <div class="mt-6 flex justify-center">
                <button type="button" onclick="closeModal('global-search-modal')" class="app-button app-button-secondary">إغلاق</button>
            </div>
        </div>
    </div>
    
<div id="edit-delivery-price-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">تعديل بيانات التوصيل</h3>
            <form id="edit-delivery-price-form">
                <input type="hidden" id="editing-wilaya-id">
                <div>
                    <label for="wilaya-name-display" class="form-label">الولاية:</label>
                    <input type="text" id="wilaya-name-display" class="form-input bg-gray-100" readonly>
                </div>
                <div>
                    <label for="wilaya-delivery-price" class="form-label">سعر التوصيل (دج):</label>
                    <input type="number" id="wilaya-delivery-price" class="form-input" required min="0">
                </div>

                <div class="mt-4">
                    <label for="wilaya-delivery-notes" class="form-label">ملاحظات (أسماء المكاتب، معلومات إضافية):</label>
                    <textarea id="wilaya-delivery-notes" class="form-textarea" rows="4" placeholder="اكتب هنا أسماء مكاتب التوصيل أو أي تفاصيل أخرى..."></textarea>
                </div>
                <div class="mt-6 flex justify-center gap-x-4">
                    <button type="submit" class="app-button app-button-primary">حفظ التعديلات</button>
                    <button type="button" onclick="closeModal('edit-delivery-price-modal')" class="app-button app-button-secondary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <div id="export-data-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">بيانات النسخ الاحتياطي (JSON)</h3>
            <p class="text-sm text-text-color-secondary mb-3 text-center">
                قم بنسخ النص أدناه واحفظه في ملف بامتداد `.json` للاحتفاظ بنسخة احتياطية من بياناتك.
            </p>
            <textarea id="export-data-text" class="form-textarea" rows="10" readonly></textarea>
            <div class="mt-4 flex flex-col sm:flex-row justify-center gap-3">
                <button onclick="copyExportDataToClipboard()" class="app-button app-button-primary w-full sm:w-auto">
                    <i class="fas fa-copy mr-2"></i>نسخ إلى الحافظة
                </button>
                <button type="button" onclick="closeModal('export-data-modal')" class="app-button app-button-secondary w-full sm:w-auto">إغلاق</button>
            </div>
        </div>
    </div>

    <div id="add-supplier-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title" id="add-edit-supplier-modal-title">إضافة مورد جديد</h3>
            <form id="add-supplier-form"> 
                 <input type="hidden" id="editing-supplier-id-input">
                <div>
                    <label for="supplier-name" class="form-label">اسم المورد:</label>
                    <input type="text" id="supplier-name" class="form-input" required>
                </div>
                <div>
                    <label for="supplier-image" class="form-label">صورة المورد (اختياري):</label>
                    <input type="file" id="supplier-image" class="form-file-input" accept="image/*">
                    <img id="supplier-image-preview" src="#" alt="معاينة صورة المورد" class="image-preview"/>
                </div>
                <div>
                    <label for="supplier-notes" class="form-label">ملاحظات (اختياري):</label>
                    <textarea id="supplier-notes" class="form-textarea" rows="3"></textarea>
                </div>
                <div class="mt-6 flex justify-center gap-x-4">
                    <button type="submit" id="save-supplier-button" class="app-button app-button-primary">إضافة مورد</button>
                    <button type="button" onclick="closeModal('add-supplier-modal')" class="app-button app-button-secondary">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <div id="supplier-details-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="details-supplier-modal-name" class="modal-title text-center"></h3>
            <div id="details-supplier-modal-image-container" class="flex justify-center mb-4">
            </div>
            <h4 class="section-title">ملاحظات:</h4>
            <p id="details-supplier-modal-notes" class="mb-4 text-sm whitespace-pre-wrap min-h-[50px] p-3 rounded-md"></p>
            <h4 class="section-title">تاريخ الإضافة:</h4>
            <p id="details-supplier-modal-added-date" class="mb-5 text-sm"></p>
            <div class="mt-6 flex justify-center">
                <button type="button" onclick="closeModal('supplier-details-modal')" class="app-button app-button-secondary">إغلاق</button>
            </div>
        </div>
    </div>

    <div id="auth-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title" id="auth-modal-title">تسجيل الدخول</h3>
            <div id="auth-error-message"></div>
            <form id="login-form">
                <div>
                    <label for="login-email" class="form-label">البريد الإلكتروني:</label>
                    <input type="email" id="login-email" class="form-input" required>
                </div>
                <div>
                    <label for="login-password" class="form-label">كلمة المرور:</label>
                    <input type="password" id="login-password" class="form-input" required>
                </div>
                <button type="submit" class="app-button app-button-primary w-full mt-4">تسجيل الدخول</button>
                <p class="auth-form-toggle" id="show-signup-form">ليس لديك حساب؟ إنشاء حساب جديد</p>
            </form>
            <form id="signup-form" class="hidden">
                <div>
                    <label for="signup-firstname" class="form-label">الاسم الأول:</label>
                    <input type="text" id="signup-firstname" class="form-input" required>
                </div>
                <div>
                    <label for="signup-lastname" class="form-label">اللقب:</label>
                    <input type="text" id="signup-lastname" class="form-input" required>
                </div>
                <div>
                    <label for="signup-email" class="form-label">البريد الإلكتروني:</label>
                    <input type="email" id="signup-email" class="form-input" required>
                </div>
                <div>
                    <label for="signup-password" class="form-label">كلمة المرور:</label>
                    <input type="password" id="signup-password" class="form-input" required minlength="6">
                </div>
                 <div>
                    <label for="signup-confirm-password" class="form-label">تأكيد كلمة المرور:</label>
                    <input type="password" id="signup-confirm-password" class="form-input" required>
                </div>
                <button type="submit" class="app-button app-button-primary w-full mt-4">إنشاء حساب</button>
                <p class="auth-form-toggle" id="show-login-form">لديك حساب بالفعل؟ تسجيل الدخول</p>
            </form>
            <button type="button" onclick="closeModal('auth-modal')" class="app-button app-button-secondary w-full mt-4">إلغاء</button>
        </div>
    </div>

    <div id="user-info-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="user-info-welcome-title" class="modal-title">ملف المستخدم</h3>
        <div id="user-info-details" class="text-right text-base mt-4 mb-6">
            </div>
        <div class="flex flex-col items-center gap-y-3">
            <button id="logout-button-modal" class="app-button app-button-danger w-full sm:w-auto">تسجيل الخروج</button>
            <button type="button" onclick="closeModal('user-info-modal')" class="app-button app-button-secondary w-full sm:w-auto">إغلاق</button>
        </div>
    </div>
</div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updateProfile,
            signInAnonymously, 
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { 
    getFirestore, 
    doc, 
    setDoc, 
    getDoc,
    serverTimestamp, 
    collection, 
    setLogLevel,
    onSnapshot // <-- أضف هذا
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration (User-provided in prompt) ---
        const userProvidedConfig = { // This is the config the user wants for the "Emperor" functionality
            apiKey: "AIzaSyC52e_whkQh-vwgdwuuzl4wMpVxILXGkSQ",
            authDomain: "shoes-manager-pro.firebaseapp.com",
            projectId: "shoes-manager-pro",
            storageBucket: "shoes-manager-pro.firebasestorage.app",
            messagingSenderId: "951149272003",
            appId: "1:951149272003:web:adc2e0d55caf3fa2047b76",
            measurementId: "G-78JR9S1H33"
        };
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userProvidedConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // For path construction

        // Initialize Firebase
        const fbApp = initializeApp(firebaseConfig); // Renamed to fbApp to avoid conflict
        const auth = getAuth(fbApp);
        const dbFirebase = getFirestore(fbApp); 
        setLogLevel('debug'); 

        // --- Global Variables for App State ---
        let currentFirebaseUser = null;
        let currentUserId = null; 
        let isEmperorModeActive = false;
        let firestoreListenerUnsubscribe = null; // <-- أضف هذا المتغير
        // Dexie DB instance
// استبدل كل تعريفات الـ versions القديمة بهذا التعريف الجديد
        const db = new Dexie("ShoesManagerDB_v6"); // قمنا بتغيير الاسم لضمان التحديث
    db.version(7).stores({
    shoes: 'id, name, addedDate, category, *sizes.size',
    sales: '++id, shoeId, date, total, saleMonthYear, shippingPrice', // أضفنا shippingPrice
    returns: '++id, phone, date, returnMonthYear',
    pendingSales: 'id, shoeId, shoeImage, date, saleMonthYear, shippingConfirmed, shippingPrice', // أضفنا shippingPrice
    deliveryPrices: 'id, name',
    monthlyReports: 'monthYear, &monthYear',
    suppliers: '++id, name, notes, imageUrl, addedDate'
        }).upgrade(async tx => {
            console.log("Upgrading database schema to version 6 to add notes for delivery prices.");
            
            // الترقية: إضافة حقل الملاحظات لكل ولاية موجودة
            await tx.table("deliveryPrices").toCollection().modify(wilaya => {
                if (wilaya.notes === undefined) {
                    wilaya.notes = ''; // إضافة حقل الملاحظات الجديد كقيمة فارغة
                }
            });
            console.log("Delivery prices schema updated successfully.");
        });
        db.version(4).stores({ 
            shoes: 'id, name, addedDate, *sizes.size', 
            sales: '++id, shoeId, date, total, saleMonthYear', 
            returns: '++id, phone, date, returnMonthYear', 
            pendingSales: 'id, shoeId, date, saleMonthYear, shippingConfirmed', 
            deliveryPrices: 'id, name', 
            monthlyReports: 'monthYear, &monthYear',
            suppliers: '++id, name, notes, imageUrl, addedDate' 
        }).upgrade(async tx => { 
            console.log("Upgrading database schema to version 4.");
            if (await tx.table('suppliers').count() > 0) {
                await tx.table("suppliers").toCollection().modify(supplier => {
                    if (supplier.addedDate === undefined) {
                        supplier.addedDate = new Date().toISOString(); 
                    }
                });
            }
        });
        db.version(3).stores({ 
            shoes: 'id, name, addedDate, *sizes.size', 
            sales: '++id, shoeId, date, total, saleMonthYear', 
            returns: '++id, phone, date, returnMonthYear', 
            pendingSales: 'id, shoeId, date, saleMonthYear, shippingConfirmed', 
            deliveryPrices: 'id, name', 
            monthlyReports: 'monthYear, &monthYear',
            suppliers: '++id, name, notes, imageUrl' 
        }).upgrade(async tx => { 
            console.log("Upgrading database schema from v2 to v3.");
            if (await tx.table('suppliers').count() > 0) {
                await tx.table("suppliers").toCollection().modify(supplier => {
                    if (supplier.notes === undefined) {
                        supplier.notes = ""; 
                    }
                    if (supplier.imageUrl === undefined) {
                        supplier.imageUrl = null;
                    }
                    if (supplier.firstname && !supplier.name) {
                        supplier.name = supplier.firstname + (supplier.lastname ? ` ${supplier.lastname}` : '');
                    }
                    delete supplier.firstname; 
                    delete supplier.lastname;
                });
            }
        });
        // (إضافة جديدة) دالة لعرض تقرير المبيعات الشهري المفصل
// (الكود النهائي الكامل - قم بلصق هذا)
async function displayDetailedMonthlyReport() {
    const container = document.getElementById('detailed-monthly-sales-container');
    container.innerHTML = '<p class="text-text-color-secondary text-center py-4">جاري تحميل التقرير...</p>';

    try {
        await db.open();
        
        const now = new Date();
        const currentMonthYear = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        
        const salesThisMonth = await db.sales.where('saleMonthYear').equals(currentMonthYear).toArray();

        if (salesThisMonth.length === 0) {
            container.innerHTML = '<p class="text-text-color-secondary text-center py-4">لا توجد مبيعات مسجلة لهذا الشهر.</p>';
            return;
        }

        // ▼▼▼ بداية الإضافة: حساب الإجماليات ▼▼▼
        const totalQuantitySold = salesThisMonth.reduce((sum, sale) => sum + sale.quantity, 0);
        const totalValueSold = salesThisMonth.reduce((sum, sale) => sum + sale.total, 0);
        // ▲▲▲ نهاية الإضافة ▲▲▲
        
        // تم إضافة بعض الأنماط المضمنة لتحسين شكل الطباعة
        let tableHTML = `<table class="min-w-full text-sm text-right" style="width: 100%; border-collapse: collapse;">
                            <thead class="bg-gray-100 dark:bg-gray-700">
                                <tr>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #333;">الزبون</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #333;">الحذاء المباع</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #333;">تاريخ البيع</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #333;">السعر الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody>`;
        
        salesThisMonth.sort((a, b) => new Date(b.date) - new Date(a.date));

        salesThisMonth.forEach(sale => {
const saleDate = new Date(sale.date).toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric', numberingSystem: 'latn' });            tableHTML += `
                <tr class="border-b border-border-color">
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${sale.customerName || 'زبون غير مسجل'}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${sale.shoeName} (مقاس: ${sale.size})</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${saleDate}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: left; font-family: monospace;">${sale.total.toFixed(2)} دج</td>
                </tr>
            `;
        });

        tableHTML += `</tbody></table>`;

        // ▼▼▼ بداية الإضافة: إنشاء قسم الملخص ▼▼▼
        const summaryHTML = `
            <div style="margin-top: 25px; padding-top: 15px; border-top: 2px solid #333; text-align: right; font-size: 14px; color: #000;">
                <h5 style="font-size: 16px; font-weight: 700; margin-bottom: 10px;">ملخص مبيعات الشهر</h5>
                <p style="font-size: 15px; margin-bottom: 5px;">
                    <strong>إجمالي عدد الأحذية المباعة:</strong>
                    ${totalQuantitySold} قطعة
                </p>
                <p style="font-size: 15px;">
                    <strong>المجموع الكلي للمبيعات:</strong>
                    <span style="font-weight: 700; color: #4CAF50;">${totalValueSold.toFixed(2)} دج</span>
                </p>
            </div>
        `;
        // ▲▲▲ نهاية الإضافة ▲▲▲

        // دمج الجدول مع الملخص
        container.innerHTML = tableHTML + summaryHTML;

    } catch (error) {
        console.error("Error displaying detailed monthly report:", error);
        container.innerHTML = '<p class="text-error-color text-center py-4">حدث خطأ أثناء تحميل التقرير.</p>';
    }
}

        // --- DOM Elements ---
        const mainAppContainer = document.getElementById('main-app');
        const splashScreen = document.getElementById('splash-screen');
        const secretCodeModalOverlay = document.getElementById('secret-code-modal-overlay');
        const secretCodeForm = document.getElementById('secret-code-form');
        const secretCodeInput = document.getElementById('secret-code-input');
        const secretCodeError = document.getElementById('secret-code-error');
        
        const mainAppTitle = document.getElementById('main-app-title');
        const authActionButton = document.getElementById('auth-action-button');
        const userStatusDiv = document.getElementById('user-status');
        const authModal = document.getElementById('auth-modal');
        const authModalTitle = document.getElementById('auth-modal-title');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignupFormLink = document.getElementById('show-signup-form');
        const showLoginFormLink = document.getElementById('show-login-form');
        const authErrorMessage = document.getElementById('auth-error-message');
        const firebaseSyncSection = document.getElementById('firebase-sync-section');
        const saveDataToFirebaseButton = document.getElementById('save-data-to-firebase-button');
        const importDataFromFirebaseButton = document.getElementById('import-data-from-firebase-button');
        const lastFirebaseSyncDateEl = document.getElementById('last-firebase-sync-date');
        const currentUserIdDisplay = document.getElementById('current-user-id-display');

        // --- Emperor Mode Activation ---
        function activateEmperorMode() {
            isEmperorModeActive = true;
            localStorage.setItem(EMPEROR_STORAGE_KEY, 'true');
            secretCodeModalOverlay.classList.remove('visible');
            mainAppContainer.style.display = 'flex';
            
            mainAppTitle.textContent = 'Shoes Manager Pro';
            userStatusDiv.innerHTML = `<span class="text-sm font-semibold text-amber-300">EmperTech</span>`;
            if(authActionButton) authActionButton.style.display = 'none'; // Hide regular login button

            firebaseSyncSection.classList.remove('hidden');
            currentUserIdDisplay.textContent = `بيانات الامبراطور (${EMPEROR_CODE})`;
            loadLastSyncDateFromFirebase(); // Will use emperor path due to global flag
            navigateToView('home-view-content', document.querySelector('.nav-item[data-target="home"]'));
        }

        secretCodeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const enteredCode = secretCodeInput.value;
            if (enteredCode === EMPEROR_CODE) {
                secretCodeError.textContent = '';
                activateEmperorMode();
            } else {
                secretCodeError.textContent = 'الرمز السري غير صحيح. حاول مرة أخرى.';
                secretCodeInput.value = '';
            }
        });

        // --- Auth UI Management (for regular Firebase Auth) ---
        function showAuthError(message) {
            authErrorMessage.textContent = message;
            authErrorMessage.style.display = 'block';
        }
        function clearAuthError() {
            authErrorMessage.textContent = '';
            authErrorMessage.style.display = 'none';
        }
        function openAuthModal(isLogin = true) {
            if (isEmperorModeActive) return; // Don't show if emperor mode is active
            clearAuthError();
            if (isLogin) {
                authModalTitle.textContent = 'تسجيل الدخول';
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            } else {
                authModalTitle.textContent = 'إنشاء حساب جديد';
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            }
            showModal('auth-modal');
        }

        if (showSignupFormLink) showSignupFormLink.addEventListener('click', () => openAuthModal(false));
        if (showLoginFormLink) showLoginFormLink.addEventListener('click', () => openAuthModal(true));
        if (authActionButton) {
            authActionButton.addEventListener('click', () => {
                if (isEmperorModeActive) return; // Button should be hidden anyway
                if (currentFirebaseUser) {
                    handleLogout();
                } else {
                    openAuthModal(true);
                }
            });
        }
        

// (استبدال) --- Firebase Auth Event Listener (المتحكم الرئيسي الجديد) ---

let authInitialized = false; // متغير جديد لتتبع أول عملية تحقق

// (تأكد من أن هذا الكود موجود لديك بهذا الشكل)
onAuthStateChanged(auth, async (user) => {
    currentFirebaseUser = user;

    if (!authInitialized) {
        authInitialized = true;
        const splashScreen = document.getElementById('splash-screen');
        const mainAppContainer = document.getElementById('main-app');
        splashScreen.classList.add('hidden');
        mainAppContainer.style.display = 'flex';

        try {
            await db.open(); 
            console.log("Dexie Database opened successfully.");
            await getStoredDeliveryPrices(); 
        } catch (error) {
            console.error("Failed to open Dexie database:", error);
            showToast('فشل فتح قاعدة البيانات المحلية. بعض الميزات قد لا تعمل.', 'error');
        }
        navigateToView('home-view-content', document.querySelector('.nav-item[data-target="home"]'));
    }

    if (user) {
        console.log("User is signed in:", user);
        currentUserId = user.uid;

        userStatusDiv.innerHTML = `
            <button id="user-profile-button" class="app-button app-button-secondary text-sm px-4 py-2">
                <i class="fas fa-user-circle mr-2"></i>
                <span>${user.displayName || user.email}</span>
            </button>
        `;
        document.getElementById('user-profile-button').addEventListener('click', openUserInfoModal);

        firebaseSyncSection.classList.remove('hidden');
        currentUserIdDisplay.textContent = currentUserId;
        
        // ▼▼▼ الأهم هنا ▼▼▼
        await setupRealtimeSyncListener(); // إعداد المستمع للمستخدم الجديد
        loadLastSyncDateFromFirebase();

    } else {
        console.log("User is signed out.");
        if (firestoreListenerUnsubscribe) {
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
            console.log("Firestore listener unsubscribed for logout.");
        }
        
        currentUserId = null;
        userStatusDiv.innerHTML = `<button id="login-modal-button-header" class="app-button app-button-secondary text-xs px-3 py-1.5">تسجيل الدخول</button>`;
        document.getElementById('login-modal-button-header').addEventListener('click', () => openAuthModal(true));

        firebaseSyncSection.classList.add('hidden');
        currentUserIdDisplay.textContent = 'N/A (غير مسجل)';
        lastFirebaseSyncDateEl.textContent = 'يتطلب تسجيل الدخول للمزامنة';
    }

    closeModal('auth-modal'); 
});
        
        async function initializeAuth() { // For anonymous or custom token sign-in
            try {
                if (auth.currentUser) {
                    console.log("User already authenticated:", auth.currentUser.uid);
                    return auth.currentUser;
                }
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("Attempting to sign in with custom token...");
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Successfully signed in with custom token.");
                } else {
                    console.log("No custom token found, attempting to sign in anonymously...");
                    await signInAnonymously(auth);
                    console.log("Successfully signed in anonymously.");
                }
                return auth.currentUser;
            } catch (error) {
                console.error("Error during initial Firebase sign-in:", error);
                if (!auth.currentUser) {
                    try {
                        await signInAnonymously(auth);
                        console.log("Successfully signed in anonymously after custom token failure.");
                        return auth.currentUser;
                    } catch (anonError) {
                        console.error("Error signing in anonymously after custom token failure:", anonError);
                        showToast("خطأ في المصادقة الأولية مع Firebase.", "error");
                    }
                }
                return null;
            }
        }

        // --- Firebase Auth Functions (Regular Email/Password) ---
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (isEmperorModeActive) return;
                clearAuthError();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showToast('تم تسجيل الدخول بنجاح!', 'success');
                } catch (error) {
                    console.error("Login error:", error);
                    showAuthError(getFirebaseErrorMessage(error));
                }
            });
        }
async function displayBestSellingShoes() {
    const bestSellingList = document.getElementById('best-selling-shoes-list');
    bestSellingList.innerHTML = '';
    try {
        await db.open();
        const sales = await db.sales.toArray();
        if (sales.length > 0) {
            const salesByShoe = {};
            sales.forEach(sale => {
                salesByShoe[sale.shoeName] = (salesByShoe[sale.shoeName] || 0) + sale.quantity;
            });
            const sortedBestSelling = Object.entries(salesByShoe)
                                        .sort(([,a],[,b]) => b-a)
                                        .slice(0, 5); 

            if (sortedBestSelling.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-none p-0';
                sortedBestSelling.forEach(([name, quantity]) => {
                    const item = document.createElement('li');
                    item.className = 'py-2 border-b border-border-color flex justify-between items-center';
                    // هذا هو السطر الذي تم إصلاحه
                    item.innerHTML = `<span>${name}</span> <span class="font-semibold text-primary-color">${quantity} قطعة</span>`;
                    ul.appendChild(item);
                });
                bestSellingList.appendChild(ul);
            } else {
                 bestSellingList.innerHTML = '<p class="text-text-color-secondary">لا توجد بيانات مبيعات كافية لعرض الأكثر مبيعًا.</p>';
            }
        } else {
            bestSellingList.innerHTML = '<p class="text-text-color-secondary">لا توجد مبيعات مسجلة بعد.</p>';
        }
    } catch (error) {
        console.error("Error displaying best-selling shoes:", error);
        bestSellingList.innerHTML = '<p class="text-error-color">خطأ في عرض الأحذية الأكثر مبيعًا.</p>';
    }
}

       if (signupForm) {
    signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const firstName = document.getElementById('signup-firstname').value;
        const lastName = document.getElementById('signup-lastname').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        // ... (بقية كود التحقق) ...

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await updateProfile(userCredential.user, { displayName: `${firstName} ${lastName}` });

            // ... (كود حفظ البيانات الإضافية في Firestore) ...

            showToast('تم إنشاء الحساب وتسجيل الدخول بنجاح!', 'success');

            // ▼▼▼ ابدأ الإضافة من هنا ▼▼▼
            // تحديث الواجهة يدويًا بالاسم الصحيح
            userStatusDiv.innerHTML = `
                <span class="text-xs mr-2">مرحباً، ${firstName} ${lastName}</span>
                <button id="logout-button" class="app-button app-button-secondary text-xs px-3 py-1.5">تسجيل الخروج</button>
            `;
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            // ▲▲▲ انتهت الإضافة هنا ▲▲▲

        } catch (error) {
            console.error("Signup error:", error);
            showAuthError(getFirebaseErrorMessage(error));
        }
    });
}

// --- الكود بعد التعديل ---
async function handleLogout() {
    try {
        await signOut(auth);
        showToast('تم تسجيل الخروج بنجاح.', 'success');
        closeModal('user-info-modal'); // <-- هذا هو السطر المضاف
    } catch (error) {
        console.error("Logout error:", error);
        showToast('خطأ أثناء تسجيل الخروج.', 'error');
    }
}

        function getFirebaseErrorMessage(error) {
            // ... (same as original)
            switch (error.code) {
                case 'auth/invalid-email': return 'البريد الإلكتروني غير صالح.';
                case 'auth/user-disabled': return 'تم تعطيل هذا الحساب.';
                case 'auth/user-not-found': return 'لم يتم العثور على حساب بهذا البريد الإلكتروني.';
                case 'auth/wrong-password': return 'كلمة المرور غير صحيحة.';
                case 'auth/email-already-in-use': return 'هذا البريد الإلكتروني مستخدم بالفعل.';
                case 'auth/weak-password': return 'كلمة المرور ضعيفة جدًا.';
                case 'auth/operation-not-allowed': return 'عملية تسجيل الدخول/الاشتراك هذه غير مفعلة.';
                default: return 'حدث خطأ غير متوقع. يرجى المحاولة مرة أخرى.';
            }
        }
        
        // --- Firebase Firestore Data Sync Functions (Adapting for Emperor Mode) ---
        async function getAllLocalData() {
            try {
                await db.open();
                // Exclude imageUrl from shoes when fetching for backup
                const shoesWithoutImages = (await db.shoes.toArray()).map(shoe => {
                    const { imageUrl, ...rest } = shoe;
                    return rest;
                });
                // Exclude imageUrl from suppliers when fetching for backup
                const suppliersWithoutImages = (await db.suppliers.toArray()).map(supplier => {
                    const { imageUrl, ...rest } = supplier;
                    return rest;
                });
                // Exclude shoeImage from pendingSales when fetching for backup
                const pendingSalesWithoutImages = (await db.pendingSales.toArray()).map(sale => {
                    const { shoeImage, ...rest } = sale;
                    return rest;
                });

                return {
                    shoes: shoesWithoutImages,
                    sales: await db.sales.toArray(),
                    returns: await db.returns.toArray(),
                    pendingSales: pendingSalesWithoutImages, // Use the new array without images
                    deliveryPrices: await db.deliveryPrices.toArray(),
                    suppliers: suppliersWithoutImages, 
                    monthlyReports: await db.monthlyReports.toArray(),
                };
            } catch (error) {
                console.error("Error getting all local data from Dexie:", error);
                showToast('فشل في جمع البيانات المحلية للمزامنة.', 'error');
                return null;
            }
        }

// (الكود الجديد الصحيح)
function getFirestoreDataPath() {
    if (currentFirebaseUser && currentUserId) {
        // نرجع مصفوفة من الأجزاء بدلاً من نص واحد
        return ['artifacts', appId, 'users', currentUserId, 'appData', 'mainStore'];
    }
    return null;
}

// ▼▼▼ ابدأ النسخ من هنا ▼▼▼

async function backupDataToFirestore() {
    const dataPath = getFirestoreDataPath();
    if (!dataPath) {
        showToast('لا يمكن تحديد مسار البيانات. يرجى التأكد من تسجيل الدخول.', 'error');
        if (!isEmperorModeActive && !currentFirebaseUser) openAuthModal(true);
        return;
    }
     if (!auth.currentUser) {
        showToast('جاري تهيئة الاتصال بالسحابة، يرجى المحاولة بعد لحظات.', 'error');
        await initializeAuth();
        if(!auth.currentUser) {
             showToast('فشل الاتصال بالسحابة. لا يمكن المزامنة.', 'error');
             return;
        }
    }

    const localData = await getAllLocalData();
    if (!localData) return;

    const dataString = JSON.stringify(localData);
    const dataSizeBytes = new TextEncoder().encode(dataString).length;
    const ONE_MB = 1024 * 1024;

    if (dataSizeBytes > ONE_MB) {
        showToast(`حجم البيانات كبير جدًا (${(dataSizeBytes / ONE_MB).toFixed(2)} ميغابايت). لا يمكن حفظها.`, 'error');
        return;
    }

    showModal('message-modal', `جاري حفظ البيانات إلى Firebase...`);
    document.getElementById('message-modal-buttons').innerHTML = `<div class="loader mx-auto"></div>`;

    try {
        const dataDocRef = doc(dbFirebase, ...dataPath);
        await setDoc(dataDocRef, {
            ...localData,
            lastSync: serverTimestamp(),
            lastSyncDeviceId: myDeviceId
        });
        
        const syncTime = new Date();
        localStorage.setItem('lastLocalSyncTimestamp', syncTime.getTime().toString());
        lastFirebaseSyncDateEl.textContent = syncTime.toLocaleString('ar-EG', { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', numberingSystem: 'latn' });
        showToast('تم حفظ البيانات بنجاح في Firebase!', 'success');
    } catch (error) {
        console.error("Error saving data to Firestore:", error);
        showToast(`فشل حفظ البيانات في Firebase: ${error.message}`, 'error');
    } finally {
        closeModal('message-modal');
    }
}

async function restoreDataFromFirestore() {
    const dataPath = getFirestoreDataPath();
    if (!dataPath) {
        showToast('لا يمكن تحديد مسار البيانات. يرجى التأكد من تسجيل الدخول.', 'error');
        if (!isEmperorModeActive && !currentFirebaseUser) openAuthModal(true);
        return;
    }
    if (!auth.currentUser) {
        showToast('جاري تهيئة الاتصال بالسحابة، يرجى المحاولة بعد لحظات.', 'error');
        await initializeAuth();
        if (!auth.currentUser) {
            showToast('فشل الاتصال بالسحابة. لا يمكن المزامنة.', 'error');
            return;
        }
    }

    showModal('message-modal', `هل أنت متأكد أنك تريد استرجاع البيانات من Firebase؟ سيتم دمجها مع البيانات المحلية الحالية.`);
    document.getElementById('message-modal-buttons').innerHTML = `
        <button onclick="closeModal('message-modal')" class="app-button app-button-secondary">إلغاء</button>
        <button id="confirm-firebase-import-action" class="app-button app-button-primary">نعم، استرجاع</button>
    `;

    document.getElementById('confirm-firebase-import-action').onclick = async () => {
        showModal('message-modal', `جاري استرجاع البيانات من Firebase...`);
        document.getElementById('message-modal-buttons').innerHTML = `<div class="loader mx-auto"></div>`;

        try {
            const dataDocRef = doc(dbFirebase, ...dataPath);
            const docSnap = await getDoc(dataDocRef);

            if (docSnap.exists()) {
                const firebaseData = docSnap.data();
                await db.open();

                // استيراد البيانات
                if (firebaseData.shoes) {
                    const localShoesMap = new Map((await db.shoes.toArray()).map(shoe => [shoe.id, shoe]));
                    for (const firebaseShoe of firebaseData.shoes) {
                        const existingLocalShoe = localShoesMap.get(firebaseShoe.id);
                        await db.shoes.put({ ...existingLocalShoe, ...firebaseShoe });
                    }
                }
                if (firebaseData.suppliers) await db.suppliers.bulkPut(firebaseData.suppliers);
                if (firebaseData.pendingSales) await db.pendingSales.bulkPut(firebaseData.pendingSales);
                if (firebaseData.sales) await db.sales.bulkPut(firebaseData.sales);
                if (firebaseData.returns) await db.returns.bulkPut(firebaseData.returns);
                if (firebaseData.monthlyReports) await db.monthlyReports.bulkPut(firebaseData.monthlyReports);
                if (firebaseData.deliveryPrices) await db.deliveryPrices.bulkPut(firebaseData.deliveryPrices);
                else { await db.deliveryPrices.bulkPut(getDefaultWilayaPrices()); }

                // تحديث وقت المزامنة المحلي وإخفاء التنبيهات
                if (firebaseData.lastSync && firebaseData.lastSync.toDate) {
                    const syncTime = firebaseData.lastSync.toDate();
                    localStorage.setItem('lastLocalSyncTimestamp', syncTime.getTime().toString());
                    lastFirebaseSyncDateEl.textContent = syncTime.toLocaleString('ar-EG', { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', numberingSystem: 'latn' });
                }

                document.getElementById('firebase-sync-alert').classList.add('hidden');
                document.getElementById('settings-notification-dot').classList.add('hidden');
                
                showToast('تم استرجاع البيانات بنجاح من Firebase!', 'success');

                // تحديث الواجهة
                const currentViewId = document.querySelector('.main-view-section:not(.hidden)')?.id;
                navigateToView(currentViewId || 'home-view-content', document.querySelector(`.nav-item[data-target="${currentViewId?.replace('-view-content', '') || 'home'}"]`));
            } else {
                showToast('لا توجد بيانات محفوظة في Firebase لهذا المسار.', 'error');
                lastFirebaseSyncDateEl.textContent = 'لا توجد بيانات في السحابة';
            }
        } catch (error) {
            console.error("Error importing data from Firestore:", error);
            showToast(`فشل استيراد البيانات: ${error.message}`, 'error');
        } finally {
            closeModal('message-modal');
        }
    };
}
        
async function loadLastSyncDateFromFirebase() {
    const dataPath = getFirestoreDataPath();
    if (!dataPath || !auth.currentUser) {
         lastFirebaseSyncDateEl.textContent = 'يتطلب تسجيل الدخول';
         return;
    }
    try {
        const dataDocRef = doc(dbFirebase, ...dataPath);
        const docSnap = await getDoc(dataDocRef);
        if (docSnap.exists() && docSnap.data().lastSync && docSnap.data().lastSync.toDate) {
            lastFirebaseSyncDateEl.textContent = docSnap.data().lastSync.toDate().toLocaleString('ar-EG', { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', numberingSystem: 'latn' });
        } else {
            lastFirebaseSyncDateEl.textContent = 'لم تتم المزامنة بعد';
        }
    } catch (error) {
        console.warn("Could not load last sync date from Firebase:", error);
        lastFirebaseSyncDateEl.textContent = 'خطأ في تحميل تاريخ المزامنة';
    }
}

// ▲▲▲ انتهي من النسخ هنا ▲▲▲

        // Event listeners for Firebase sync buttons
        if(saveDataToFirebaseButton) saveDataToFirebaseButton.addEventListener('click', backupDataToFirestore); // Changed to new function
        if(importDataFromFirebaseButton) importDataFromFirebaseButton.addEventListener('click', restoreDataFromFirestore); // Changed to new function


        // --- Existing JS Code (Global Scope, Modals, Dexie operations, UI updates, etc.) ---
        const THEME_STORAGE_KEY = 'myShoesApp_theme_v1_pro_refined_firebase'; 
        let editingReturnId = null; 
        let editingShoeId = null; 
        let aiChatHistory = []; 
        let currentEditingWilayaId = null; 
        let editingSupplierId = null; 
        let currentShoeFilter = 'all'; 
let currentPendingSaleFilter = 'all'; // فلتر المبيعات المعلقة
        // --- Theme Management ---
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const currentTheme = localStorage.getItem(THEME_STORAGE_KEY);

        function setTheme(theme) {
            localStorage.setItem(THEME_STORAGE_KEY, theme);
            document.body.classList.toggle('dark-mode', theme === 'dark');
            themeToggleButton.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }

        if (currentTheme) {
            setTheme(currentTheme);
        } else {
            setTheme('light'); 
        }

        themeToggleButton.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
            setTheme(newTheme);
        });

        // --- Modal Management ---
        window.showModal = function(modalId, message = null) {
            // ... (same as original, ensure z-index is correct if multiple modals can overlap)
            const modal = document.getElementById(modalId);
            const messageModalButtons = document.getElementById('message-modal-buttons');
            if (message && modalId === 'message-modal') {
                document.getElementById('message-modal-text').textContent = message;
                messageModalButtons.innerHTML = `<button id="message-modal-close-button" onclick="closeModal('message-modal')" class="app-button app-button-primary">حسنًا</button>`;
            }
            if (modal) modal.classList.add('visible');
        }

        window.closeModal = function(modalId) {
            // ... (same as original)
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('visible');
                if (modalId === 'add-shoe-modal') {
                    editingShoeId = null;
                    document.getElementById('add-edit-shoe-modal-title').textContent = 'إضافة حذاء جديد';
                    document.getElementById('save-shoe-button').textContent = 'حفظ الحذاء';
                    document.getElementById('add-shoe-form').reset();
                    const imagePreview = document.getElementById('image-preview-element');
                    imagePreview.style.display = 'none';
                    imagePreview.src = '#';
                    const geminiButton = document.getElementById('generate-description-button');
                    geminiButton.classList.remove('loading');
                    geminiButton.disabled = false;
                    geminiButton.querySelector('.gemini-loader').style.display = 'none';
                    geminiButton.querySelector('#button-text-node').textContent = '✨ إنشاء وصف بالذكاء الاصطناعي';

                } else if (modalId === 'edit-delivery-price-modal') {
                    currentEditingWilayaId = null;
                    document.getElementById('edit-delivery-price-form').reset();
                } else if (modalId === 'export-data-modal') {
                    document.getElementById('export-data-text').value = ''; 
                } else if (modalId === 'add-supplier-modal') {
                    editingSupplierId = null;
                    document.getElementById('add-supplier-form').reset(); 
                    document.getElementById('supplier-image-preview').style.display = 'none';
                    document.getElementById('supplier-image-preview').src = '#';
                    document.getElementById('add-edit-supplier-modal-title').textContent = 'إضافة مورد جديد';
                    document.getElementById('save-supplier-button').textContent = 'إضافة مورد';
                } else if (modalId === 'auth-modal') {
                    clearAuthError(); 
                    loginForm.reset();
                    signupForm.reset();
                }
            }
        }
        
        window.showToast = function(message, type = 'success') {
            // ... (same as original)
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            const toastIconEl = document.getElementById('toast-icon'); 
            toastMessage.textContent = message;
            toast.className = 'toast-notification'; 
            toast.classList.add(type); 
            if (type === 'success') {
                toastIconEl.innerHTML = '<i class="fas fa-check-circle"></i>';
            } else {
                toastIconEl.innerHTML = '<i class="fas fa-times-circle"></i>';
            }
            toast.classList.add('visible');
            setTimeout(() => {
                toast.classList.remove('visible');
            }, 3000); 
        }

        // --- Shoe Management (Dexie) ---
        window.openAddShoeModal = async function(shoeIdToEdit = null) { /* ... same as original ... */ 
            const form = document.getElementById('add-shoe-form');
            const modalTitle = document.getElementById('add-edit-shoe-modal-title');
            const saveButton = document.getElementById('save-shoe-button');
            const sizesContainer = document.getElementById('sizes-container');
            const shoeCategorySelect = document.getElementById('shoe-category');
            
            form.reset();
            document.getElementById('shoe-description').value = '';
            const imagePreview = document.getElementById('image-preview-element');
            imagePreview.style.display = 'none';
            imagePreview.src = '#';
            editingShoeId = shoeIdToEdit; 

            const existingPairs = sizesContainer.querySelectorAll('.size-quantity-pair');
            existingPairs.forEach(pair => pair.remove());

            if (shoeIdToEdit) {
                modalTitle.textContent = 'تعديل بيانات الحذاء';
                saveButton.textContent = 'حفظ التعديلات';
                try {
                    const shoeToEdit = await db.shoes.get(shoeIdToEdit);
                    if (shoeToEdit) {
                        document.getElementById('shoe-name').value = shoeToEdit.name;
                        shoeCategorySelect.value = shoeToEdit.category || "";
                        document.getElementById('shoe-purchase-price').value = shoeToEdit.purchasePrice || '';
                        document.getElementById('shoe-description').value = shoeToEdit.description || '';
                        if (shoeToEdit.imageUrl) {
                            imagePreview.src = shoeToEdit.imageUrl;
                            imagePreview.style.display = 'block';
                        }
                        if (shoeToEdit.sizes && shoeToEdit.sizes.length > 0) {
                            shoeToEdit.sizes.forEach(s => addSizeQuantityPair(s.size, s.quantity));
                        } else {
                             // If no sizes, add a default empty pair
                            addSizeQuantityPair('', ''); 
                        }
                    } else {
                         addSizeQuantityPair('', ''); 
                    }
                } catch (error) {
                    console.error("Error fetching shoe for edit:", error);
                    showToast('خطأ في جلب بيانات الحذاء للتعديل.', 'error');
                    addSizeQuantityPair('', '');
                }
            } else {
                modalTitle.textContent = 'إضافة حذاء جديد';
                saveButton.textContent = 'حفظ الحذاء';
                shoeCategorySelect.value = ""; 
                addSizeQuantityPair('', ''); 
            }
            
            const geminiButton = document.getElementById('generate-description-button');
            geminiButton.classList.remove('loading');
            geminiButton.disabled = false;
            geminiButton.querySelector('.gemini-loader').style.display = 'none';
            geminiButton.querySelector('#button-text-node').textContent = '✨ إنشاء وصف بالذكاء الاصطناعي';
            showModal('add-shoe-modal');
        }
        function addSizeQuantityPair(size = '', quantity = '') { /* ... same as original ... */ 
            const container = document.getElementById('sizes-container');
            const pairDiv = document.createElement('div');
            pairDiv.className = 'size-quantity-pair';
            const sizeInput = document.createElement('input');
            sizeInput.type = 'text';
            sizeInput.className = 'form-input shoe-size-input flex-grow';
            sizeInput.placeholder = 'المقاس (مثال: 40)'; 
            sizeInput.value = size; 
            sizeInput.required = true;
            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.className = 'form-input shoe-quantity-input w-24';
            quantityInput.placeholder = 'الكمية';
            quantityInput.min = '0';
            quantityInput.value = quantity; 
            quantityInput.required = true;
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-size-btn';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.onclick = function() {
                if (container.querySelectorAll('.size-quantity-pair').length > 1) {
                    pairDiv.remove();
                } else {
                    showToast('يجب إدخال مقاس وكمية واحدة على الأقل.', 'error');
                }
            };
            pairDiv.appendChild(sizeInput);
            pairDiv.appendChild(quantityInput);
            pairDiv.appendChild(removeBtn);
            container.appendChild(pairDiv);
        }
        async function generateShoeDescription() { /* ... same as original ... */ 
            const shoeName = document.getElementById('shoe-name').value;
            if (!shoeName) {
                showToast('يرجى إدخال اسم الحذاء أولاً للحصول على وصف.', 'error');
                return;
            }
            const generateButton = document.getElementById('generate-description-button');
            const loader = generateButton.querySelector('.gemini-loader');
            const buttonTextNode = generateButton.querySelector('#button-text-node');
            
            generateButton.disabled = true;
            generateButton.classList.add('loading');
            loader.style.display = 'inline-block';
            if (buttonTextNode) buttonTextNode.textContent = 'جاري الإنشاء... ';

                       let prompt = `أنشئ وصفًا تسويقيًا جذابًا وموجزًا لحذاء اسمه '${shoeName}'. ركز على الأناقة، الراحة، والجودة. اجعل الوصف باللغة العربية الفصحى.`;
            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                // تحذير: مفتاح API ظاهر هنا! هذا غير آمن للبيئات الإنتاجية.
                // يفضل استخدام خادم وسيط لإخفاء المفتاح.
                const apiKey = "AIzaSyAYS6gghLtXRgLnLFiHdF90CF17QfQ6CmM"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = `فشل الاتصال بـ Gemini API: ${response.status} ${response.statusText}. ${errorData?.error?.message || ''}`;
                    if (response.status === 400 && errorData?.error?.message?.toLowerCase().includes("api key not valid")) errorMessage = "مفتاح Gemini API غير صالح أو غير مفعل.";
                    else if (response.status === 403) errorMessage = "تم رفض الوصول بواسطة Gemini API. تحقق من صلاحيات المفتاح.";
                    else if (response.status === 429) errorMessage = "تم تجاوز حصة الاستخدام لـ Gemini API. يرجى المحاولة لاحقًا.";
                    throw new Error(errorMessage);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    document.getElementById('shoe-description').value = result.candidates[0].content.parts[0].text.trim();
                } else { throw new Error('لم يتم العثور على وصف في استجابة Gemini API.'); }
            } catch (error) {
                showToast(`خطأ في إنشاء الوصف: ${error.message}`, 'error');
                console.error("Gemini API error:", error);
            } finally {
                generateButton.disabled = false;
                generateButton.classList.remove('loading');
                loader.style.display = 'none';
                if (buttonTextNode) buttonTextNode.textContent = '✨ إنشاء وصف بالذكاء الاصطناعي';
            }
        }
        async function saveShoeData(event) { /* ... same as original ... */ 
            event.preventDefault();
            const shoeName = document.getElementById('shoe-name').value;
            const shoeCategory = document.getElementById('shoe-category').value;
            const shoeImageInput = document.getElementById('shoe-image');
            const purchasePrice = document.getElementById('shoe-purchase-price').value;
            const description = document.getElementById('shoe-description').value;
            const sizesQuantities = [];
            const sizePairElements = document.querySelectorAll('#sizes-container .size-quantity-pair');
            let validSizes = true;
            sizePairElements.forEach(pair => {
                const size = pair.querySelector('.shoe-size-input').value.trim(); 
                const quantity = parseInt(pair.querySelector('.shoe-quantity-input').value); 
                if (size && !isNaN(quantity) && quantity >= 0) {
                    sizesQuantities.push({ size, quantity });
                } else { validSizes = false; }
            });

            if (!shoeName.trim()) {
                showToast('اسم الحذاء مطلوب.', 'error'); return;
            }
            if (!validSizes || sizesQuantities.length === 0) {
                showToast('يرجى إدخال مقاس وكمية صالحة واحدة على الأقل.', 'error'); return;
            }

            let imageDataUrl = document.getElementById('image-preview-element').src;
            if (imageDataUrl === window.location.href + "#" || imageDataUrl === "#") { 
                 imageDataUrl = null;
            }

            const processSaving = async (imgUrl) => {
                const shoeData = {
                    name: shoeName,
                    category: shoeCategory || 'الكل', 
                    imageUrl: imgUrl, 
                    sizes: sizesQuantities,
                    purchasePrice: purchasePrice ? parseFloat(purchasePrice) : null,
                    description: description,
                };

                try {
                    await db.open();
                    if (editingShoeId) { 
                        shoeData.id = editingShoeId;
                        const existingShoe = await db.shoes.get(editingShoeId);
                        shoeData.addedDate = existingShoe ? existingShoe.addedDate : new Date().toISOString();
                        await db.shoes.put(shoeData); 
                        showToast(`تم تحديث بيانات الحذاء "${shoeName}" بنجاح.`);
                    } else { 
                        shoeData.id = Date.now().toString(); 
                        shoeData.addedDate = new Date().toISOString();
                        await db.shoes.add(shoeData);
                        showToast(`تم حفظ الحذاء "${shoeName}" بنجاح.`);
                    }
                    editingShoeId = null; 
                    closeModal('add-shoe-modal');
                    // Refresh relevant views after shoe data is saved
                    if (!document.getElementById('inventory-view-content').classList.contains('hidden')) {
                        displayAllShoes(currentShoeFilter); 
                    }
                    if (!document.getElementById('daily-sales-confirmation-view-content').classList.contains('hidden')) {
                        displayPendingSales();
                    }
                    if (!document.getElementById('stats-view-content').classList.contains('hidden')) {
                        displayStockAlerts('stock-alerts-list-area-stats', 'stock-alert-threshold-stats');
                    }

                } catch (error) {
                    console.error("Failed to save shoe to Dexie:", error);
                    showToast('فشل حفظ الحذاء. تحقق من الكونسول.', 'error');
                }
            };

            if (shoeImageInput.files && shoeImageInput.files[0]) {
                const file = shoeImageInput.files[0];
                if (!file.type.startsWith('image/')){ showToast('يرجى اختيار ملف صورة صالح.', 'error'); return; }
                if (file.size > 2 * 1024 * 1024) { showToast('حجم الصورة كبير جدًا (الحد الأقصى 2MB).', 'error'); return; }
                const reader = new FileReader();
                reader.onload = e => { processSaving(e.target.result); }
                reader.onerror = () => { showToast('خطأ في قراءة الصورة.', 'error'); processSaving(imageDataUrl); } 
                reader.readAsDataURL(file);
            } else {
                processSaving(imageDataUrl); 
            }
        }
// (استبدال) --- دالة عرض المخزون مع ترقيم الصفحات ---
async function displayAllShoes(filterCategory = 'all', page = 1) {
    currentShoeFilter = filterCategory;
    const shoesPerPage = 12; // يمكنك تغيير هذا الرقم (مثلاً 10 أو 20)
    const displayArea = document.getElementById('shoe-display-area');

    try {
        await db.open();
        let query;

        // بناء الاستعلام حسب التصنيف
        if (filterCategory !== 'all') {
            query = db.shoes.where('category').equals(filterCategory);
        } else {
            query = db.shoes.toCollection();
        }

        // الحصول على العدد الإجمالي للنتائج لحساب الصفحات
        const totalShoes = await query.count();
        const totalPages = Math.ceil(totalShoes / shoesPerPage);

        // جلب بيانات الصفحة الحالية فقط باستخدام offset و limit
        const shoesArray = await query.reverse() // لعرض الأحدث أولاً
                                      .offset((page - 1) * shoesPerPage)
                                      .limit(shoesPerPage)
                                      .toArray();

        displayArea.innerHTML = ''; // مسح المحتوى القديم

        if (shoesArray.length === 0) {
            displayArea.innerHTML = `<p class="text-center text-gray-500 mt-6 text-lg">لا توجد أحذية تطابق هذا التصنيف "${filterCategory === 'all' ? 'الكل' : filterCategory}".</p>`;
        } else {
            const listContainer = document.createElement('div');
            listContainer.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-4';
            shoesArray.forEach(shoe => {
                const card = document.createElement('div');
                card.className = 'shoe-card';
                card.onclick = () => openShoeDetailsModal(shoe.id);

                let imageHTML = `<div class="shoe-card-image-container"><span class="no-image-text">لا توجد صورة</span></div>`;
                if (shoe.imageUrl) {
                    imageHTML = `<div class="shoe-card-image-container"><img src="${shoe.imageUrl}" alt="${shoe.name}"></div>`;
                }

                card.innerHTML = `
                    ${imageHTML}
                    <h4 title="${shoe.name}">${shoe.name}</h4>
                    <p class="text-xs text-gray-500">${shoe.category || 'غير مصنف'}</p>
                    <p class="date-added">أضيف في: ${new Date(shoe.addedDate).toLocaleDateString('ar-EG', {day: 'numeric', month: 'short', year: 'numeric', numberingSystem: 'latn'})}</p>
                    <p class="sizes-info">
                        <span class="font-medium">المقاسات: </span>
                        <span class="text-gray-600">${shoe.sizes.map(s => `${s.size} (${s.quantity})`).join(', ') || 'N/A'}</span>
                    </p>
                    <div class="shoe-card-actions">
                         <button onclick="event.stopPropagation(); openAddShoeModal('${shoe.id}')" class="app-button edit-btn"><i class="fas fa-edit mr-1.5"></i> تعديل</button>
                         <button onclick="event.stopPropagation(); confirmDeleteShoe('${shoe.id}')" class="app-button delete-btn"><i class="fas fa-trash-alt mr-1.5"></i> حذف</button>
                    </div>
                `;
                listContainer.appendChild(card);
            });
            displayArea.appendChild(listContainer);

            // ▼▼▼ بداية إضافة أزرار التنقل بين الصفحات ▼▼▼
            if (totalPages > 1) {
                const paginationContainer = document.createElement('div');
                paginationContainer.className = 'flex justify-center items-center gap-3 mt-8';

                // زر "السابق"
                if (page > 1) {
                    const prevButton = document.createElement('button');
                    prevButton.className = 'app-button app-button-secondary';
                    prevButton.innerHTML = '<i class="fas fa-arrow-right ml-2"></i> السابق';
                    prevButton.onclick = () => displayAllShoes(filterCategory, page - 1);
                    paginationContainer.appendChild(prevButton);
                }

                // عرض رقم الصفحة الحالية
                const pageInfo = document.createElement('span');
                pageInfo.className = 'font-semibold text-text-color-secondary';
                pageInfo.textContent = `صفحة ${page} من ${totalPages}`;
                paginationContainer.appendChild(pageInfo);

                // زر "التالي"
                if (page < totalPages) {
                    const nextButton = document.createElement('button');
                    nextButton.className = 'app-button app-button-secondary';
                    nextButton.innerHTML = 'التالي <i class="fas fa-arrow-left mr-2"></i>';
                    nextButton.onclick = () => displayAllShoes(filterCategory, page + 1);
                    paginationContainer.appendChild(nextButton);
                }
                displayArea.appendChild(paginationContainer);
            }
            // ▲▲▲ نهاية إضافة أزرار التنقل بين الصفحات ▲▲▲
        }

        // تحديث أزرار الفلترة
        document.querySelectorAll('#shoe-filter-buttons .filter-button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.category === filterCategory) {
                btn.classList.add('active');
            }
        });
    } catch (error) {
        console.error("Error displaying shoes from Dexie:", error);
        showToast('خطأ في عرض الأحذية.', 'error');
    }
}
        window.openShoeDetailsModal = async function(shoeId) { /* ... same as original ... */ 
            try {
                await db.open();
                const shoe = await db.shoes.get(shoeId);
                if (!shoe) {
                    showToast('لم يتم العثور على الحذاء المحدد.', 'error');
                    return;
                }
                document.getElementById('details-shoe-name').textContent = shoe.name;
                const detailsImage = document.getElementById('details-shoe-image');
                if (shoe.imageUrl) {
                    detailsImage.src = shoe.imageUrl;
                    detailsImage.alt = shoe.name;
                    detailsImage.style.display = 'block';
                } else {
                    detailsImage.style.display = 'none';
                }
                document.getElementById('details-shoe-category').textContent = shoe.category || 'غير محدد';
                const sizesContainer = document.getElementById('details-shoe-sizes');
                sizesContainer.innerHTML = ''; 
                if (shoe.sizes && shoe.sizes.length > 0) {
                    const ul = document.createElement('ul');
                    ul.className = 'list-none p-0'; 
                    shoe.sizes.forEach(s => {
                        const li = document.createElement('li');
                        li.className = 'py-1.5 border-b border-border-color'; 
                        li.innerHTML = `مقاس <strong class="text-primary-color">${s.size}</strong>: ${s.quantity} قطعة متوفرة`; 
                        ul.appendChild(li);
                    });
                    sizesContainer.appendChild(ul);
                } else {
                    sizesContainer.textContent = 'لا توجد تفاصيل مقاسات لهذا الحذاء.';
                }
                document.getElementById('details-shoe-purchase-price').textContent = shoe.purchasePrice ? `${shoe.purchasePrice} دج` : 'لم يحدد سعر الشراء';
                document.getElementById('details-shoe-description').textContent = shoe.description || 'لا يوجد وصف لهذا الحذاء.';
                showModal('shoe-details-modal');
            } catch (error) {
                console.error("Error opening shoe details modal:", error);
                showToast('خطأ في عرض تفاصيل الحذاء.', 'error');
            }
        }
        window.confirmDeleteShoe = async function(shoeId) { /* ... same as original ... */ 
            showModal('message-modal', `هل أنت متأكد أنك تريد حذف هذا الحذاء؟ هذا الإجراء لا يمكن التراجع عنه.`);
            const messageModalButtons = document.getElementById('message-modal-buttons');
            messageModalButtons.innerHTML = `
                <button onclick="closeModal('message-modal')" class="app-button app-button-secondary">إلغاء</button>
                <button id="confirm-action-btn" class="app-button app-button-danger">نعم، حذف</button>
            `;
            document.getElementById('confirm-action-btn').onclick = async () => {
                try {
                    await db.open();
                    await db.shoes.delete(shoeId);
                    if (!document.getElementById('inventory-view-content').classList.contains('hidden')) {
                        displayAllShoes(currentShoeFilter); 
                    }
                    closeModal('message-modal'); 
                    showToast('تم حذف الحذاء بنجاح.'); 
                } catch (error) {
                    console.error("Error deleting shoe from Dexie:", error);
                    showToast('فشل حذف الحذاء.', 'error');
                    closeModal('message-modal');
                }
            };
        }

        // --- Sales Management (Dexie) ---
        window.openSellShoeModal = async function() { /* ... same as original ... */ 
            const shoeSelect = document.getElementById('sell-shoe-select');
            const sizeSelect = document.getElementById('sell-shoe-size-select');
            const availableQuantityText = document.getElementById('sell-available-quantity');

            document.getElementById('sell-shoe-form').reset(); 
            shoeSelect.innerHTML = '<option value="">-- اختر حذاء --</option>'; 
            sizeSelect.innerHTML = '<option value="">-- اختر مقاس --</option>';
            sizeSelect.disabled = true;
            availableQuantityText.textContent = 'الكمية المتوفرة: -';
            document.getElementById('sell-quantity').value = 1;
            document.getElementById('sell-date').valueAsDate = new Date();

            try {
                await db.open();
                const shoes = await db.shoes.toArray();
                shoes.forEach(shoe => {
                    if (shoe.sizes && shoe.sizes.some(s => s.quantity > 0)) { 
                        const option = document.createElement('option');
                        option.value = shoe.id;
                        option.textContent = shoe.name;
                        shoeSelect.appendChild(option);
                    }
                });
            } catch (error) {
                console.error("Error populating sell shoe modal:", error);
                showToast('خطأ في تحميل الأحذية.', 'error');
            }

            shoeSelect.onchange = async function() {
                const selectedShoeId = this.value;
                sizeSelect.innerHTML = '<option value="">-- اختر مقاس --</option>';
                sizeSelect.disabled = true;
                availableQuantityText.textContent = 'الكمية المتوفرة: -';
                document.getElementById('sell-quantity').value = 1; 
                if (!selectedShoeId) return;

                try {
                    await db.open();
                    const selectedShoe = await db.shoes.get(selectedShoeId);
                    if (selectedShoe && selectedShoe.sizes) {
                        selectedShoe.sizes.forEach(sizeInfo => {
                            if (sizeInfo.quantity > 0) {
                                const sizeOption = document.createElement('option');
                                sizeOption.value = sizeInfo.size;
                                sizeOption.textContent = `${sizeInfo.size} (متوفر: ${sizeInfo.quantity})`;
                                sizeOption.dataset.available = sizeInfo.quantity; 
                                sizeSelect.appendChild(sizeOption);
                            }
                        });
                        sizeSelect.disabled = false;
                        if (sizeSelect.options.length === 2) { 
                            sizeSelect.selectedIndex = 1;
                            sizeSelect.dispatchEvent(new Event('change'));
                        }
                    }
                } catch (error) {
                    console.error("Error fetching shoe sizes for sale:", error);
                    showToast('خطأ في تحميل مقاسات الحذاء.', 'error');
                }
            };
            
            sizeSelect.onchange = function() {
                const selectedSizeOption = this.options[this.selectedIndex];
                if (selectedSizeOption && selectedSizeOption.dataset.available) {
                    availableQuantityText.textContent = `الكمية المتوفرة: ${selectedSizeOption.dataset.available}`;
                    document.getElementById('sell-quantity').max = selectedSizeOption.dataset.available;
                    document.getElementById('sell-quantity').value = 1; 
                } else {
                    availableQuantityText.textContent = 'الكمية المتوفرة: -';
                    document.getElementById('sell-quantity').max = '';
                }
            };
            showModal('sell-shoe-modal');
        }
document.getElementById('sell-shoe-form').addEventListener('submit', async function(event) {
    event.preventDefault();
    const customerName = document.getElementById('sell-customer-name').value.trim();
    const customerAddress = document.getElementById('sell-customer-address').value.trim();
    const customerPhone = document.getElementById('sell-customer-phone').value.trim();
    const shoeId = document.getElementById('sell-shoe-select').value;
    const shoeName = document.getElementById('sell-shoe-select').options[document.getElementById('sell-shoe-select').selectedIndex]?.text;
    const size = document.getElementById('sell-shoe-size-select').value;
    const quantitySold = parseInt(document.getElementById('sell-quantity').value);
    const sellPrice = parseFloat(document.getElementById('sell-price').value);
    const sellDate = document.getElementById('sell-date').value;
    const notes = document.getElementById('sell-notes').value;
    
    // ▼▼▼ بداية التعديل: قراءة سعر الشحن ▼▼▼
    const shippingPrice = parseFloat(document.getElementById('sell-shipping-price').value) || 0;
    // ▲▲▲ نهاية التعديل ▲▲▲

    if (!shoeId || !size || isNaN(quantitySold) || quantitySold <= 0 || isNaN(sellPrice) || sellPrice < 0 || !sellDate) {
        showToast('يرجى ملء جميع حقول البيع المطلوبة بشكل صحيح.', 'error');
        return;
    }
    if (customerPhone && !/^\d{8,15}$/.test(customerPhone)) {
         showToast('يرجى إدخال رقم هاتف صحيح للمشتري أو تركه فارغًا.', 'error');
        return;
    }
    
    const saleMonthYear = new Date(sellDate).toISOString().slice(0, 7); 

    try {
        await db.open();
        const shoeToSell = await db.shoes.get(shoeId);
        if (!shoeToSell) {
            showToast('لم يتم العثور على الحذاء المحدد.', 'error'); return;
        }
        const sizeIndex = shoeToSell.sizes.findIndex(s => s.size === size);
        if (sizeIndex === -1 || shoeToSell.sizes[sizeIndex].quantity < quantitySold) {
            showToast(`الكمية المطلوبة (${quantitySold}) لمقاس ${size} غير متوفرة.`, 'error'); return;
        }

        const newSizes = [...shoeToSell.sizes];
        newSizes[sizeIndex].quantity -= quantitySold;
        await db.shoes.update(shoeId, { sizes: newSizes });

        const pendingSale = {
            id: `pending_${Date.now()}`, 
            shoeId, shoeName, shoeImage: shoeToSell.imageUrl,
            size, quantitySold, sellPrice, sellDate, notes,
            customerName, customerAddress, customerPhone,
            shippingConfirmed: false,
            saleMonthYear: saleMonthYear,
            // ▼▼▼ بداية التعديل: إضافة سعر الشحن للبيانات ▼▼▼
            shippingPrice: shippingPrice
            // ▲▲▲ نهاية التعديل ▲▲▲
        };

        await db.pendingSales.add(pendingSale);

        showToast('أُضيفت البيعة للتأكيد. الكمية خُصمت من المخزون.');
        closeModal('sell-shoe-modal');
        if (!document.getElementById('daily-sales-confirmation-view-content').classList.contains('hidden')) {
             displayPendingSales();
        }
    } catch (error) {
        console.error("Error processing sale with Dexie:", error);
        showToast('فشل تسجيل البيع. تحقق من الكونسول.', 'error');
    }
});
// (الكود النهائي الصحيح)
// (الكود النهائي والأكثر استقرارًا)
// =================== ابدأ النسخ من هنا ===================

// (الكود النهائي الكامل لهذه الميزة)
// (استبدال) --- دالة عرض المبيعات المعلقة مع ترقيم الصفحات ---
// (الكود النهائي المصحح) --- دالة عرض المبيعات المعلقة مع ترقيم الصفحات ---
// (الكود النهائي المصحح والأكثر استقرارًا)
async function displayPendingSales(options = {}, page = 1) {
    const { dateFilter = null } = options;
    const salesPerPage = 10;
    const pendingSalesArea = document.getElementById('pending-sales-area');
    pendingSalesArea.innerHTML = '<div class="text-center py-10"><div class="loader mx-auto"></div></div>';

    try {
        await db.open();

        // --- بداية الإصلاح الرئيسي ---

        // خطوة 1: جلب كل البيانات المعلقة مرة واحدة لتجنب أخطاء قاعدة البيانات
        const allPendingSales = await db.pendingSales.toArray();
        let salesToFilter = allPendingSales;

        // خطوة 2: تطبيق الفلترة المطلوبة بأمان باستخدام JavaScript
        if (dateFilter) {
            salesToFilter = allPendingSales.filter(sale => sale.shippingConfirmed === true && sale.sellDate === dateFilter);
        } else {
            if (currentPendingSaleFilter === 'pending') {
                // هذا الشرط يغطي الحالات التي تكون فيها القيمة false أو غير موجودة (undefined)
                salesToFilter = allPendingSales.filter(sale => !sale.shippingConfirmed);
            } else if (currentPendingSaleFilter === 'shipped') {
                salesToFilter = allPendingSales.filter(sale => sale.shippingConfirmed === true);
            }
            // إذا كان الفلتر 'all'، فإن salesToFilter تبقى كل البيانات، وهو المطلوب
        }

        // خطوة 3: ترتيب النتائج وتطبيق الترقيم عليها
        salesToFilter.sort((a, b) => new Date(b.sellDate) - new Date(a.sellDate));

        const totalSales = salesToFilter.length;
        const totalPages = Math.ceil(totalSales / salesPerPage);
        const startIndex = (page - 1) * salesPerPage;
        const salesToDisplay = salesToFilter.slice(startIndex, startIndex + salesPerPage);

        // --- نهاية الإصلاح الرئيسي ---


        pendingSalesArea.innerHTML = ''; // مسح مؤشر التحميل

        if (salesToDisplay.length === 0) {
            let message = "لا توجد مبيعات تطابق هذا الفلتر.";
            if (dateFilter) { message = `لا توجد مبيعات مشحونة للتاريخ المحدد: ${dateFilter}`; }
            else {
                if (currentPendingSaleFilter === 'pending') message = "لا توجد عمليات معلقة.";
                else if (currentPendingSaleFilter === 'shipped') message = "لا توجد عمليات تم تأكيد شحنها.";
                else if (currentPendingSaleFilter === 'all') message = "لا توجد مبيعات معلقة حاليًا.";
            }
            pendingSalesArea.innerHTML = `<p class="text-center text-gray-500 mt-6 text-lg">${message}</p>`;
            return;
        }

        const shoesMap = new Map((await db.shoes.toArray()).map(shoe => [shoe.id, shoe]));

        salesToDisplay.forEach(sale => {
            const card = document.createElement('div');
            card.className = 'data-card pending-sale-card p-4 mb-4';
            if (sale.shippingConfirmed) { card.classList.add('shipped'); }
            const correspondingShoe = shoesMap.get(sale.shoeId);
            const imageToDisplay = sale.shoeImage || (correspondingShoe ? correspondingShoe.imageUrl : null);
            let imageHTML = `<div class="w-24 h-24 bg-gray-200 rounded-md mb-3 flex items-center justify-center text-gray-400 text-sm shrink-0">لا توجد صورة</div>`;
            if (imageToDisplay) {
                imageHTML = `<div class="w-24 h-24 rounded-md mb-3 overflow-hidden flex items-center justify-center shrink-0"><img src="${imageToDisplay}" alt="${sale.shoeName}" class="w-full h-full object-cover"></div>`;
            }
            const shippingButtonText = sale.shippingConfirmed ? 'تم تأكيد الشحن' : 'تأكيد الشحن';
            const shippingButtonDisabled = sale.shippingConfirmed ? 'disabled' : '';
            const shippingButtonClasses = sale.shippingConfirmed ? 'app-button app-button-shipping shipped-confirmed' : 'app-button app-button-shipping';
            const shoeTotal = sale.quantitySold * sale.sellPrice;
            let shippingInfoHTML = '';
            if (sale.shippingPrice && sale.shippingPrice > 0) {
                const grandTotal = shoeTotal + sale.shippingPrice;
                shippingInfoHTML = `
                    <p><strong>سعر الشحن:</strong> <span class="text-blue-600 font-semibold">${sale.shippingPrice.toFixed(2)} دج</span></p>
                    <p class="font-bold border-t border-gray-400/50 pt-1 mt-1"><strong>الإجمالي مع الشحن:</strong> <span class="text-primary-color">${grandTotal.toFixed(2)} دج</span></p>
                `;
            }

            card.innerHTML = `
                <div class="flex gap-4 items-start">
                    ${imageHTML}
                    <div class="flex-grow">
                        <h5>${sale.shoeName} - مقاس ${sale.size}</h5>
                        <p><strong>الكمية للبيع:</strong> ${sale.quantitySold}</p>
                        <p><strong>سعر الحذاء الإجمالي:</strong> ${shoeTotal.toFixed(2)} دج</p>
                        ${shippingInfoHTML} 
                        <div class="mt-2 pt-2 border-t border-gray-400/20">
                            <p class="text-xs"><strong>المشتري:</strong> ${sale.customerName || 'غير محدد'} (${sale.customerPhone || 'لا يوجد هاتف'})</p>
                            <p class="text-xs"><strong>العنوان:</strong> ${sale.customerAddress || 'غير محدد'}</p>
                            ${sale.notes ? `<p class="text-xs mt-1 notes-sub-card"><strong>ملاحظات:</strong> ${sale.notes}</p>` : ''}
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex justify-end gap-3 pending-sale-actions">
                    <button data-action="confirm-sale" data-id="${sale.id}" class="app-button bg-green-500 hover:bg-green-600 text-white">تأكيد البيع</button>
                    <button data-action="confirm-shipping" data-id="${sale.id}" class="${shippingButtonClasses}" ${shippingButtonDisabled}>${shippingButtonText}</button>
                    <button data-action="cancel-sale" data-id="${sale.id}" class="app-button bg-red-500 hover:bg-red-600 text-white">إلغاء البيع</button>
                </div>
            `;
            pendingSalesArea.appendChild(card);
        });

        // إضافة أزرار التنقل بين الصفحات
        if (totalPages > 1) {
            const paginationContainer = document.createElement('div');
            paginationContainer.className = 'flex justify-center items-center gap-3 mt-8';
            if (page > 1) {
                const prevButton = document.createElement('button');
                prevButton.className = 'app-button app-button-secondary';
                prevButton.innerHTML = '<i class="fas fa-arrow-right ml-2"></i> السابق';
                prevButton.onclick = () => displayPendingSales(options, page - 1);
                paginationContainer.appendChild(prevButton);
            }
            const pageInfo = document.createElement('span');
            pageInfo.className = 'font-semibold text-text-color-secondary';
            pageInfo.textContent = `صفحة ${page} من ${totalPages}`;
            paginationContainer.appendChild(pageInfo);
            if (page < totalPages) {
                const nextButton = document.createElement('button');
                nextButton.className = 'app-button app-button-secondary';
                nextButton.innerHTML = 'التالي <i class="fas fa-arrow-left mr-2"></i>';
                nextButton.onclick = () => displayPendingSales(options, page + 1);
                paginationContainer.appendChild(nextButton);
            }
            pendingSalesArea.appendChild(paginationContainer);
        }

    } catch (error) {
        console.error("Error displaying pending sales:", error);
        showToast('خطأ في عرض المبيعات المعلقة.', 'error');
        pendingSalesArea.innerHTML = `<p class="text-center text-red-500 mt-6 text-lg">حدث خطأ حرج. يرجى إعادة تحميل الصفحة.</p>`;
    }
}

async function confirmShipping(pendingSaleId) {
    try {
        await db.open();
        const updatedCount = await db.pendingSales.update(pendingSaleId, { shippingConfirmed: true });
        if (updatedCount) {
            displayPendingSales();
            const sale = await db.pendingSales.get(pendingSaleId);
            showToast(`تم تأكيد شحن الطلب الخاص بـ "${sale.shoeName}".`);
        } else {
            showToast('لم يتم العثور على البيع المعلق لتحديث حالة الشحن.', 'error');
        }
    } catch (error) {
        console.error("Error confirming shipping:", error);
        showToast('خطأ أثناء تأكيد الشحن.', 'error');
    }
}

async function confirmSale(pendingSaleId) {
    try {
        await db.open();
        const saleToConfirm = await db.pendingSales.get(pendingSaleId);
        if (!saleToConfirm) {
            showToast('لم يتم العثور على البيع المعلق.', 'error');
            return;
        }
        const confirmedSale = {
            shoeId: saleToConfirm.shoeId, shoeName: saleToConfirm.shoeName,
            size: saleToConfirm.size, quantity: saleToConfirm.quantitySold,
            price: saleToConfirm.sellPrice, total: saleToConfirm.quantitySold * saleToConfirm.sellPrice,
            date: saleToConfirm.sellDate, notes: saleToConfirm.notes,
            customerName: saleToConfirm.customerName, customerAddress: saleToConfirm.customerAddress,
            customerPhone: saleToConfirm.customerPhone, shippingConfirmed: saleToConfirm.shippingConfirmed,
            saleMonthYear: saleToConfirm.sellDate.slice(0, 7)
        };
        await db.sales.add(confirmedSale);
        await db.pendingSales.delete(pendingSaleId);
        showToast(`تم تأكيد بيع "${saleToConfirm.shoeName}" بنجاح.`);
        displayPendingSales();
        if (!document.getElementById('inventory-view-content').classList.contains('hidden')) displayAllShoes(currentShoeFilter);
        if (!document.getElementById('stats-view-content').classList.contains('hidden')) displayStats();
    } catch (error) {
        console.error("Error confirming sale with Dexie:", error);
        showToast('فشل تأكيد البيع.', 'error');
    }
}

async function cancelPendingSale(pendingSaleId) {
    try {
        await db.open();
        const saleToCancel = await db.pendingSales.get(pendingSaleId);
        if (!saleToCancel) {
            showToast('لم يتم العثور على البيع المعلق للإلغاء.', 'error');
            return;
        }
        const shoeToUpdate = await db.shoes.get(saleToCancel.shoeId);
        if (shoeToUpdate) {
            const sizeIndex = shoeToUpdate.sizes.findIndex(sz => sz.size === saleToCancel.size);
            if (sizeIndex > -1) {
                const newSizes = [...shoeToUpdate.sizes];
                newSizes[sizeIndex].quantity += saleToCancel.quantitySold;
                await db.shoes.update(saleToCancel.shoeId, { sizes: newSizes });
            } else {
                showToast('خطأ: لم يتم العثور على المقاس في المخزون لإرجاع الكمية.', 'error');
            }
        } else {
            showToast('خطأ: لم يتم العثور على الحذاء في المخزون لإرجاع الكمية.', 'error');
        }
        await db.pendingSales.delete(pendingSaleId);
        showToast('تم إلغاء البيع المعلق وإرجاع الكمية للمخزون.');
        displayPendingSales();
        if (!document.getElementById('inventory-view-content').classList.contains('hidden')) displayAllShoes(currentShoeFilter);
        if (!document.getElementById('stats-view-content').classList.contains('hidden')) displayStats();
    } catch (error) {
        console.error("Error cancelling pending sale with Dexie:", error);
        showToast('فشل إلغاء البيع المعلق.', 'error');
    }
}

document.getElementById('pending-sales-area').addEventListener('click', function(event) {
    const button = event.target.closest('button[data-action]');
    if (!button) return;
    const action = button.dataset.action;
    const saleId = button.dataset.id;
    if (action === 'confirm-sale') {
        confirmSale(saleId);
    } else if (action === 'confirm-shipping') {
        if (!button.disabled) {
            confirmShipping(saleId);
        }
    } else if (action === 'cancel-sale') {
        cancelPendingSale(saleId);
    }
});

// ==========================================================
//  (لصق الكود التالي هنا لإصلاح صفحة الإحصائيات)
// ==========================================================

// --- Statistics Display (Dexie) ---
async function displayStats() { 
    try {
        await db.open();
        const shoes = await db.shoes.toArray();
        const sales = await db.sales.toArray();
        const statsSummaryContainer = document.getElementById('stats-summary-cards');

        statsSummaryContainer.innerHTML = ''; 

        const totalShoeTypes = shoes.length;
        let totalIndividualShoes = 0;
        shoes.forEach(shoe => {
            shoe.sizes.forEach(s => totalIndividualShoes += s.quantity);
        });
        const totalSalesTransactions = sales.length;
        let totalSalesValue = 0;
        sales.forEach(sale => totalSalesValue += sale.total);

        const stats = [
            { label: 'أنواع الأحذية', value: totalShoeTypes, icon: 'fa-shoe-prints' },
            { label: 'إجمالي القطع المتوفرة', value: totalIndividualShoes, icon: 'fa-boxes-stacked' },
            { label: 'إجمالي المبيعات (عمليات)', value: totalSalesTransactions, icon: 'fa-receipt' },
            { label: 'إجمالي قيمة المبيعات', value: `${totalSalesValue.toFixed(2)} دج`, icon: 'fa-coins' }
        ];

        stats.forEach(stat => {
            const statCard = document.createElement('div');
            statCard.className = 'stat-item';
            statCard.innerHTML = `
                <span class="stat-item-value"><i class="fas ${stat.icon} text-primary-color mr-2 opacity-75"></i> ${stat.value}</span>
                <span class="stat-item-label">${stat.label}</span>
            `;
            statsSummaryContainer.appendChild(statCard);
        });
        
        await displayCurrentMonthReport(); 
        await displayDetailedMonthlyReport();
    } catch (error) {
        console.error("Error displaying stats from Dexie:", error);
        showToast('خطأ في عرض الإحصائيات.', 'error');
    }
}

async function displayCurrentMonthReport() {
    const monthlyReportArea = document.getElementById('monthly-sales-display-area-stats');
    monthlyReportArea.innerHTML = '';
    
    const now = new Date();
    const currentMonthYear = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
const currentMonthName = now.toLocaleString('ar-EG', { month: 'long', year: 'numeric', numberingSystem: 'latn' });

    try {
        await db.open();
        const currentMonthSales = await db.sales.where('saleMonthYear').equals(currentMonthYear).toArray();
        const currentMonthReturns = await db.returns.where('returnMonthYear').equals(currentMonthYear).toArray();

        const totalSalesThisMonth = currentMonthSales.length;
        const totalValueThisMonth = currentMonthSales.reduce((sum, sale) => sum + sale.total, 0);
        const totalReturnsThisMonth = currentMonthReturns.length;

        let monthRank = "متوسط";
        if (totalSalesThisMonth > 15) monthRank = "جيد";
        if (totalSalesThisMonth > 25) monthRank = "جيد جدًا";
        if (totalSalesThisMonth > 40) monthRank = "ممتاز";
        if (totalSalesThisMonth < 5) monthRank = "ضعيف";

        const reportCard = document.createElement('div');
        reportCard.className = 'data-card';
        reportCard.innerHTML = `
            <h5>تقرير شهر ${currentMonthName} (الحالي)</h5>
            <p><strong>إجمالي المبيعات (عمليات):</strong> ${totalSalesThisMonth}</p>
            <p><strong>إجمالي قيمة المبيعات:</strong> <span class="font-bold text-success-color">${totalValueThisMonth.toFixed(2)} دج</span></p>
            <p><strong>إجمالي المرتجعات:</strong> ${totalReturnsThisMonth}</p>
            <p><strong>رتبة الشهر:</strong> <span class="font-semibold">${monthRank}</span></p>
        `;
        monthlyReportArea.appendChild(reportCard);

    } catch (error) {
        console.error("Error displaying current month report:", error);
        monthlyReportArea.innerHTML = '<p class="text-center text-error-color">خطأ في تحميل تقرير الشهر الحالي.</p>';
    }
}

// =================== انتهى النسخ هنا ===================
        
        // --- AI Assistant ---
        async function generateAppDataSummary() { /* ... same as original ... */ 
            try {
                await db.open();
                const shoes = await db.shoes.toArray();
                const sales = await db.sales.toArray();
                const returns = await db.returns.toArray();
                const pendingSales = await db.pendingSales.toArray();

                let summary = "ملخص بيانات التطبيق الحالية:\n";
                summary += `- إجمالي أنواع الأحذية: ${shoes.length}\n`;
                let totalStockQuantity = 0;
                shoes.forEach(shoe => shoe.sizes.forEach(s => totalStockQuantity += s.quantity));
                summary += `- إجمالي قطع الأحذية في المخزون: ${totalStockQuantity}\n`;
                summary += `- إجمالي عمليات البيع المؤكدة: ${sales.length}\n`;
                let totalSalesValue = 0;
                sales.forEach(sale => totalSalesValue += sale.total);
                summary += `- إجمالي قيمة المبيعات المؤكدة: ${totalSalesValue.toFixed(2)} دج\n`;
                summary += `- إجمالي عمليات الإرجاع: ${returns.length}\n`;
                summary += `- عدد المبيعات المعلقة للتأكيد: ${pendingSales.length}\n`;

                if (shoes.length > 0) {
                    summary += "\nآخر 3 أحذية تمت إضافتها:\n";
                    shoes.slice(-3).reverse().forEach(shoe => {
                        summary += `  - ${shoe.name} (أضيف في: ${new Date(shoe.addedDate).toLocaleDateString('ar-EG')})\n`;
                    });
                }
                if (sales.length > 0) {
                    summary += "\nآخر 3 عمليات بيع مؤكدة:\n";
                    sales.slice(-3).reverse().forEach(sale => {
                         summary += `  - ${sale.quantity} قطعة من ${sale.shoeName} (مقاس ${sale.size}) بسعر إجمالي ${sale.total.toFixed(2)} دج\n`;
                    });
                }
                return summary;
            } catch (error) {
                console.error("Error generating app data summary for AI:", error);
                return "خطأ في توليد ملخص البيانات.";
            }
        }
        const appendChatMessage = (message, sender) => { /* ... same as original ... */ 
            const chatArea = document.getElementById('ai-chat-area');
            if (!chatArea) { console.error("Chat area not found"); return; } 
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', sender);
            
            const senderSpan = document.createElement('span');
            senderSpan.classList.add('sender');
            senderSpan.textContent = sender === 'user' ? 'أنت' : 'المساعد الذكي AI';
            
            messageDiv.appendChild(senderSpan);
            messageDiv.append(document.createTextNode(message)); 
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight; 
        };
        const getAISalesAdvice = async () => { 
            const analyzeButton = document.getElementById('ai-analysis-option-button'); 
            const responseArea = document.getElementById('ai-sales-advisor-response-area');
            
            if (!analyzeButton || !responseArea) {
                console.error("Missing elements for AI Sales Advice.");
                return;
            }
            
            const loadingIndicatorContainer = document.getElementById('ai-analysis-interface'); 

            analyzeButton.disabled = true;
            analyzeButton.classList.add('opacity-50', 'cursor-not-allowed');
            responseArea.innerHTML = '<div class="flex items-center justify-center text-text-color-secondary py-10"><div class="gemini-loader mr-3 border-primary-color"></div> جاري التحليل العميق...</div>';
            if(loadingIndicatorContainer) loadingIndicatorContainer.classList.remove('hidden');

            const appDataSummary = await generateAppDataSummary(); 
            const prompt = `بصفتك خبيرًا استراتيجيًا في مبيعات التجزئة ومتخصصًا في الأحذية، قم بتحليل بيانات المتجر التالية بدقة. قدم استنتاجات رئيسية، وحدد الفرص الكامنة، واقترح توصيات عملية ومبتكرة لزيادة الإيرادات، تحسين دوران المخزون، وتعزيز رضا العملاء. كن محددًا في اقتراحاتك. البيانات: \n${appDataSummary}\n\n قدم نصيحتك باللغة العربية في شكل نقاط واضحة ومفصلة.`;
            
            try {
                let currentChatHistory = [{ role: "user", parts: [{ text: prompt }] }]; 
                const payload = { contents: currentChatHistory };
                // تحذير: مفتاح API ظاهر هنا! هذا غير آمن للبيئات الإنتاجية.
                // يفضل استخدام خادم وسيط لإخفاء المفتاح.
                const apiKey = "AIzaSyAYS6gghLtXRgLnLFiHdF90CF17QfQ6CmM"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = `فشل الاتصال بـ Gemini API: ${response.status} ${errorData?.error?.message || ''}`;
                    if (response.status === 400 && errorData?.error?.message?.toLowerCase().includes("api key not valid")) errorMessage = "مفتاح Gemini API غير صالح أو غير مفعل.";
                    else if (response.status === 403) errorMessage = "تم رفض الوصول بواسطة Gemini API. تحقق من صلاحيات المفتاح.";
                    else if (response.status === 429) errorMessage = "تم تجاوز حصة الاستخدام لـ Gemini API. يرجى المحاولة لاحقًا.";
                    throw new Error(errorMessage);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    responseArea.innerHTML = `<div class="whitespace-pre-wrap">${result.candidates[0].content.parts[0].text.trim()}</div>`;
                } else { 
                    responseArea.innerHTML = `<p class="text-error-color p-4 bg-red-50 rounded-md">لم يتم العثور على نصيحة في استجابة Gemini API.</p>`;
                    throw new Error('لم يتم العثور على نصيحة في استجابة Gemini API.');
                }
            } catch (error) {
                responseArea.innerHTML = `<p class="text-error-color p-4 bg-red-50 rounded-md">حدث خطأ أثناء الحصول على النصيحة: ${error.message}</p>`;
                showToast(`خطأ في الحصول على النصيحة: ${error.message}`, 'error');
                console.error("Gemini API error (advice):", error);
            } finally {
                analyzeButton.disabled = false;
                analyzeButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        };
        async function sendAIChatMessage() { 
            const inputElement = document.getElementById('ai-chat-input'); 
            const userMessage = inputElement.value.trim();
            if (!userMessage) return;

            appendChatMessage(userMessage, 'user');
            aiChatHistory.push({ role: "user", parts: [{ text: userMessage }] }); 
            inputElement.value = '';

            const sendButton = document.getElementById('send-ai-chat-message-button'); 
            const loadingIndicator = document.getElementById('ai-chat-loading-indicator'); 
            
            sendButton.disabled = true;
            sendButton.classList.add('opacity-50');
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.classList.add('flex');

            const appDataSummary = await generateAppDataSummary(); 
            const systemInstruction = `أنت "المساعد الذكي Pro"، مساعد لمدير متجر أحذية محترف. المستخدم يسألك. معلومات إضافية عن حالة التطبيق: ${appDataSummary}. قدم إجابة مفيدة، ودودة، واحترافية باللغة العربية. إذا كان السؤال عامًا، أجب بشكل عام. إذا كان يتعلق ببيانات التطبيق، حاول تقديم رؤى بناءً على الملخص إذا كان ذا صلة، أو اطلب من المستخدم الانتقال إلى قسم الإحصائيات أو المخزون لمزيد من التفاصيل. كن موجزًا عند الإمكان ولكن قدم قيمة.`;
            const contentsForApi = [ { role: "user", parts: [{ text: systemInstruction }] }, ...aiChatHistory ];

            try {
                const payload = { contents: contentsForApi };
                // تحذير: مفتاح API ظاهر هنا! هذا غير آمن للبيئات الإنتاجية.
                // يفضل استخدام خادم وسيط لإخفاء المفتاح.
                const apiKey = "AIzaSyAYS6gghLtXRgLnLFiHdF90CF17QfQ6CmM"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = `فشل الاتصال بـ Gemini API: ${response.status} ${errorData?.error?.message || ''}`;
                    if (response.status === 400 && errorData?.error?.message?.toLowerCase().includes("api key not valid")) errorMessage = "مفتاح Gemini API غير صالح أو غير مفعل.";
                    else if (response.status === 403) errorMessage = "تم رفض الوصول بواسطة Gemini API. تحقق من صلاحيات المفتاح.";
                    else if (response.status === 429) errorMessage = "تم تجاوز حصة الاستخدام لـ Gemini API. يرجى المحاولة لاحقًا.";
                    throw new Error(errorMessage);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const botResponse = result.candidates[0].content.parts[0].text.trim();
                    appendChatMessage(botResponse, 'bot');
                    aiChatHistory.push({ role: "model", parts: [{ text: botResponse }] }); 
                } else {
                    appendChatMessage('عذرًا، لم أتمكن من معالجة طلبك حاليًا.', 'bot');
                }
            } catch (error) {
                appendChatMessage(`عذرًا، حدث خطأ: ${error.message}`, 'bot');
                console.error("AI Chat Error (Gemini API):", error);
            } finally {
                sendButton.disabled = false;
                sendButton.classList.remove('opacity-50');
                loadingIndicator.classList.add('hidden');
                loadingIndicator.classList.remove('flex');
            }
        }

        // --- Returns Management (Dexie) ---
        async function displayReturnList() { /* ... same as original ... */ 
            try {
                await db.open();
                const returns = await db.returns.orderBy('date').reverse().toArray();
                const listArea = document.getElementById('all-returns-list-area');
                listArea.innerHTML = ''; 
                listArea.classList.remove('hidden'); 

                if (returns.length === 0) {
                    listArea.innerHTML = '<p class="text-center text-text-color-secondary mt-6 text-lg">لا توجد أي عمليات إرجاع مسجلة حاليًا.</p>';
                    return;
                }
                
                returns.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'return-entry-item';
                    entryDiv.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p><strong class="customer-name">${entry.name || 'غير مسجل'} ${entry.lastname || ''}</strong></p>
                                <p class="text-xs"><strong>الهاتف:</strong> ${entry.phone}</p>
                                <p class="text-xs"><strong>الملاحظات:</strong> ${entry.notes || 'لا توجد'}</p>
<p class="text-xs text-gray-400">تاريخ التسجيل: ${new Date(entry.date).toLocaleDateString('ar-EG', {day: 'numeric', month: 'short', year: 'numeric', numberingSystem: 'latn'})}</p>
                            </div>
                            <div class="return-entry-actions flex gap-2.5 mt-1">
                                <button onclick="populateReturnFormForEdit('${entry.id}')" class="app-button text-blue-600 hover:text-blue-800 p-1.5"><i class="fas fa-edit"></i></button>
                                <button onclick="confirmDeleteReturnEntry('${entry.id}')" class="app-button text-red-500 hover:text-red-700 p-1.5"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                    `;
                    listArea.appendChild(entryDiv);
                });
            } catch (error) {
                console.error("Error displaying return list from Dexie:", error);
                showToast('خطأ في عرض قائمة الإرجاع.', 'error');
            }
        }
        async function handleAddReturn(event) { /* ... same as original ... */ 
            event.preventDefault();
            const customerName = document.getElementById('return-customer-name').value.trim();
            const customerLastName = document.getElementById('return-customer-lastname').value.trim();
            const customerPhone = document.getElementById('return-customer-phone').value.trim();
            const returnNotes = document.getElementById('return-notes').value.trim();
            const formTitle = document.getElementById('add-return-form-title');
            const submitButton = document.getElementById('add-return-submit-button');
            const currentDate = new Date();
            const returnMonthYear = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;


            if (!customerPhone) {
                showToast('رقم هاتف العميل إلزامي.', 'error'); return;
            }
            if (!/^\d{8,15}$/.test(customerPhone)) { 
                 showToast('يرجى إدخال رقم هاتف صحيح.', 'error'); return;
            }
            
            try {
                await db.open();
                if (editingReturnId) { 
                    const existingReturn = await db.returns.where('phone').equals(customerPhone).first();
                    if (existingReturn && existingReturn.id !== editingReturnId) {
                         showToast('هذا الرقم مسجل بالفعل لعميل آخر في قائمة الإرجاع.', 'error'); return;
                    }
                    await db.returns.update(editingReturnId, {
                        name: customerName, 
                        lastname: customerLastName,
                        phone: customerPhone, 
                        notes: returnNotes,
                        returnMonthYear: returnMonthYear 
                    });
                    showToast('تم تحديث بيانات الإرجاع بنجاح.');
                    editingReturnId = null; 
                    formTitle.textContent = 'إضافة عميل إلى قائمة الإرجاع';
                    submitButton.textContent = 'إضافة إلى القائمة';
                } else { 
                    const existingReturn = await db.returns.where('phone').equals(customerPhone).first();
                    if (existingReturn) {
                        showToast('هذا الرقم مسجل بالفعل في قائمة الإرجاع.', 'error'); return;
                    }
                    const newReturn = {
                        name: customerName, lastname: customerLastName,
                        phone: customerPhone, notes: returnNotes, date: new Date().toISOString(),
                        returnMonthYear: returnMonthYear
                    };
                    await db.returns.add(newReturn);
                    showToast('تمت إضافة العميل إلى قائمة الإرجاع بنجاح.');
                }
                document.getElementById('add-return-form').reset();
                if (!document.getElementById('all-returns-list-area').classList.contains('hidden')) {
                     displayReturnList(); 
                }
                document.getElementById('return-search-result-area').innerHTML = ''; 
            } catch (error) {
                 console.error("Error saving return to Dexie:", error);
                 showToast('فشل حفظ بيانات الإرجاع.', 'error');
            }
        }
        window.populateReturnFormForEdit = async function(returnId) { /* ... same as original ... */ 
            try {
                await db.open();
                const returnEntry = await db.returns.get(parseInt(returnId)); 
                if (!returnEntry) return;

                document.getElementById('editing-return-id').value = returnEntry.id; 
                document.getElementById('return-customer-name').value = returnEntry.name || '';
                document.getElementById('return-customer-lastname').value = returnEntry.lastname || '';
                document.getElementById('return-customer-phone').value = returnEntry.phone; 
                document.getElementById('return-notes').value = returnEntry.notes || '';
                
                document.getElementById('add-return-form-title').textContent = 'تعديل بيانات الإرجاع';
                document.getElementById('add-return-submit-button').textContent = 'حفظ التعديلات';
                editingReturnId = returnEntry.id; 

                document.getElementById('add-return-form').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error("Error populating return form for edit:", error);
                showToast('خطأ في جلب بيانات الإرجاع للتعديل.', 'error');
            }
        }
        window.confirmDeleteReturnEntry = async function(returnId) { /* ... same as original ... */ 
            showModal('message-modal', `هل أنت متأكد أنك تريد حذف هذا الإدخال من قائمة الإرجاع؟`);
            const messageModalButtons = document.getElementById('message-modal-buttons');
            messageModalButtons.innerHTML = `
                <button onclick="closeModal('message-modal')" class="app-button app-button-secondary">إلغاء</button>
                <button id="confirm-action-btn" class="app-button app-button-danger">نعم، حذف</button>
            `;
            document.getElementById('confirm-action-btn').onclick = async () => {
                try {
                    await db.open();
                    await db.returns.delete(parseInt(returnId)); 
                    if (!document.getElementById('all-returns-list-area').classList.contains('hidden')) {
                        displayReturnList(); 
                    }
                    document.getElementById('return-search-result-area').innerHTML = ''; 
                    closeModal('message-modal'); 
                    showToast('تم حذف الإدخال من قائمة الإرجاع بنجاح.'); 
                } catch (error) {
                    console.error("Error deleting return from Dexie:", error);
                    showToast('فشل حذف الإدخال.', 'error');
                    closeModal('message-modal');
                }
            };
        }
        async function handleSearchReturn() { /* ... same as original ... */ 
            const searchPhone = document.getElementById('search-return-phone').value.trim();
            const resultArea = document.getElementById('return-search-result-area');
            const allReturnsArea = document.getElementById('all-returns-list-area');
            resultArea.innerHTML = ''; 
            allReturnsArea.classList.add('hidden'); 

            if (!searchPhone) {
                resultArea.innerHTML = '<p class="text-text-color-secondary p-3 text-center">يرجى إدخال رقم هاتف للبحث.</p>';
                return;
            }
            try {
                await db.open();
                const foundReturn = await db.returns.where('phone').equals(searchPhone).first();

                if (foundReturn) {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'return-entry-item'; 
                    entryDiv.innerHTML = `
                        <p><strong class="customer-name highlight-returned">الاسم:</strong> ${foundReturn.name || ''} ${foundReturn.lastname || ''}</p>
                        <p><strong>رقم الهاتف:</strong> ${foundReturn.phone}</p>
                        <p><strong>الملاحظات:</strong> ${foundReturn.notes || 'لا توجد ملاحظات'}</p>
<p class="text-xs text-gray-400">تاريخ التسجيل: ${new Date(foundReturn.date).toLocaleDateString('ar-EG', {day: 'numeric', month: 'short', year: 'numeric', numberingSystem: 'latn'})}</p>
                         <div class="return-entry-actions flex gap-2.5 mt-2.5">
                            <button onclick="populateReturnFormForEdit('${foundReturn.id}')" class="app-button text-blue-600 hover:text-blue-800 p-1.5"><i class="fas fa-edit"></i></button>
                            <button onclick="confirmDeleteReturnEntry('${foundReturn.id}')" class="app-button text-red-500 hover:text-red-700 p-1.5"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    resultArea.appendChild(entryDiv);
                } else {
                    resultArea.innerHTML = '<p class="customer-name not-found font-semibold p-3 text-center bg-green-50 text-green-700 rounded-md">العميل غير موجود في قائمة الإرجاع. يمكن التعامل معه.</p>';
                }
            } catch (error) {
                console.error("Error searching returns in Dexie:", error);
                showToast('خطأ أثناء البحث في قائمة الإرجاع.', 'error');
            }
        }

        // --- Stock Alerts (Uses Dexie for shoes) ---
        async function displayStockAlerts(listAreaId = 'stock-alerts-list-area-stats', thresholdInputId = 'stock-alert-threshold-stats') { /* ... same as original ... */ 
            const thresholdInput = document.getElementById(thresholdInputId);
            const threshold = parseInt(thresholdInput.value) || 1; 
            thresholdInput.value = threshold; 
            try {
                await db.open();
                const shoes = await db.shoes.toArray();
                const alertsListArea = document.getElementById(listAreaId);
                alertsListArea.innerHTML = '';
                let alertsFound = false;

                shoes.forEach(shoe => {
                    shoe.sizes.forEach(s => {
                        if (s.quantity > 0 && s.quantity <= threshold) {
                            const alertItem = document.createElement('div');
                            alertItem.className = 'alert-item-card'; 
                            alertItem.onclick = () => openAddShoeModal(shoe.id); // Make alert card clickable to edit shoe
                            
                            let imageHTML = `<div class="w-14 h-14 bg-gray-200 rounded-md flex items-center justify-center text-gray-400 text-xs shrink-0">صورة</div>`;
                            if (shoe.imageUrl) {
                                imageHTML = `<img src="${shoe.imageUrl}" alt="${shoe.name}" class="w-14 h-14 object-cover rounded-md shrink-0">`;
                            }

                            alertItem.innerHTML = `
                                ${imageHTML}
                                <div class="alert-item-card-content">
                                    <h5>${shoe.name}</h5>
                                    <p>المقاس: <span class="font-semibold">${s.size}</span></p>
                                    <p>الكمية المتبقية: <span class="quantity-low">${s.quantity}</span> قطعة</p>
                                </div>
                            `;
                            alertsListArea.appendChild(alertItem);
                            alertsFound = true;
                        }
                    });
                });

                if (!alertsFound) {
                    alertsListArea.innerHTML = '<p class="text-center text-text-color-secondary mt-5 text-sm">لا توجد تنبيهات نقص مخزون حاليًا بناءً على الحد المحدد.</p>';
                }
            } catch (error) {
                console.error("Error displaying stock alerts from Dexie:", error);
                showToast('خطأ في عرض تنبيهات المخزون.', 'error');
            }
        }

        // --- Delivery Services (Dexie) ---
        function getDefaultWilayaPrices() { /* ... same as original ... */ 
            const wilayas = [
                { id: 9, name: 'البليدة', price: 550 }, { id: 16, name: 'الجزائر', price: 400 }, { id: 35, name: 'بومرداس', price: 580 },
                { id: 2, name: 'الشلف', price: 750 }, { id: 4, name: 'أم البواقي', price: 780 }, { id: 5, name: 'باتنة', price: 780 },
                { id: 6, name: 'بجاية', price: 780 }, { id: 48, name: 'غليزان', price: 780 }, { id: 50, name: 'المنيعة', price: 850 },
                { id: 53, name: 'بني عباس', price: 800 }, { id: 56, name: 'جانت', price: 1800 }, { id: 10, name: 'البويرة', price: 680 },
                { id: 13, name: 'تلمسان', price: 780 }, { id: 14, name: 'تيارت', price: 800 }, { id: 15, name: 'تيزي وزو', price: 680 },
                { id: 18, name: 'جيجل', price: 780 }, { id: 20, name: 'سعيدة', price: 850 }, { id: 21, name: 'سكيكدة', price: 780 },
                { id: 22, name: 'سيدي بلعباس', price: 780 }, { id: 23, name: 'عنابة', price: 780 }, { id: 24, name: 'قالمة', price: 820 },
                { id: 25, name: 'قسنطينة', price: 780 }, { id: 26, name: 'المدية', price: 650 }, { id: 27, name: 'مستغانم', price: 780 },
                { id: 28, name: 'المسيلة', price: 780 }, { id: 29, name: 'معسكر', price: 780 }, { id: 31, name: 'وهران', price: 780 },
                { id: 34, name: 'برج بوعريريج', price: 780 }, { id: 36, name: 'الطارف', price: 850 }, { id: 38, name: 'تيسمسيلت', price: 780 },
                { id: 40, name: 'خنشلة', price: 850 }, { id: 41, name: 'سوق أهراس', price: 800 }, { id: 43, name: 'ميلة', price: 780 },
                { id: 44, name: 'عين الدفلى', price: 780 }, { id: 46, name: 'عين تموشنت', price: 780 }, { id: 3, name: 'الأغواط', price: 950 },
                { id: 7, name: 'بسكرة', price: 900 }, { id: 12, name: 'تبسة', price: 800 }, { id: 17, name: 'الجلفة', price: 850 },
                { id: 30, name: 'ورقلة', price: 750 }, { id: 47, name: 'غرداية', price: 950 }, { id: 51, name: 'أولاد جلال', price: 900 },
                { id: 55, name: 'تقرت', price: 950 }, { id: 49, name: 'المغير', price: 950 }, { id: 1, name: 'أدرار', price: 1100 },
                { id: 8, name: 'بشار', price: 1000 }, { id: 32, name: 'البيض', price: 1000 }, { id: 45, name: 'النعامة', price: 1000 },
                { id: 54, name: 'تيميمون', price: 1100 }, { id: 11, name: 'تمنراست', price: 1600 }, { id: 33, name: 'إليزي', price: 1800 },
                { id: 37, name: 'تندوف', price: 1600 }, { id: 57, name: 'عين صالح', price: 1190 }, { id: 19, name: 'سطيف', price: 780 },
                { id: 52, name: 'برج باجي مختار', price: 5000 }
            ];
            const allWilayaIds = Array.from({length: 58}, (_, i) => i + 1);
            allWilayaIds.forEach(id => {
                if (!wilayas.find(w => w.id === id)) {
                    wilayas.push({ id: id, name: `ولاية ${id}`, price: 700 }); 
                }
            });
            wilayas.sort((a, b) => a.id - b.id);
            return wilayas;
        }
        async function getStoredDeliveryPrices() { /* ... same as original ... */ 
            try {
                await db.open();
                let prices = await db.deliveryPrices.toArray();
                if (!prices || prices.length < 58) { 
                    const defaultPrices = getDefaultWilayaPrices();
                    if (prices && prices.length > 0) {
                         defaultPrices.forEach(defaultWilaya => {
                            if (!prices.find(sp => sp.id === defaultWilaya.id)) {
                                prices.push(defaultWilaya);
                            }
                        });
                        prices = prices.filter(sp => defaultPrices.some(dw => dw.id === sp.id)); 
                    } else {
                        prices = defaultPrices;
                    }
                    prices.sort((a,b) => a.id - b.id);
                    await db.deliveryPrices.bulkPut(prices); 
                }
                return prices;
            } catch (error) {
                console.error("Error getting/setting delivery prices in Dexie:", error);
                return getDefaultWilayaPrices(); 
            }
        }
        async function storeDeliveryPrices(prices) { /* ... same as original ... */ 
            try {
                await db.open();
                await db.deliveryPrices.bulkPut(prices); 
            } catch (error) {
                console.error("Error storing delivery prices to Dexie:", error);
            }
        }
async function displayDeliveryPrices(searchTerm = '') { 
            try {
                const prices = await getStoredDeliveryPrices(); 
                const displayArea = document.getElementById('delivery-prices-display-area');
                displayArea.innerHTML = '';

                const filteredPrices = prices.filter(wilaya => 
                    wilaya.name.toLowerCase().includes(searchTerm.toLowerCase())
                );

                if (filteredPrices.length === 0) {
                    displayArea.innerHTML = `<p class="text-center text-text-color-secondary mt-4 col-span-full">لا توجد ولايات تطابق بحثك.</p>`;
                    return;
                }

                filteredPrices.forEach(wilaya => {
                    const card = document.createElement('div');
                    card.className = 'data-card p-4 flex justify-between items-start'; // items-start أفضل
                    
                    // --- تعديل: إضافة عرض الملاحظات ---
                    const notesHTML = wilaya.notes ? `<p class="text-xs text-gray-500 mt-2 whitespace-pre-wrap">${wilaya.notes}</p>` : '';

                    card.innerHTML = `
                        <div class="flex-grow">
                            <h5 class="text-md font-semibold">${wilaya.id}. ${wilaya.name}</h5>
                            <p class="text-success-color font-bold">${wilaya.price || wilaya.defaultPrice} دج</p>
                            ${notesHTML}
                        </div>
                        <button onclick="openEditDeliveryPriceModal(${wilaya.id}, '${wilaya.name}', ${wilaya.price || wilaya.defaultPrice}, \`${wilaya.notes || ''}\`)" class="app-button app-button-secondary text-xs px-3 py-1.5 shrink-0 ml-3">
                            <i class="fas fa-edit mr-1"></i> تعديل
                        </button>
                    `;
                    displayArea.appendChild(card);
                });
            } catch (error) {
                console.error("Error displaying delivery prices:", error);
                showToast('خطأ في عرض أسعار التوصيل.', 'error');
            }
        }
// تم إضافة متغير جديد "notes"
        window.openEditDeliveryPriceModal = async function(wilayaId, wilayaName, currentPrice, notes = '') {
            currentEditingWilayaId = wilayaId;
            document.getElementById('editing-wilaya-id').value = wilayaId;
            document.getElementById('wilaya-name-display').value = wilayaName;
            document.getElementById('wilaya-delivery-price').value = currentPrice;
            // --- إضافة: تعبئة حقل الملاحظات ---
            document.getElementById('wilaya-delivery-notes').value = notes;
            showModal('edit-delivery-price-modal');
        }
async function handleEditDeliveryPriceForm(event) { 
            event.preventDefault();
            const newPrice = parseFloat(document.getElementById('wilaya-delivery-price').value);
            // --- إضافة: قراءة الملاحظات من الحقل ---
            const newNotes = document.getElementById('wilaya-delivery-notes').value.trim();

            if (isNaN(newPrice) || newPrice < 0) {
                showToast('الرجاء إدخال سعر توصيل صالح.', 'error');
                return;
            }
            try {
                await db.open();
                // --- تعديل: إضافة الملاحظات عند التحديث ---
                await db.deliveryPrices.update(currentEditingWilayaId, { price: newPrice, notes: newNotes });
                showToast('تم تحديث بيانات التوصيل بنجاح.');
                displayDeliveryPrices(document.getElementById('search-delivery-wilaya-input').value.trim()); 
                closeModal('edit-delivery-price-modal');
            } catch (error) {
                 console.error("Error updating delivery price in Dexie:", error);
                 showToast('خطأ في تحديث البيانات.', 'error');
            }
        }

        // --- Suppliers Management (Dexie) ---
        window.openAddSupplierModal = async function(supplierIdToEdit = null) { /* ... same as original ... */ 
            const form = document.getElementById('add-supplier-form'); 
            const modalTitle = document.getElementById('add-edit-supplier-modal-title'); 
            const saveButton = document.getElementById('save-supplier-button'); 
            const supplierImagePreview = document.getElementById('supplier-image-preview');
            
            form.reset();
            supplierImagePreview.style.display = 'none';
            supplierImagePreview.src = '#';
            editingSupplierId = supplierIdToEdit; 

            if (supplierIdToEdit) {
                modalTitle.textContent = 'تعديل بيانات المورد';
                saveButton.textContent = 'حفظ التعديلات';
                try {
                    await db.open();
                    const supplierToEdit = await db.suppliers.get(supplierIdToEdit);
                    if (supplierToEdit) {
                        document.getElementById('supplier-name').value = supplierToEdit.name; 
                        document.getElementById('supplier-notes').value = supplierToEdit.notes || '';
                        if (supplierToEdit.imageUrl) {
                            supplierImagePreview.src = supplierToEdit.imageUrl;
                            supplierImagePreview.style.display = 'block';
                        }
                    }
                } catch (error) {
                    console.error("Error fetching supplier for edit:", error);
                    showToast('خطأ في جلب بيانات المورد للتعديل.', 'error');
                }
            } else {
                modalTitle.textContent = 'إضافة مورد جديد';
                saveButton.textContent = 'إضافة مورد';
            }
            showModal('add-supplier-modal');
        }
        async function handleAddSupplierForm(event) { /* ... same as original ... */ 
            event.preventDefault();
            const name = document.getElementById('supplier-name').value.trim(); 
            const notes = document.getElementById('supplier-notes').value.trim();
            const supplierImageInput = document.getElementById('supplier-image');
            let supplierImageDataUrl = document.getElementById('supplier-image-preview').src;

            if (!name) {
                showToast('اسم المورد مطلوب.', 'error');
                return;
            }
            
            if (supplierImageDataUrl === window.location.href + "#" || supplierImageDataUrl === "#") { 
                 supplierImageDataUrl = null;
            }

            const processSupplierSaving = async (imgUrl) => {
                const supplierData = { 
                    name, 
                    notes, 
                    imageUrl: imgUrl,
                };

                try {
                    await db.open();
                    if (editingSupplierId) {
                        const existingSupplier = await db.suppliers.get(editingSupplierId);
                        supplierData.addedDate = existingSupplier ? existingSupplier.addedDate : new Date().toISOString(); 
                        await db.suppliers.update(editingSupplierId, supplierData);
                        showToast('تم تحديث بيانات المورد بنجاح.');
                    } else {
                        supplierData.addedDate = new Date().toISOString(); 
                        await db.suppliers.add(supplierData); 
                        showToast('تمت إضافة المورد بنجاح.');
                    }
                    editingSupplierId = null;
                    closeModal('add-supplier-modal');
                    displaySuppliers(); // Refresh suppliers list
                } catch (error) {
                    console.error("Error saving supplier to Dexie:", error);
                    showToast('فشل حفظ بيانات المورد.', 'error');
                }
            };
            
            if (supplierImageInput.files && supplierImageInput.files[0]) {
                const file = supplierImageInput.files[0];
                if (!file.type.startsWith('image/')){ showToast('يرجى اختيار ملف صورة صالح.', 'error'); return; }
                if (file.size > 2 * 1024 * 1024) { showToast('حجم الصورة كبير جدًا (الحد الأقصى 2MB).', 'error'); return; }
                const reader = new FileReader();
                reader.onload = e => { processSupplierSaving(e.target.result); }
                reader.onerror = () => { showToast('خطأ في قراءة الصورة.', 'error'); processSupplierSaving(supplierImageDataUrl); } 
                reader.readAsDataURL(file);
            } else {
                processSupplierSaving(supplierImageDataUrl); 
            }
        }
        async function displaySuppliers() { /* ... same as original ... */ 
            try {
                await db.open();
                const suppliers = await db.suppliers.orderBy('addedDate').reverse().toArray(); 
                const listArea = document.getElementById('suppliers-list-area');
                listArea.innerHTML = ''; 

                const listHeader = document.createElement('h4'); 
                listHeader.className = 'section-title';
                listHeader.textContent = 'قائمة الموردين';
                listArea.appendChild(listHeader);

                if (suppliers.length === 0) {
                    listArea.innerHTML += '<p class="text-center text-text-color-secondary mt-4">لم يتم إضافة أي موردين بعد.</p>';
                    return;
                }
                const supplierGrid = document.createElement('div');
                supplierGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';

                suppliers.forEach(supplier => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'supplier-item'; 
                    itemDiv.onclick = () => openSupplierDetailsModal(supplier.id); 
                    
                    let imageElement = '';
                    if (supplier.imageUrl) {
                        imageElement = `<img src="${supplier.imageUrl}" alt="${supplier.name}" class="supplier-item-image">`;
                    } else {
                        const firstLetter = supplier.name ? supplier.name.charAt(0).toUpperCase() : '?';
                        imageElement = `<div class="supplier-item-no-image">${firstLetter}</div>`;
                    }

                    itemDiv.innerHTML = `
                        <div class="supplier-item-info">
                            ${imageElement}
                            <div>
                                <h5>${supplier.name}</h5>
                                <p class="supplier-notes-preview">${supplier.notes || 'لا توجد ملاحظات'}</p>
                            </div>
                        </div>
                        <div class="supplier-item-actions flex gap-2">
                             <button onclick="event.stopPropagation(); openAddSupplierModal(${supplier.id})" class="app-button app-button-secondary text-xs px-2 py-1"><i class="fas fa-edit"></i></button>
                             <button onclick="event.stopPropagation(); confirmDeleteSupplier(${supplier.id})" class="app-button app-button-danger text-xs px-2 py-1"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    supplierGrid.appendChild(itemDiv);
                });
                listArea.appendChild(supplierGrid);
            } catch (error) {
                console.error("Error displaying suppliers:", error);
                showToast('خطأ في عرض قائمة الموردين.', 'error');
            }
        }
        window.openSupplierDetailsModal = async function(supplierId) { /* ... same as original ... */ 
            try {
                await db.open();
                const supplier = await db.suppliers.get(supplierId);
                if (!supplier) {
                    showToast('لم يتم العثور على المورد.', 'error');
                    return;
                }

                document.getElementById('details-supplier-modal-name').textContent = supplier.name;
                const imageContainer = document.getElementById('details-supplier-modal-image-container');
                imageContainer.innerHTML = ''; 
                if (supplier.imageUrl) {
                    const img = document.createElement('img');
                    img.src = supplier.imageUrl;
                    img.alt = supplier.name;
                    img.className = 'supplier-details-image';
                    imageContainer.appendChild(img);
                } else {
                    const firstLetter = supplier.name ? supplier.name.charAt(0).toUpperCase() : '?';
                    const noImageDiv = document.createElement('div');
                    noImageDiv.className = 'supplier-details-no-image';
                    noImageDiv.textContent = firstLetter;
                    imageContainer.appendChild(noImageDiv);
                }

                document.getElementById('details-supplier-modal-notes').textContent = supplier.notes || 'لا توجد ملاحظات مسجلة.';
document.getElementById('details-supplier-modal-added-date').textContent = new Date(supplier.addedDate).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', numberingSystem: 'latn' });
                
                showModal('supplier-details-modal');
            } catch (error) {
                console.error("Error opening supplier details modal:", error);
                showToast('خطأ في عرض تفاصيل المورد.', 'error');
            }
        }
        window.confirmDeleteSupplier = async function(supplierId) { /* ... same as original ... */ 
            showModal('message-modal', `هل أنت متأكد أنك تريد حذف هذا المورد؟ هذا الإجراء لا يمكن التراجع عنه.`);
            const messageModalButtons = document.getElementById('message-modal-buttons');
            messageModalButtons.innerHTML = `
                <button onclick="closeModal('message-modal')" class="app-button app-button-secondary">إلغاء</button>
                <button id="confirm-delete-supplier-action" class="app-button app-button-danger">نعم، حذف</button>
            `;
            document.getElementById('confirm-delete-supplier-action').onclick = async () => {
                try {
                    await db.open();
                    await db.suppliers.delete(supplierId);
                    displaySuppliers(); 
                    closeModal('message-modal'); 
                    showToast('تم حذف المورد بنجاح.'); 
                } catch (error) {
                    console.error("Error deleting supplier from Dexie:", error);
                    showToast('فشل حذف المورد.', 'error');
                    closeModal('message-modal');
                }
            };
        }

        // --- View Navigation ---
        function showView(viewId) { 
    const mainViewSections = document.querySelectorAll('.main-view-section');
    mainViewSections.forEach(section => section.classList.add('hidden'));
    
    const targetView = document.getElementById(viewId);
    if (targetView) {
        targetView.classList.remove('hidden');
    }

    if (viewId === 'inventory-view-content') {
        displayAllShoes(currentShoeFilter); 
    } else if (viewId === 'stats-view-content') {
        displayStats(); 
    } else if (viewId === 'other-services-view-content') { 
        // <-- هذا هو الجزء المضاف والمهم
        displayStockAlerts('stock-alerts-list-area-stats', 'stock-alert-threshold-stats');
        displayBestSellingShoes();
    } else if (viewId === 'delivery-services-view-content') {
        displayDeliveryPrices(); 
        document.getElementById('search-delivery-wilaya-input').value = ''; 
    } else if (viewId === 'suppliers-view-content') {
        displaySuppliers();
    }
     else if (viewId === 'ai-sales-advisor-view-content') {
        document.getElementById('ai-chat-interface').classList.add('hidden');
        document.getElementById('ai-analysis-interface').classList.add('hidden');
        document.getElementById('ai-options-container').classList.remove('hidden');
        document.getElementById('ai-sales-advisor-response-area').innerHTML = '<p class="text-text-color-secondary p-4 text-center">اضغط على زر "تحليل ذكي" أعلاه للحصول على نصائح...</p>';
        aiChatHistory = []; 
        const chatArea = document.getElementById('ai-chat-area'); 
        chatArea.innerHTML = '<div class="chat-message bot"><span class="sender">المساعد الذكي Pro</span>مرحباً! أنا مساعدك الذكي. كيف يمكنني خدمتك اليوم؟</div>';
        document.getElementById('ai-chat-input').value = ''; 
    } else if (viewId === 'returns-view-content') {
        document.getElementById('return-search-result-area').innerHTML = '<p class="text-text-color-secondary p-3 text-center">أدخل رقم هاتف للبحث أو قم بإضافة عميل جديد إلى القائمة.</p>';
        document.getElementById('all-returns-list-area').classList.add('hidden'); 
        editingReturnId = null;
        document.getElementById('add-return-form').reset();
        document.getElementById('add-return-form-title').textContent = 'إضافة عميل إلى قائمة الإرجاع';
        document.getElementById('add-return-submit-button').textContent = 'إضافة إلى القائمة';
    } else if (viewId === 'daily-sales-confirmation-view-content') {
        displayPendingSales();
    }
}

        window.navigateToView = function(viewId, tabElement) { /* ... same as original ... */ 
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(i => i.classList.remove('active'));
            if (tabElement) {
                tabElement.classList.add('active');
            } else { 
                let targetNav = viewId.replace('-view-content', '');
                const homeViewTriggers = ['daily-sales-confirmation', 'ai-sales-advisor', 'returns', 'stock-alerts', 'settings', 'about-app', 'inventory', 'delivery-services', 'other-services', 'suppliers']; 
                if (homeViewTriggers.includes(targetNav) && !['inventory', 'settings', 'about', 'stats'].includes(targetNav)) { 
                     const homeTab = document.querySelector('.nav-item[data-target="home"]');
                     if (homeTab) homeTab.classList.add('active');
                } else {
                    const correspondingTab = document.querySelector(`.nav-item[data-target="${targetNav}"]`);
                    if(correspondingTab) {
                        correspondingTab.classList.add('active');
                    } else { 
                        const homeTab = document.querySelector('.nav-item[data-target="home"]');
                        if (homeTab) homeTab.classList.add('active');
                    }
                }
            }
            showView(viewId);
        }
 

        // --- Global Search ---
        window.openGlobalSearchModal = function() { /* ... same as original ... */ 
            document.getElementById('global-search-input').value = '';
            document.getElementById('global-search-results-area').innerHTML = '<p class="text-text-color-secondary p-3 text-center">أدخل عبارة البحث...</p>';
            showModal('global-search-modal');
        }
  async function executeGlobalSearch() { 
            const searchTerm = document.getElementById('global-search-input').value.trim().toLowerCase();
            const resultsArea = document.getElementById('global-search-results-area');
            resultsArea.innerHTML = '';

            if (!searchTerm) {
                resultsArea.innerHTML = '<p class="text-text-color-secondary p-3 text-center">يرجى إدخال عبارة للبحث عنها.</p>';
                return;
            }
            try {
                await db.open();
                // --- الخطوة 1: جلب كل البيانات المطلوبة ---
                const shoes = await db.shoes.toArray();
                const returns = await db.returns.toArray();
                const deliveryPrices = await getStoredDeliveryPrices();
                const suppliers = await db.suppliers.toArray(); // إضافة جديدة
                const sales = await db.sales.toArray(); // إضافة جديدة
                const pendingSales = await db.pendingSales.toArray(); // إضافة جديدة
                
                let foundSomething = false;

                // --- البحث في الأحذية (موجود سابقاً) ---
                const shoeResults = shoes.filter(shoe => 
                    shoe.name.toLowerCase().includes(searchTerm) ||
                    (shoe.description && shoe.description.toLowerCase().includes(searchTerm)) ||
                    shoe.sizes.some(s => s.size.toLowerCase().includes(searchTerm))
                );

                if (shoeResults.length > 0) {
                    foundSomething = true;
                    const shoesHeader = document.createElement('h5');
                    shoesHeader.className = 'section-title text-primary-color';
                    shoesHeader.innerHTML = '<i class="fas fa-shoe-prints mr-2"></i> نتائج الأحذية:';
                    resultsArea.appendChild(shoesHeader);
                    shoeResults.forEach(shoe => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'search-result-item';
                        itemDiv.innerHTML = `<strong>${shoe.name}</strong> (متوفر: ${shoe.sizes.reduce((acc, s) => acc + s.quantity, 0)} قطعة)`;
                        itemDiv.onclick = () => {
                            closeModal('global-search-modal');
                            openShoeDetailsModal(shoe.id);
                        };
                        resultsArea.appendChild(itemDiv);
                    });
                }
                
                // --- البحث في الموردين (إضافة جديدة) ---
                const supplierResults = suppliers.filter(supplier => supplier.name.toLowerCase().includes(searchTerm));

                if (supplierResults.length > 0) {
                    foundSomething = true;
                    const suppliersHeader = document.createElement('h5');
                    suppliersHeader.className = 'section-title text-orange-600 mt-4'; // لون مميز للموردين
                    suppliersHeader.innerHTML = '<i class="fas fa-users mr-2"></i> نتائج الموردين:';
                    resultsArea.appendChild(suppliersHeader);
                    supplierResults.forEach(supplier => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'search-result-item';
                        itemDiv.innerHTML = `<strong>${supplier.name}</strong> - <span>${supplier.notes || 'لا توجد ملاحظات'}</span>`;
                        itemDiv.onclick = () => {
                            closeModal('global-search-modal');
                            openSupplierDetailsModal(supplier.id);
                        };
                        resultsArea.appendChild(itemDiv);
                    });
                }
                
                // --- البحث في المبيعات المعلقة (إضافة جديدة) ---
                const pendingSalesResults = pendingSales.filter(pSale =>
                    (pSale.customerName && pSale.customerName.toLowerCase().includes(searchTerm)) ||
                    (pSale.customerPhone && pSale.customerPhone.includes(searchTerm)) ||
                    (pSale.shoeName && pSale.shoeName.toLowerCase().includes(searchTerm))
                );

                if (pendingSalesResults.length > 0) {
                    foundSomething = true;
                    const pendingHeader = document.createElement('h5');
                    pendingHeader.className = 'section-title text-yellow-500 mt-4'; // لون مميز للمبيعات المعلقة
                    pendingHeader.innerHTML = '<i class="fas fa-tasks mr-2"></i> نتائج المبيعات المعلقة:';
                    resultsArea.appendChild(pendingHeader);
                    pendingSalesResults.forEach(pSale => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'search-result-item';
                        itemDiv.innerHTML = `<strong>${pSale.shoeName}</strong> - <span>${pSale.customerName || 'زبون غير مسجل'} (${pSale.customerPhone || 'لا يوجد هاتف'})</span>`;
                        itemDiv.onclick = () => {
                            closeModal('global-search-modal');
                            navigateToView('daily-sales-confirmation-view-content', null);
                        };
                        resultsArea.appendChild(itemDiv);
                    });
                }

                // --- البحث في المبيعات المؤكدة (إضافة جديدة) ---
                 const salesResults = sales.filter(sale =>
                    (sale.customerName && sale.customerName.toLowerCase().includes(searchTerm)) ||
                    (sale.customerPhone && sale.customerPhone.includes(searchTerm)) ||
                    (sale.shoeName && sale.shoeName.toLowerCase().includes(searchTerm))
                );

                if (salesResults.length > 0) {
                    foundSomething = true;
                    const salesHeader = document.createElement('h5');
                    salesHeader.className = 'section-title text-green-600 mt-4'; // لون مميز للمبيعات المؤكدة
                    salesHeader.innerHTML = '<i class="fas fa-check-circle mr-2"></i> نتائج المبيعات المؤكدة:';
                    resultsArea.appendChild(salesHeader);
                    salesResults.forEach(sale => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'search-result-item';
itemDiv.innerHTML = `<strong>${sale.shoeName}</strong> - <span>بيع لـ ${sale.customerName || 'زبون غير مسجل'} بتاريخ ${new Date(sale.date).toLocaleDateString('ar-EG', { numberingSystem: 'latn' })}</span>`;
                        itemDiv.onclick = () => showSaleDetailsInModal(sale);
                        resultsArea.appendChild(itemDiv);
                    });
                }

                // --- البحث في قائمة الإرجاع (موجود سابقاً) ---
                const returnResults = returns.filter(ret =>
                    ret.phone.includes(searchTerm) || 
                    (ret.name && ret.name.toLowerCase().includes(searchTerm)) ||
                    (ret.lastname && ret.lastname.toLowerCase().includes(searchTerm))
                );

                if (returnResults.length > 0) {
                    foundSomething = true;
                    const returnsHeader = document.createElement('h5');
                    returnsHeader.className = 'section-title text-red-600 mt-4';
                    returnsHeader.innerHTML = '<i class="fas fa-exchange-alt mr-2"></i> نتائج قائمة الإرجاع:';
                    resultsArea.appendChild(returnsHeader);
                    returnResults.forEach(ret => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'search-result-item';
                        itemDiv.innerHTML = `<strong class="highlight-returned">${ret.name || ''} ${ret.lastname || ''}</strong> (هاتف: ${ret.phone})`;
                        itemDiv.onclick = () => {
                            closeModal('global-search-modal');
                            navigateToView('returns-view-content', null);
                            setTimeout(() => { 
                                 document.getElementById('search-return-phone').value = ret.phone;
                                 handleSearchReturn();
                            },100);

                        };
                        resultsArea.appendChild(itemDiv);
                    });
                }
                
                // --- البحث في أسعار التوصيل (موجود سابقاً) ---
                const deliveryResults = deliveryPrices.filter(wilaya => 
                    wilaya.name.toLowerCase().includes(searchTerm)
                );

                if (deliveryResults.length > 0) {
                    foundSomething = true;
                    const deliveryHeader = document.createElement('h5');
                    deliveryHeader.className = 'section-title text-blue-600 mt-4'; 
                    deliveryHeader.innerHTML = '<i class="fas fa-shipping-fast mr-2"></i> نتائج أسعار التوصيل:';
                    resultsArea.appendChild(deliveryHeader);
                    deliveryResults.forEach(wilaya => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'search-result-item';
                        itemDiv.innerHTML = `<strong>${wilaya.name}</strong>: ${wilaya.price} دج`;
                        itemDiv.onclick = () => {
                            closeModal('global-search-modal');
                            navigateToView('delivery-services-view-content', null);
                            setTimeout(() => {
                                document.getElementById('search-delivery-wilaya-input').value = wilaya.name;
                                displayDeliveryPrices(wilaya.name); 
                            }, 100);
                        };
                        resultsArea.appendChild(itemDiv);
                    });
                }

                if (!foundSomething) {
                    resultsArea.innerHTML = '<p class="text-text-color-secondary p-3 text-center">لم يتم العثور على نتائج مطابقة لبحثك.</p>';
                }
            } catch (error) {
                console.error("Error during global search:", error);
                resultsArea.innerHTML = '<p class="text-error-color p-3 text-center">حدث خطأ أثناء البحث.</p>';
            }
        }
        
        // --- Data Management (Dexie) ---
        async function exportData() { /* ... same as original ... */ 
            try {
                await db.open();
                const dataToExport = {
                    shoes: (await db.shoes.toArray()).map(shoe => { const { imageUrl, ...rest } = shoe; return rest; }),
                    sales: await db.sales.toArray(),
                    returns: await db.returns.toArray(),
                    pendingSales: (await db.pendingSales.toArray()).map(sale => { const { shoeImage, ...rest } = sale; return rest; }), // Exclude shoeImage from pendingSales
                    deliveryPrices: await db.deliveryPrices.toArray(),
                    suppliers: (await db.suppliers.toArray()).map(supplier => { const { imageUrl, ...rest } = supplier; return rest; }), 
                    monthlyReports: await db.monthlyReports.toArray(), 
                    theme: localStorage.getItem(THEME_STORAGE_KEY) || 'light' 
                };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json;charset=utf-8'});
                const exportFileDefaultName = `shoes_manager_backup_${new Date().toISOString().slice(0,10)}.json`;

                try {
                    const linkElement = document.createElement('a');
                    const url = URL.createObjectURL(dataBlob);
                    linkElement.setAttribute('href', url);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    document.body.appendChild(linkElement); 
                    linkElement.click();
                    document.body.removeChild(linkElement); 
                    URL.revokeObjectURL(url); 
                    showToast('تم بدء تنزيل ملف النسخ الاحتياطي.');

                } catch (error) {
                    console.error("خطأ أثناء محاولة تنزيل الملف:", error);
                    const exportModalText = document.getElementById('export-data-text');
                    if (exportModalText) {
                        exportModalText.value = dataStr;
                        showModal('export-data-modal');
                        showToast('فشل التنزيل. انسخ البيانات من النافذة.', 'warning');
                    } else {
                         showToast('فشل تنزيل الملف. حاول استخدام طريقة النسخ اليدوي إذا استمرت المشكلة.', 'error');
                    }
                }
            } catch (error) {
                console.error("Error exporting data from Dexie:", error);
                showToast('فشل تصدير البيانات.', 'error');
            }
        }
        window.copyExportDataToClipboard = function() { /* ... same as original ... */ 
            const exportDataText = document.getElementById('export-data-text');
            if (exportDataText) {
                exportDataText.select();
                exportDataText.setSelectionRange(0, 99999); 
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(exportDataText.value)
                            .then(() => {
                                showToast('تم نسخ البيانات إلى الحافظة بنجاح!');
                            })
                            .catch(err => {
                                console.error('فشل النسخ إلى الحافظة (API): ', err);
                                try {
                                    const successful = document.execCommand('copy');
                                    if (successful) {
                                        showToast('تم نسخ البيانات إلى الحافظة بنجاح!');
                                    } else {
                                        showToast('فشل النسخ إلى الحافظة. يرجى النسخ يدويًا.', 'error');
                                    }
                                } catch (execErr) {
                                    console.error('فشل النسخ إلى الحافظة (execCommand): ', execErr);
                                    showToast('فشل النسخ إلى الحافظة. يرجى النسخ يدويًا.', 'error');
                                }
                            });
                    } else {
                        const successful = document.execCommand('copy');
                        if (successful) {
                            showToast('تم نسخ البيانات إلى الحافظة بنجاح!');
                        } else {
                            showToast('فشل النسخ إلى الحافظة. يرجى النسخ يدويًا.', 'error');
                        }
                    }
                } catch (err) {
                    console.error('خطأ عام أثناء محاولة النسخ: ', err);
                    showToast('فشل النسخ إلى الحافظة. يرجى النسخ يدويًا.', 'error');
                }
            }
        }
        async function importData() { /* ... same as original ... */ 
            const fileInput = document.getElementById('import-data-file');
            if (!fileInput.files.length) {
                showToast('يرجى اختيار ملف لاستيراده.', 'error');
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = async function(event) { 
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    showModal('message-modal', 'هل أنت متأكد أنك تريد استبدال جميع البيانات المحلية الحالية بالبيانات المستوردة؟ لا يمكن التراجع عن هذا الإجراء.');
                    const messageModalButtons = document.getElementById('message-modal-buttons');
                    messageModalButtons.innerHTML = `
                        <button onclick="closeModal('message-modal')" class="app-button app-button-secondary">إلغاء</button>
                        <button id="confirm-import-action" class="app-button app-button-danger">نعم، استيراد</button>
                    `;
                    document.getElementById('confirm-import-action').onclick = async () => {
                        try {
                            await db.open();
                            await Promise.all([
                                db.shoes.clear(), db.sales.clear(), db.returns.clear(),
                                db.pendingSales.clear(), db.deliveryPrices.clear(),
                                db.suppliers.clear(), db.monthlyReports.clear() 
                            ]);

                            if (importedData.shoes) await db.shoes.bulkAdd(importedData.shoes);
                            if (importedData.sales) await db.sales.bulkAdd(importedData.sales);
                            if (importedData.returns) await db.returns.bulkAdd(importedData.returns);
                            if (importedData.pendingSales) await db.pendingSales.bulkAdd(importedData.pendingSales);
                            if (importedData.deliveryPrices) await db.deliveryPrices.bulkPut(importedData.deliveryPrices); 
                            else { await db.deliveryPrices.bulkPut(getDefaultWilayaPrices());}
                            if (importedData.suppliers) await db.suppliers.bulkAdd(importedData.suppliers); 
                            if (importedData.monthlyReports) await db.monthlyReports.bulkAdd(importedData.monthlyReports);

                            if (importedData.theme) { setTheme(importedData.theme); }
                            
                            closeModal('message-modal');
                            showToast('تم استيراد البيانات المحلية بنجاح. سيتم تحديث الواجهات.');
                            navigateToView('home-view-content', document.querySelector('.nav-item[data-target="home"]'));
                        } catch (dbError) {
                            console.error("Error during Dexie import:", dbError);
                            showToast('فشل استيراد البيانات إلى قاعدة البيانات المحلية.', 'error');
                            closeModal('message-modal');
                        }
                    };

                } catch (e) {
                    showToast('خطأ في قراءة أو تحليل ملف البيانات. تأكد من أن الملف صحيح.', 'error');
                    console.error("Import error:", e);
                } finally {
                    fileInput.value = ''; 
                }
            };
            reader.readAsText(file);
        }
// --- الكود بعد التعديل (النسخة الصحيحة) ---

async function confirmResetApp() { 
    showModal('message-modal', `تحذير! هل أنت متأكد أنك تريد إعادة ضبط التطبيق بالكامل؟ ...`);
    const messageModalButtons = document.getElementById('message-modal-buttons');
    messageModalButtons.innerHTML = `
        <button onclick="closeModal('message-modal')" class="app-button app-button-secondary">إلغاء</button>
        <button id="confirm-reset-action" class="app-button app-button-danger">نعم، قم بإعادة الضبط</button>
    `;
    document.getElementById('confirm-reset-action').onclick = async () => {
        try {
            await db.open();
            await Promise.all([
                db.shoes.clear(), db.sales.clear(), db.returns.clear(),
                db.pendingSales.clear(), db.deliveryPrices.clear(),
                db.suppliers.clear(), db.monthlyReports.clear()
            ]);
            localStorage.removeItem(THEME_STORAGE_KEY); 

            await storeDeliveryPrices(getDefaultWilayaPrices()); 
            setTheme('light'); 
            closeModal('message-modal'); 
            showToast('تمت إعادة ضبط التطبيق بنجاح. سيتم تحديث الواجهة.');

            // ▼▼▼ هذا هو التعديل الذي قمنا به ▼▼▼
            setTimeout(() => {
                window.location.reload();
            }, 1500); // ننتظر 1.5 ثانية قبل إعادة التحميل

        } catch (dbError) {
            console.error("Error resetting Dexie database:", dbError);
            showToast('فشل إعادة ضبط قاعدة البيانات المحلية.', 'error');
            closeModal('message-modal');
        }
    };
}
        // أضف هذه الدالة الجديدة مع بقية الدوال
        function showSaleDetailsInModal(sale) {
const saleDate = new Date(sale.date).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric', numberingSystem: 'latn' });
            const message = `
                <h4 class="text-lg font-bold mb-3 text-primary-color">تفاصيل عملية البيع</h4>
                <p class="text-right mb-2"><strong>الحذاء:</strong> ${sale.shoeName || 'غير محدد'}</p>
                <p class="text-right mb-2"><strong>المقاس:</strong> ${sale.size || 'غير محدد'}</p>
                <p class="text-right mb-2"><strong>الكمية:</strong> ${sale.quantity || 'غير محدد'}</p>
                <p class="text-right mb-2"><strong>السعر الإجمالي:</strong> ${sale.total ? sale.total.toFixed(2) + ' دج' : 'غير محدد'}</p>
                <hr class="my-3">
                <p class="text-right mb-2"><strong>الزبون:</strong> ${sale.customerName || 'غير مسجل'}</p>
                <p class="text-right mb-2"><strong>الهاتف:</strong> ${sale.customerPhone || 'لا يوجد'}</p>
                <p class="text-right mb-2"><strong>تاريخ البيع:</strong> ${saleDate}</p>
            `;
            
            const messageModalText = document.getElementById('message-modal-text');
            messageModalText.innerHTML = message;
            messageModalText.className = 'text-right'; // لضمان محاذاة النص
            showModal('message-modal');
        }

       // (استبدال) --- Event Listeners and Initialization ---
window.addEventListener('load', async () => { 
    // سيقوم onAuthStateChanged بالباقي
    console.log("Page loaded. Auth state listener is now active.");

    // ربط الأحداث التي لا تعتمد على حالة الدخول
    const currentDateEl = document.getElementById('current-date');

    document.getElementById('add-size-button').addEventListener('click', () => addSizeQuantityPair('', ''));
    document.getElementById('generate-description-button').addEventListener('click', generateShoeDescription);
    // ... (بقية الأحداث تبقى كما هي)
    // تأكد من أن كل الأحداث الأخرى (event listeners) موجودة هنا

    const today = new Date();
const options = { year: 'numeric', month: 'long', day: 'numeric', numberingSystem: 'latn' };    currentDateEl.textContent = `تاريخ اليوم: ${today.toLocaleDateString('ar-EG', options)}`; 

    // الكود الخاص بإغلاق النوافذ عند النقر خارجها
    document.querySelectorAll('.modal-overlay').forEach(modalOverlay => {
        modalOverlay.addEventListener('click', (event) => {
            if (event.target === modalOverlay) { closeModal(modalOverlay.id); }
        });
    });

    // الكود الخاص بأزرار التنقل السفلية
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.addEventListener('click', () => {
            if (item.classList.contains('active')) { return; } 
            const target = item.dataset.target;
            let viewIdToNavigate = '';
            switch(target) {
                case 'home': viewIdToNavigate = 'home-view-content'; break;
                case 'about': viewIdToNavigate = 'about-app-view-content'; break;
                case 'stats': viewIdToNavigate = 'stats-view-content'; break;
                case 'settings': viewIdToNavigate = 'settings-view-content'; break;
                default: viewIdToNavigate = 'home-view-content'; 
            }
            navigateToView(viewIdToNavigate, item);
        });
    });

    // ربط بقية الأحداث... (تأكد من وجود هذه الأكواد)
    document.getElementById('add-shoe-form').addEventListener('submit', saveShoeData);
    document.getElementById('edit-delivery-price-form').addEventListener('submit', handleEditDeliveryPriceForm);
    // ... وهكذا مع بقية الـ event listeners
});

            const currentDateEl = document.getElementById('current-date');
            
            document.getElementById('add-size-button').addEventListener('click', () => addSizeQuantityPair('', ''));
            document.getElementById('generate-description-button').addEventListener('click', generateShoeDescription);
            document.getElementById('add-shoe-form').addEventListener('submit', saveShoeData);
            document.getElementById('edit-delivery-price-form').addEventListener('submit', handleEditDeliveryPriceForm);
            document.getElementById('add-supplier-form').addEventListener('submit', handleAddSupplierForm); 

            const searchDeliveryInput = document.getElementById('search-delivery-wilaya-input');
            if (searchDeliveryInput) {
                searchDeliveryInput.addEventListener('input', (e) => {
                    displayDeliveryPrices(e.target.value.trim());
                });
            }
            
            const aiChatOptionButton = document.getElementById('ai-chat-option-button');
            if(aiChatOptionButton) {
                aiChatOptionButton.addEventListener('click', () => {
                    document.getElementById('ai-options-container').classList.add('hidden');
                    document.getElementById('ai-chat-interface').classList.remove('hidden');
                    document.getElementById('ai-analysis-interface').classList.add('hidden');
                    aiChatHistory = [];
                    const chatArea = document.getElementById('ai-chat-area'); 
                    chatArea.innerHTML = '<div class="chat-message bot"><span class="sender">المساعد الذكي Pro</span>مرحباً! أنا مساعدك الذكي. كيف يمكنني خدمتك اليوم؟</div>';
                    document.getElementById('ai-chat-input').value = '';
                });
            }

            const aiAnalysisOptionButton = document.getElementById('ai-analysis-option-button');
            if(aiAnalysisOptionButton) {
                aiAnalysisOptionButton.addEventListener('click', () => {
                    document.getElementById('ai-options-container').classList.add('hidden');
                    document.getElementById('ai-chat-interface').classList.add('hidden');
                    document.getElementById('ai-analysis-interface').classList.remove('hidden');
                    getAISalesAdvice(); 
                });
            }

            document.getElementById('add-return-form').addEventListener('submit', handleAddReturn);
            document.getElementById('search-return-button').addEventListener('click', handleSearchReturn);
            document.getElementById('review-returns-list-button').addEventListener('click', displayReturnList);
            document.getElementById('open-global-search-button').addEventListener('click', openGlobalSearchModal);
            document.getElementById('execute-global-search-button').addEventListener('click', executeGlobalSearch);
            document.getElementById('global-search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    executeGlobalSearch();
                }
            });
            
            const refreshStockAlertsButtonStats = document.getElementById('refresh-stock-alerts-button-stats');
            if (refreshStockAlertsButtonStats) {
                 refreshStockAlertsButtonStats.addEventListener('click', () => displayStockAlerts('stock-alerts-list-area-stats', 'stock-alert-threshold-stats'));
            }
            
            const exportButton = document.getElementById('export-data-button');
            if(exportButton) exportButton.addEventListener('click', exportData);
            
            const importButton = document.getElementById('import-data-button');
            if(importButton) importButton.addEventListener('click', importData);

            const resetButton = document.getElementById('reset-app-button');
            if(resetButton) resetButton.addEventListener('click', confirmResetApp);

            const sendAIChatMessageButton = document.getElementById('send-ai-chat-message-button'); 
            if(sendAIChatMessageButton) sendAIChatMessageButton.addEventListener('click', sendAIChatMessage); 
            
            const aiChatInput = document.getElementById('ai-chat-input'); 
            if(aiChatInput) {
                aiChatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); 
                        sendAIChatMessage(); 
                    }
                });
            }
            
            const shoeImageInput = document.getElementById('shoe-image');
            const imagePreviewElement = document.getElementById('image-preview-element');
            shoeImageInput.addEventListener('change', function(event) {
                if (event.target.files && event.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreviewElement.src = e.target.result;
                        imagePreviewElement.style.display = 'block';
                    }
                    reader.readAsDataURL(event.target.files[0]);
                } else {
                    imagePreviewElement.style.display = 'none';
                    imagePreviewElement.src = '#';
                }
            });

            const supplierImageInput = document.getElementById('supplier-image');
            const supplierImagePreviewElement = document.getElementById('supplier-image-preview');
            if(supplierImageInput && supplierImagePreviewElement) {
                supplierImageInput.addEventListener('change', function(event) {
                    if (event.target.files && event.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            supplierImagePreviewElement.src = e.target.result;
                            supplierImagePreviewElement.style.display = 'block';
                        }
                        reader.readAsDataURL(event.target.files[0]);
                    } else {
                        supplierImagePreviewElement.style.display = 'none';
                        supplierImagePreviewElement.src = '#'; 
                    }
                });
            }

            document.querySelectorAll('#shoe-filter-buttons .filter-button').forEach(button => {
                button.addEventListener('click', function() {
                    const category = this.dataset.category;
                    displayAllShoes(category);
                });
            });

            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' }; 
            currentDateEl.textContent = `تاريخ اليوم: ${today.toLocaleDateString('ar-EG', options)}`; 

            document.querySelectorAll('.modal-overlay').forEach(modalOverlay => {
                if (modalOverlay.id !== 'secret-code-modal-overlay') { // Secret code modal should not close on overlay click
                    modalOverlay.addEventListener('click', (event) => {
                        if (event.target === modalOverlay) { closeModal(modalOverlay.id); }
                    });
                }
            });
            
            // Splash screen logic
            setTimeout(() => {
                splashScreen.classList.add('hidden');
            }, 1200); 

            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (item.classList.contains('active')) { return; } 
                    const target = item.dataset.target;
                    let viewIdToNavigate = '';
                    switch(target) {
                        case 'home': viewIdToNavigate = 'home-view-content'; break; 
                        case 'inventory': viewIdToNavigate = 'inventory-view-content'; break;
                        case 'stats': viewIdToNavigate = 'stats-view-content'; break;
                        case 'settings': viewIdToNavigate = 'settings-view-content'; break; 
                        case 'about': viewIdToNavigate = 'about-app-view-content'; break; 
                        default: viewIdToNavigate = 'home-view-content'; 
                    }
                    navigateToView(viewIdToNavigate, item);
                });
            });
        
// (إضافة جديدة) دالة لفتح نافذة معلومات المستخدم
function openUserInfoModal() {
    if (!currentFirebaseUser) return; // تحقق من وجود مستخدم

    const welcomeTitle = document.getElementById('user-info-welcome-title');
    const detailsArea = document.getElementById('user-info-details');

    const user = currentFirebaseUser;

    // تعبئة البيانات
    welcomeTitle.textContent = `مرحباً بك، ${user.displayName || 'أيها المستخدم'}`;
    detailsArea.innerHTML = `
        <p class="mb-2"><strong>الاسم الكامل:</strong> ${user.displayName || 'غير متوفر'}</p>
        <p class="mb-2"><strong>البريد الإلكتروني:</strong> ${user.email || 'غير متوفر'}</p>
        <p class="text-xs text-text-color-secondary"><strong>معرف المستخدم:</strong> ${user.uid}</p>
    `;

    // ربط زر تسجيل الخروج داخل النافذة
    document.getElementById('logout-button-modal').onclick = handleLogout;

    showModal('user-info-modal');
}
// --- تأكد من بقاء هذا الكود الصحيح ---

// 1. دالة لفتح نافذة إدخال التاريخ
function promptForDateFilter() {
    const messageModal = document.getElementById('message-modal');
    const messageText = document.getElementById('message-modal-text');
    const messageButtons = document.getElementById('message-modal-buttons');

    messageText.innerHTML = `
        <h4 class="modal-title mb-4">اختر تاريخ الفرز</h4>
        <label for="modal-date-input" class="form-label">سيتم عرض المبيعات المشحونة فقط لهذا التاريخ:</label>
        <input type="date" id="modal-date-input" class="form-input w-full">
    `;

    messageButtons.innerHTML = `
        <button id="confirm-date-filter" class="app-button app-button-primary">فرز</button>
        <button onclick="closeModal('message-modal')" class="app-button app-button-secondary">إلغاء</button>
    `;

    document.getElementById('confirm-date-filter').addEventListener('click', () => {
        const selectedDate = document.getElementById('modal-date-input').value;
        if (selectedDate) {
            document.querySelectorAll('#pending-sale-filter-buttons .filter-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('date-filter-btn').classList.add('active');

            displayPendingSales({ dateFilter: selectedDate });
            closeModal('message-modal');
        } else {
            showToast('الرجاء اختيار تاريخ.', 'error');
        }
    });

    showModal('message-modal');
}


// 2. ربط الأحداث لجميع الأزرار الأربعة
document.querySelectorAll('#pending-sale-filter-buttons .filter-button').forEach(button => {
    button.addEventListener('click', function() {

        if (this.id === 'date-filter-btn') {
            promptForDateFilter();
        } 
        else {
            document.querySelectorAll('#pending-sale-filter-buttons .filter-button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            currentPendingSaleFilter = this.dataset.filter;
            displayPendingSales(); // استدعاء بدون تاريخ للعودة للوضع العادي
        }
    });
});
// ▼▼▼ أضف هذه الدالة الجديدة بالكامل ▼▼▼
// ▼▼▼ قم باستبدال الدالة القديمة بهذه الدالة الجديدة بالكامل ▼▼▼
// ▼▼▼ الصق هذا الكود النظيف والصحيح بالكامل ▼▼▼
async function setupRealtimeSyncListener() {
    if (firestoreListenerUnsubscribe) {
        firestoreListenerUnsubscribe(); // أوقف المستمع القديم أولاً
        firestoreListenerUnsubscribe = null;
    }

    if (!currentUserId) return; // لا تقم بإعداد مستمع جديد إذا لم يكن هناك مستخدم

    const dataDocRef = doc(dbFirebase, ...getFirestoreDataPath());
    const syncAlert = document.getElementById('firebase-sync-alert');
    const settingsDot = document.getElementById('settings-notification-dot');

    firestoreListenerUnsubscribe = onSnapshot(dataDocRef, (docSnap) => {
        console.log("Realtime sync listener fired.");
        if (!docSnap.exists() || !docSnap.data().lastSync) {
            return; // لا تفعل شيئاً إذا لم يكن هناك بيانات أو تاريخ مزامنة
        }

        const firebaseData = docSnap.data();
        const firebaseSyncTime = firebaseData.lastSync.toDate().getTime();

        // هل هذا التحديث قادم من جهازي أنا؟
        if (firebaseData.lastSyncDeviceId === myDeviceId) {
            localStorage.setItem('lastLocalSyncTimestamp', firebaseSyncTime.toString());
            console.log("Self-update detected. Local timestamp updated. No alert needed.");
            return; 
        }

        // إذا وصلنا إلى هنا، فالتحديث قادم من جهاز آخر.
        const localSyncTime = localStorage.getItem('lastLocalSyncTimestamp');

        if (!localSyncTime || firebaseSyncTime > parseInt(localSyncTime)) {
            syncAlert.classList.remove('hidden');
            if (settingsDot) settingsDot.classList.remove('hidden');
            console.log("New data from another device detected. Showing alert.");
        } else {
            syncAlert.classList.add('hidden');
            if (settingsDot) settingsDot.classList.add('hidden');
        }
    });

    console.log("Realtime sync listener setup for user:", currentUserId);
}
// ▲▲▲ نهاية الكود الصحيح للدالة ▲▲▲
// داخل onAuthStateChanged
onAuthStateChanged(auth, async (user) => {
    // ... الكود الحالي ...

    if (user) {
        console.log("User is signed in:", user);
        currentUserId = user.uid;
        // ... الكود الحالي لتحديث الواجهة ...
        
        // ▼▼▼ أضف هذه الاستدعاءات ▼▼▼
        await setupRealtimeSyncListener(); // إعداد المستمع للمستخدم الجديد
        loadLastSyncDateFromFirebase();

    } else {
        console.log("User is signed out.");
        // ▼▼▼ أضف هذا الجزء لإلغاء المستمع ▼▼▼
        if (firestoreListenerUnsubscribe) {
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
            console.log("Firestore listener unsubscribed.");
        }
        
        currentUserId = null;
        // ... بقية الكود الحالي لتسجيل الخروج ...
    }
    // ...
});
// ▼▼▼ أضف هذا الكود في أعلى الملف ▼▼▼
function generateUniqueId() {
    return 'device-' + Math.random().toString(36).substring(2, 11);
}
function getMyDeviceId() {
    let deviceId = localStorage.getItem('shoesManager_deviceId');
    if (!deviceId) {
        deviceId = generateUniqueId();
        localStorage.setItem('shoesManager_deviceId', deviceId);
    }
    return deviceId;
}
const myDeviceId = getMyDeviceId();
// ▲▲▲ انتهت إضافة كود الهوية ▲▲▲
    </script>
</body>
</html>
